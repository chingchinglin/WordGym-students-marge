<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WordGym 單字健身坊 — 學生版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* 控制 details 展開/收合符號 */
      details summary span::before {
        content: "＋";
      }
      details[open] summary span::before {
        content: "−";
      }
      
      /* 閃卡翻轉動畫 */
      .flashcard {
        perspective: 1000px;
      }
      .flashcard-inner {
        position: relative;
        width: 100%;
        transition: transform 0.6s;
        transform-style: preserve-3d;
      }
      .flashcard.flipped .flashcard-inner {
        transform: rotateY(180deg);
      }
      .flashcard-front, .flashcard-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
      }
      .flashcard-back {
        transform: rotateY(180deg);
      }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-gradient-to-b from-indigo-50 to-white min-h-screen">
    <style>
      details summary .icon-plus { display: inline-block; }
      details[open] summary .icon-plus { display: none; }
      details summary .icon-minus { display: none; }
      details[open] summary .icon-minus { display: inline-block; }
      details summary .icon-plus,
      details summary .icon-minus {
        display: flex;
        align-items: center;
        justify-content: center;
      }
    </style>
    <div id="root"></div>
    <script type="text/babel" data-presets="env,react,typescript">
      window.onerror = function(msg, src, line, col, err) {
        const div = document.createElement('div');
        div.style.background = '#b91c1c';
        div.style.color = '#fff';
        div.style.padding = '12px';
        div.style.fontFamily = 'monospace';
        div.textContent = `Error: ${msg} (line ${line}, column ${col})`;
        document.body.prepend(div);
      };

      const { useEffect, useMemo, useRef, useState } = React;

      const useHashRoute = () => {
        const [hash, setHash] = useState(() => window.location.hash || "#/");
        useEffect(() => {
          const onHash = () => {
            setHash(window.location.hash || "#/");
            // 當路由改變時，自動滾動到頁面頂部
            window.scrollTo(0, 0);
          };
          window.addEventListener("hashchange", onHash);
          return () => window.removeEventListener("hashchange", onHash);
        }, []);
        const push = (h) => { 
          if (h !== window.location.hash) {
            window.location.hash = h;
            // 當程式化改變路由時，也滾動到頂部
            window.scrollTo(0, 0);
          }
        };
        return { hash, push };
      };

      const POS_LABEL = {
        noun: "名詞", verb: "動詞", adjective: "形容詞", adverb: "副詞",
        pronoun: "代名詞", preposition: "介系詞", conjunction: "連接詞", other: "其他"
      };
      const ALL_POS = Object.keys(POS_LABEL);
      
      // 主題標籤
      const THEME_LABEL = {
        highschool_climate: "高中氣候",
        junior_high: "國中單字"
      };
      const ALL_THEMES = Object.keys(THEME_LABEL);
      
      const LS = { favorites: "mvp_vocab_favorites", dataset: "mvp_vocab_dataset_v36", presetApplied: "mvp_vocab_preset_applied_v36", homeFilters: "mvp_home_filters_v1", userExamples: "mvp_vocab_user_examples_v1", quizHistory: "mvp_vocab_quiz_history_v1", userName: "mvp_vocab_user_name_v1", userSettings: "wordgym_user_settings_v1", currentTab: "wordgym_current_tab_v1", filters: "wordgym_filters_v1", quickFilterPos: "wordgym_quick_filter_pos_v1" };
      const PRESET_VERSION = 'google_sheet_v1_new'; // 更新版本號以強制重新載入新資料
      const HIGH_SCHOOL_CLIMATE_CSV_EMBEDDED = "";

      // Google Sheet 配置
      const GOOGLE_SHEET_CONFIG = {
        enabled: true,
        showImporter: false,
        sheets: [
          {
            name: '國中單字彙整',
            sheetId: '1RRR2HkwdwxabYVx5Y1Fuec1DKdi4xoSBLSaNVEAwUAQ',
            gid: '0',
            theme: 'junior_high'
          }
        ]
      };

      const CSV_SOURCES = [];

const speak = (rawText) => {
        const text = String(rawText || '').trim();
        if (!text || !('speechSynthesis' in window)) return;
        try {
          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'en-US';
          window.speechSynthesis.speak(utterance);
        } catch {}
      };

      // 解析 TSV (Tab-Separated Values) - 比 CSV 更簡單可靠
      // 修改：跳過前面的空行，找到包含 "english_word" 或 "word" 的行作為標題行
      const parseTSV = (text) => {
        const lines = text.split(/\r?\n/);
        if (lines.length === 0) return [];
        
        // 找到標題行：包含 "english_word" 或 "word"（不區分大小寫）
        let headerRowIndex = -1;
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue; // 跳過空行
          
          const headers = line.split('\t').map(h => String(h || '').replace(/^\uFEFF/, '').trim().toLowerCase());
          // 檢查是否包含 english_word 或 word 欄位
          if (headers.includes('english_word') || headers.includes('word') || headers.includes('英文') || headers.includes('英文單字')) {
            headerRowIndex = i;
            break;
          }
        }
        
        // 如果找不到標題行，使用第一行作為標題（向後相容）
        if (headerRowIndex === -1) {
          headerRowIndex = 0;
          console.warn('警告：找不到包含 english_word 或 word 的標題行，使用第一行作為標題');
        }
        
        const headers = lines[headerRowIndex].split('\t').map(h => String(h || '').replace(/^\uFEFF/, '').trim());
        const rows = [];
        
        // 從標題行的下一行開始解析資料
        for (let i = headerRowIndex + 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue; // 跳過空行
          
          const values = line.split('\t');
          const obj = {};
          for (let j = 0; j < headers.length; j++) {
            const key = headers[j];
            if (key) {
              obj[key] = (values[j] || '').trim();
            }
          }
          rows.push(obj);
        }
        
        console.log(`TSV 解析：找到標題行在第 ${headerRowIndex + 1} 行，解析了 ${rows.length} 筆資料`);
        return rows;
      };

      const loadFromGoogleSheet = async (sheetConfig) => {
        try {
          // 改用 TSV 格式，避免 CSV 的引號和逗號解析問題
          const tsvUrl = `https://docs.google.com/spreadsheets/d/${sheetConfig.sheetId}/export?format=tsv&gid=${sheetConfig.gid}`;
          console.log(`載入 Google Sheet (TSV): ${sheetConfig.name}`, tsvUrl);
          const response = await fetch(tsvUrl);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const tsvText = await response.text();
          console.log(`TSV 原始資料長度: ${tsvText.length} 字符`);
          const rows = parseTSV(tsvText);
          console.log(`解析後得到 ${rows.length} 筆資料`);
          return { rows, theme: sheetConfig.theme };
        } catch (error) {
          console.error(`載入失敗: ${sheetConfig.name}`, error);
          throw error;
        }
      };

      const loadAllGoogleSheets = async () => {
        if (!GOOGLE_SHEET_CONFIG.enabled) return [];
        const results = [];
        for (const sheetConfig of GOOGLE_SHEET_CONFIG.sheets) {
          try {
            const result = await loadFromGoogleSheet(sheetConfig);
            results.push(result);
          } catch (error) {
            console.warn(`跳過: ${sheetConfig.name}`);
          }
        }
        return results;
      };

      const Button = ({ children, onClick, variant = "primary", type = "button", className = "", disabled = false }) => {
        const base = "px-4 py-2 rounded-full font-medium transition focus:outline-none focus:ring-2 focus:ring-offset-2";
        const variants = {
          primary: "bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500",
          ghost: "bg-white/80 text-gray-700 border border-gray-200 hover:bg-white focus:ring-gray-300",
          danger: "bg-rose-600 text-white hover:bg-rose-700 focus:ring-rose-500",
          success: "bg-green-600 text-white hover:bg-green-700 focus:ring-green-500"
        };
        const variantClass = variants[variant] || variants.primary;
        const disabledClass = disabled ? "opacity-60 cursor-not-allowed hover:bg-inherit" : "";
        return (
          <button
            type={type}
            onClick={disabled ? undefined : onClick}
            disabled={disabled}
            className={`${base} ${variantClass} ${disabledClass} ${className}`}
          >
            {children}
          </button>
        );
      };

      const SpeakerButton = ({ onClick, label, className = "" }) => (
        <button
          type="button"
          onClick={onClick}
          aria-label={label}
          title={label}
          className={`inline-flex h-8 w-8 items-center justify-center rounded-full border border-indigo-200 bg-white text-indigo-600 shadow-sm transition hover:bg-indigo-50 hover:text-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 ${className}`}
        >
          <svg viewBox="0 0 24 24" fill="currentColor" className="h-4 w-4">
            <path d="M4 9.25v5.5c0 .69.56 1.25 1.25 1.25H7l3.29 2.63c.83.66 2.04.07 2.04-1V6.62c0-1.07-1.21-1.66-2.04-1L7 8.25H5.25C4.56 8.25 4 8.81 4 9.25Zm11.21-2.46a.75.75 0 0 0-.97 1.14 4.5 4.5 0 0 1 0 7.14.75.75 0 0 0 .97 1.14 6 6 0 0 0 0-9.42Zm2.79-1.95a.75.75 0 0 0-.97 1.13 7.5 7.5 0 0 1 0 11.56.75.75 0 0 0 .97 1.13 9 9 0 0 0 0-13.82Z" />
          </svg>
        </button>
      );

            window.__INITIAL_DATASET__ = [];

      const exampleFor = (word, pos) => {
        const w = String(word || '').trim();
        if (!w) return '';
        const lower = w.toLowerCase();
        const article = /^[aeiou]/i.test(w) ? 'an' : 'a';
        if (pos === 'adjective' && lower === 'alike') return 'They look alike.';
        if (pos === 'verb') return `They ${lower} every day.`;
        if (pos === 'adjective') return `It is ${lower}.`;
        if (pos === 'adverb') return `He speaks ${lower}.`;
        if (pos === 'preposition') return `We talked ${lower} the plan.`;
        if (pos === 'conjunction') return `I left ${lower} the rain started.`;
        if (pos === 'pronoun') return `${w} is here.`;
        return `This is ${article} ${lower}.`;
      };

      const translationFor = (word, pos) => {
        const w = String(word || '').trim();
        if (!w) return '';
        const lower = w.toLowerCase();
        const DICT_ZH = {
          activity: "活動", action: "行動", actor: "男演員", actress: "女演員", add: "加",
          about: "關於", above: "在上方", across: "穿越", against: "反對", along: "沿著", among: "在…之中", around: "在周圍", as: "作為/因為", after: "之後",
          afraid: "害怕的", angry: "生氣的", able: "能夠的", active: "活躍的", alive: "活著的", alike: "相似",
          animal: "動物", airport: "機場", apple: "蘋果", agree: "同意", arrive: "到達", ask: "詢問",
          available: "可用的", away: "離開的", we: "我們", you: "你/你們", they: "他們"
        };
        const PREP_ZH = {
          about: "關於", above: "在…上方", across: "穿越/橫越", against: "反對/靠著",
          along: "沿著", among: "在…之中", around: "在…周圍/大約", as: "作為/因為", after: "在…之後"
        };
        if (pos === 'verb') {
          const zh = DICT_ZH[lower] || w;
          return `他們每天${zh}。`;
        }
        if (pos === 'adjective') {
          if (lower === 'alike') return '他們看起來很相似。';
          const zh = DICT_ZH[lower] || `${w}的`;
          return `它很${zh.replace(/的$/, '的')}。`;
        }
        if (pos === 'adverb') {
          const zh = DICT_ZH[lower] || w;
          return `他說話${zh}地。`;
        }
        if (pos === 'pronoun') {
          const zh = DICT_ZH[lower] || w;
          return `${zh}在這裡。`;
        }
        if (pos === 'preposition') {
          const zh = PREP_ZH[lower] || DICT_ZH[lower] || w;
          return `我們談論${zh}這個計畫。`;
        }
        if (pos === 'conjunction') {
          return `我在${DICT_ZH[lower] || w}雨開始時離開。`;
        }
        const zh = DICT_ZH[lower] || w;
        const isZh = /[\u4e00-\u9fff]/.test(zh);
        return `這是${isZh ? '' : '一個'}${zh}。`;
      };
      
      const posLabelFromArray = (tags = []) => {
        return (Array.isArray(tags) ? tags : [])
          .map((tag) => POS_LABEL[tag] || tag)
          .filter(Boolean)
          .join('、');
      };

      const wordToMarkdown = (word, selPos, extras = {}) => {
        if (!word) return '';
        const sections = extras.sections || { pos: true, relations: true, affix: true };
        const lines = [];
        const heading = (extras.title ?? word.english_word ?? '').trim();
        if (heading) {
          lines.push(`## ${heading}`);
        }

        const basicLines = [];
        const kk = (extras.kk_phonetic ?? word.kk_phonetic ?? '').trim();
        if (kk) basicLines.push(`- KK音標：${kk}`);
        const posText = posLabelFromArray(word.posTags || []);
        if (posText) basicLines.push(`- 詞性：${posText}`);
        const levelText = String(extras.level ?? word.level ?? '').trim();
        if (levelText) basicLines.push(`- Level：${levelText}`);
        const themeLabels = getThemeDisplayLabels(word);
        if (themeLabels.length) basicLines.push(`- 主題：${themeLabels.join('、')}`);
        if (basicLines.length) {
          if (lines.length) lines.push('');
          lines.push('### 基本資訊', ...basicLines);
        }

        const exampleLines = [];
        const exampleSentence = (extras.example_sentence ?? word.example_sentence ?? '').trim();
        const exampleTranslation = (extras.example_translation ?? word.example_translation ?? '').trim();
        const exampleSentence2 = (extras.example_sentence_2 ?? word.example_sentence_2 ?? '').trim();
        const exampleTranslation2 = (extras.example_translation_2 ?? word.example_translation_2 ?? '').trim();
        if (exampleSentence) exampleLines.push(`- 例句1：${exampleSentence}`);
        if (exampleTranslation) exampleLines.push(`  → ${exampleTranslation}`);
        if (exampleSentence2) exampleLines.push(`- 例句2：${exampleSentence2}`);
        if (exampleTranslation2) exampleLines.push(`  → ${exampleTranslation2}`);
        if (exampleLines.length) {
          lines.push('', '### 例句', ...exampleLines);
        }

        if (sections.pos) {
          const grammarLines = [];
          const primaryPos = selPos || word.grammar_main_category || (word.posTags || [])[0];
          if (primaryPos) grammarLines.push(`- 主要詞性：${POS_LABEL[primaryPos] || primaryPos}`);
          const subCat = (extras.grammar_sub_category ?? word.grammar_sub_category ?? '').trim();
          if (subCat) grammarLines.push(`- 子分類：${subCat}`);
          const gFunc = (extras.grammar_function ?? word.grammar_function ?? '').trim();
          if (gFunc) grammarLines.push(`- 語法功能：${gFunc}`);
          const gPattern = (extras.applicable_sentence_pattern ?? word.applicable_sentence_pattern ?? '').trim();
          if (gPattern) grammarLines.push(`- 常見句型：${gPattern}`);
          const formsSource = extras.word_forms ?? word.word_forms ?? [];
          const formsList = Array.isArray(formsSource) ? formsSource : multiSplit(formsSource || '');
          const cleanedForms = formsList.filter(Boolean);
          if (cleanedForms.length) grammarLines.push(`- 詞性變化：${cleanedForms.join('、')}`);
          if (grammarLines.length) {
            lines.push('', '### 詞性', ...grammarLines);
          }
        }

        if (sections.relations) {
          const relationLines = [];
          const synonyms = extras.synonyms ?? word.synonyms ?? [];
          const synList = Array.isArray(synonyms) ? synonyms : multiSplit(synonyms || '');
          if (synList.length) relationLines.push(`- 同義字：${synList.join('、')}`);
          const antonyms = extras.antonyms ?? word.antonyms ?? [];
          const antList = Array.isArray(antonyms) ? antonyms : multiSplit(antonyms || '');
          if (antList.length) relationLines.push(`- 反義字：${antList.join('、')}`);
          const confusables = extras.confusables ?? word.confusables ?? [];
          const confList = Array.isArray(confusables) ? confusables : multiSplit(confusables || '');
          if (confList.length) relationLines.push(`- 易混淆字：${confList.join('、')}`);
          if (relationLines.length) {
            lines.push('', '### 同義／反義／易混淆', ...relationLines);
          }
        }

        if (sections.affix) {
          const affix = extras.affix_info ?? word.affix_info ?? {};
          const affixLines = [];
          const prefix = String(affix.prefix || '').trim();
          const root = String(affix.root || '').trim();
          const suffix = String(affix.suffix || '').trim();
          const meaning = String(affix.meaning || '').trim();
          const example = String(affix.example || '').trim();
          if (prefix) affixLines.push(`- 字首：${prefix}`);
          if (root) affixLines.push(`- 字根：${root}`);
          if (suffix) affixLines.push(`- 字尾：${suffix}`);
          if (meaning) affixLines.push(`- 字源意涵：${meaning}`);
          if (example) affixLines.push(`- 延伸例子：${example}`);
          if (affixLines.length) {
            lines.push('', '### 字根字首字尾', ...affixLines);
          }
        }

        return lines.join('\n');
      };

      const makeBaseDataset = () => [];

      const normalizePOS = (raw) => {
        const s = String(raw || "").toLowerCase().trim();
        // 先處理常見縮寫或帶符號的詞性
        if (/^n[.\s/]*$|^noun\b|名詞/.test(s)) return "noun";
        if (/^v[.\s/]*$|^vt\b|^vi\b|^verb\b|動詞/.test(s)) return "verb";
        if (/^adj[.\s/]*$|^adjective\b|形容/.test(s)) return "adjective";
        if (/^adv[.\s/]*$|^adverb\b|副詞/.test(s)) return "adverb";
        if (/^pron[.\s/]*$|^pronoun\b|代名/.test(s)) return "pronoun";
        if (/^prep[.\s/]*$|^preposition\b|介系/.test(s)) return "preposition";
        if (/^conj[.\s/]*$|^conjunction\b|連接/.test(s)) return "conjunction";
        return "other";
      };

      const multiSplit = (text) => {
        const out = []; let token = ""; const str = String(text);
        const isDelim = (ch) => /[,;，、\/\n\r]/.test(ch); // 加入 "/" 分隔多詞性
        for (let i=0; i<str.length; i++) {
          const ch = str[i];
          if (isDelim(ch)) { if (token) out.push(token); token = ""; } else { token += ch; }
        }
        if (token) out.push(token);
        return out.map(s=>s.trim()).filter(Boolean);
      };

      const emptyWordFormsDetail = () => ({ base: [], idiom: [], compound: [], derivation: [] });

      const dedupeList = (arr=[]) => Array.from(new Set(arr.map(s=>s.trim()).filter(Boolean)));

      const mergeThemes = (...values) => {
        const result = new Set();
        const ingest = (val, allowSplit = true) => {
          if (val === undefined || val === null) return;
          if (Array.isArray(val)) { val.forEach((item) => ingest(item, true)); return; }
          const str = String(val).trim();
          if (!str) return;
          if (allowSplit) {
            const tokens = multiSplit(str);
            if (tokens.length > 1) {
              tokens.forEach((token) => ingest(token, false));
              return;
            }
          }
          result.add(str);
        };
        values.forEach((val) => ingest(val, true));
        return Array.from(result);
      };

      const getWordThemes = (word) => mergeThemes(word?.themes, word?.theme);
      const wordHasTheme = (word, themeKey) => {
        if (!themeKey) return false;
        return getWordThemes(word).includes(themeKey);
      };

      // 核心篩選邏輯函數
      const getFilteredWords = (data, userSettings, currentTab, filters, quickFilterPos) => {
        if (!data || !Array.isArray(data)) return [];
        
        let filtered = [...data];
        
        // 1. Stage Filter: 先過濾出符合 userSettings.stage 的單字
        if (userSettings && userSettings.stage) {
          // 調試：顯示過濾前的統計
          const stageStats = {};
          const stageSamples = {}; // 記錄每種 stage 的樣本
          filtered.forEach(word => {
            const stage = word.stage || 'null';
            stageStats[stage] = (stageStats[stage] || 0) + 1;
            // 記錄前 3 個樣本
            if (!stageSamples[stage] || stageSamples[stage].length < 3) {
              if (!stageSamples[stage]) stageSamples[stage] = [];
              stageSamples[stage].push({
                english: word.english_word,
                stage: word.stage,
                hasThemeIndex: Array.isArray(word.theme_index) && word.theme_index.length > 0
              });
            }
          });
          console.log('=== Stage 過濾前統計 ===');
          console.log('用戶選擇的 stage:', userSettings.stage);
          console.log('資料中的 stage 分布:', stageStats);
          console.log('各 stage 的樣本資料:', stageSamples);
          
          // 檢查是否有資料但 stage 不匹配
          if (filtered.length > 0 && stageStats[userSettings.stage] === 0) {
            console.warn('⚠️ 警告：有資料但沒有符合選擇的 stage！');
            console.warn('可能的原因：');
            console.warn('1. Google Sheets 中的 stage 欄位值不是「國中」或「高中」');
            console.warn('2. stage 欄位名稱不匹配');
            console.warn('3. 資料載入時 stage 解析失敗');
          }
          
          filtered = filtered.filter(word => {
            return word.stage === userSettings.stage;
          });
          
          console.log(`過濾後剩餘 ${filtered.length} 筆資料`);
        }
        
        // 2. Mode Filter (三擇一)
        if (currentTab === 'textbook') {
          // Textbook Mode: 篩選 textbook_index 中包含 userSettings.version 且符合 vol 和 lesson
          const filterData = filters.textbook || {};
          const { vol, lesson } = filterData;
          const version = userSettings?.version;
          
          // 調試：顯示篩選前的統計
          if (currentTab === 'textbook' && (vol || lesson)) {
            console.log('=== 課本進度篩選調試 ===');
            console.log('用戶選擇的 stage:', userSettings?.stage);
            console.log('篩選條件:', { version, vol, lesson });
            // 檢查前 5 筆資料的 textbook_index
            const sampleTextbookIndex = filtered.slice(0, 5).map(w => ({
              english: w.english_word,
              textbook_index: w.textbook_index,
              stage: w.stage
            }));
            console.log('前 5 筆資料的 textbook_index:', sampleTextbookIndex);
          }
          
          // 國中和高中都使用相同的 textbook_index 格式：版本-冊次-課次
          // 例如：康軒-B1-U1（國中）或 龍騰-B1-U1（高中）
          if (version || vol || lesson) {
            filtered = filtered.filter(word => {
              const textbookIndex = Array.isArray(word.textbook_index) ? word.textbook_index : [];
              if (textbookIndex.length === 0) return false;
              
              return textbookIndex.some(item => {
                if (!item) return false;
                let match = true;
                // 如果設定了 version，必須匹配（例如：康軒、龍騰）
                if (version && item.version !== version) match = false;
                // 如果設定了 vol，必須匹配（例如：B1, B2）
                if (vol && item.vol !== vol) match = false;
                // 如果設定了 lesson，必須匹配（例如：U1, U2, L1, L2）
                if (lesson && item.lesson !== lesson) match = false;
                return match;
              });
            });
          } else {
            // 如果沒有任何篩選條件，顯示所有有 textbook_index 的單字
            filtered = filtered.filter(word => {
              const textbookIndex = Array.isArray(word.textbook_index) ? word.textbook_index : [];
              return textbookIndex.length > 0;
            });
          }
        } else if (currentTab === 'exam') {
          // Exam Mode: 篩選 exam_tags 中包含選定的 year
          const filterData = filters.exam || {};
          const { year } = filterData;
          
          if (year) {
            filtered = filtered.filter(word => {
              const examTags = Array.isArray(word.exam_tags) ? word.exam_tags : [];
              return examTags.includes(year);
            });
          } else {
            // 如果沒有選擇年份，根據 stage 顯示對應的單字
            if (userSettings?.stage === 'junior') {
              // 國中：顯示所有有會考標籤的單字
              filtered = filtered.filter(word => {
                const examTags = Array.isArray(word.exam_tags) ? word.exam_tags : [];
                return examTags.some(tag => tag && tag.includes('會考'));
              });
            } else {
              // 高中：顯示所有有學測標籤的單字
              filtered = filtered.filter(word => {
                const examTags = Array.isArray(word.exam_tags) ? word.exam_tags : [];
                return examTags.some(tag => tag && tag.includes('學測'));
              });
            }
          }
        } else if (currentTab === 'theme') {
          // Theme Mode: 根據 stage 使用不同的篩選邏輯
          const filterData = filters.theme || {};
          const { range, theme } = filterData;
          
          if (userSettings?.stage === 'junior') {
            // 國中：篩選 1200/800 與 theme，使用 theme_index 陣列
            filtered = filtered.filter(word => {
              const themeIndex = Array.isArray(word.theme_index) ? word.theme_index : [];
              if (themeIndex.length === 0) return false;
              
              // 使用 some() 方法檢查是否有任何項目符合條件（類似 textbook_index 的邏輯）
              return themeIndex.some(item => {
                if (!item) return false;
                let match = true;
                
                // 如果設定了 range，必須匹配（例如：1200 或 800）
                if (range && item.range !== range) match = false;
                
                // 如果設定了 theme，必須匹配（例如：family）
                if (theme && theme.trim() && item.theme !== theme.trim()) match = false;
                
                return match;
              });
            });
            
            // 如果都沒有選擇，顯示所有有 theme_index 的單字
            if (!range && (!theme || !theme.trim())) {
              filtered = filtered.filter(word => {
                const themeIndex = Array.isArray(word.theme_index) ? word.theme_index : [];
                return themeIndex.length > 0;
              });
            }
          } else {
            // 高中：篩選 Level 與 theme
            if (range) {
              filtered = filtered.filter(word => {
                return String(word.level || '').trim() === String(range).trim();
              });
            }
            
            // 主題篩選：優先使用 theme_index，向後相容 theme/themes 欄位
            if (theme && theme.trim()) {
              filtered = filtered.filter(word => {
                const themeIndex = Array.isArray(word.theme_index) ? word.theme_index : [];
                if (themeIndex.length > 0) {
                  // 使用 theme_index
                  return themeIndex.some(item => item && item.theme === theme.trim());
                } else {
                  // 向後相容：使用 theme/themes 欄位
                  return wordHasTheme(word, theme) || getWordThemes(word).includes(theme);
                }
              });
            }
          }
        }
        
        // 3. POS Filter: 若 quickFilterPos 不是 'all'，再過濾 posTags
        if (quickFilterPos && quickFilterPos !== 'all') {
          filtered = filtered.filter(word => {
            const posTags = word.posTags || [];
            return Array.isArray(posTags) && posTags.includes(quickFilterPos);
          });
        }
        
        return filtered;
      };
      
      // 將主題鍵對應到顯示標籤，避免重複顯示
      const getThemeDisplayLabels = (word) => {
        const themes = getWordThemes(word);
        const labels = new Set();
        
        themes.forEach(theme => {
          if (theme === '氣候' || theme === 'climate') {
            labels.add('高中氣候');
          } else {
            labels.add(THEME_LABEL[theme] || theme);
          }
        });
        
        return Array.from(labels);
      };

      const categorizeWordForms = (source=[], baseWord='') => {
        const detail = emptyWordFormsDetail();
        const baseLower = String(baseWord||'').toLowerCase();
        source.forEach(item => {
          const text = String(item || '').trim();
          if (!text) return;
          const lower = text.toLowerCase();
          if (text.includes('*') || (baseLower && lower === baseLower)) {
            detail.base.push(text);
          }
          else if (/[\s]/.test(text) && !text.includes('-')) {
            detail.idiom.push(text);
          }
          else if (text.includes('-')) {
            detail.compound.push(text);
          }
          else if (baseLower && (lower.startsWith(baseLower) || baseLower.startsWith(lower))) {
            detail.derivation.push(text);
          }
          else {
            detail.derivation.push(text);
          }
        });
        detail.base = dedupeList(detail.base);
        detail.idiom = dedupeList(detail.idiom);
        detail.compound = dedupeList(detail.compound);
        detail.derivation = dedupeList(detail.derivation);
        return detail;
      };

      const normalizeWordFormsDetail = (rawDetail, fallback=[], baseWord='') => {
        let detail = emptyWordFormsDetail();
        if (rawDetail && typeof rawDetail === 'object' && !Array.isArray(rawDetail)) {
          detail.base = dedupeList(rawDetail.base || rawDetail.root || []);
          detail.idiom = dedupeList(rawDetail.idiom || rawDetail.phrase || []);
          detail.compound = dedupeList(rawDetail.compound || rawDetail.compounds || []);
          detail.derivation = dedupeList(rawDetail.derivation || rawDetail.other || rawDetail.misc || []);
        }
        const remaining = [];
        if (Array.isArray(rawDetail)) remaining.push(...rawDetail);
        if (Array.isArray(fallback)) remaining.push(...fallback);
        if (typeof fallback === 'string') remaining.push(...multiSplit(fallback));
        const categorized = categorizeWordForms(remaining, baseWord);
        if (!detail.base.length) detail.base = categorized.base;
        if (!detail.idiom.length) detail.idiom = categorized.idiom;
        if (!detail.compound.length) detail.compound = categorized.compound;
        if (!detail.derivation.length) detail.derivation = categorized.derivation;
        return detail;
      };

      const ensureWordFormsDetail = (word) => {
        const detail = normalizeWordFormsDetail(word.word_forms_detail, word.word_forms, word.english_word);
        const combined = dedupeList([...detail.base, ...detail.idiom, ...detail.compound, ...detail.derivation]);
        const themeList = mergeThemes(word.themes, word.theme);
        const primaryTheme = themeList.length ? themeList[0] : (String(word.theme || '').trim() || '');
        return {
          ...word,
          word_forms_detail: detail,
          // 保留原始的 word_forms 字串，不要覆蓋
          // word_forms: combined,
          theme: primaryTheme,
          themes: themeList
        };
      };

      const INITIAL_DATASET_RAW = (window.__INITIAL_DATASET__ || []);
      const INITIAL_DATASET = INITIAL_DATASET_RAW.map(ensureWordFormsDetail);


      const mergeWordFormsDetail = (target, source) => {
        const base = target ? {
          base: dedupeList(target.base || []),
          idiom: dedupeList(target.idiom || []),
          compound: dedupeList(target.compound || []),
          derivation: dedupeList(target.derivation || [])
        } : emptyWordFormsDetail();
        if (!source) return base;
        base.base = dedupeList([...base.base, ... (source.base || [])]);
        base.idiom = dedupeList([...base.idiom, ... (source.idiom || [])]);
        base.compound = dedupeList([...base.compound, ... (source.compound || [])]);
        base.derivation = dedupeList([...base.derivation, ... (source.derivation || source.other || [])]);
        return base;
      };

      function parseCSV(text) {
        const rows = [];
        let i = 0, cur = '', inQ = false, row = [];
        const pushCell = () => { row.push(cur); cur = ''; };
        const pushRow = () => { rows.push(row); row = []; };

        // 1. Tokenize the CSV string into rows/cells
        while (i < text.length) {
          const ch = text[i];
          if (ch === '"') { if (inQ && text[i + 1] === '"') { cur += '"'; i += 2; continue; } inQ = !inQ; i++; continue; }
          if (!inQ && ch === ',') { pushCell(); i++; continue; }
          if (!inQ && ch === '\n') { pushCell(); pushRow(); i++; continue; }
          if (!inQ && ch === '\r' && text[i + 1] === '\n') { pushCell(); pushRow(); i += 2; continue; }
          cur += ch; i++;
        }
        if (cur.length || row.length) { pushCell(); pushRow(); }
        if (!rows.length) return [];

        // 2. Smart Scan: Find the real header row
        // Look for a row that contains "english_word", "word", or "英文" to skip empty rows
        let headerIndex = -1;
        let headers = [];

        for (let r = 0; r < Math.min(rows.length, 8000); r++) {
          // Clean up BOM and whitespace for checking
          const potentialHeaders = rows[r].map(h => String(h || '').replace(/^\uFEFF/, '').trim().toLowerCase());

          if (potentialHeaders.includes('english_word') || potentialHeaders.includes('word') || potentialHeaders.includes('英文')) {
            headerIndex = r;
            headers = rows[r].map(h => String(h || '').replace(/^\uFEFF/, '').trim());
            break;
          }
        }

        // Fallback: if no specific header found, find the first non-empty row
        if (headerIndex === -1) {
          for (let r = 0; r < rows.length; r++) {
            if (rows[r].some(c => c.trim().length > 0)) {
              headerIndex = r;
              headers = rows[r].map(h => String(h || '').replace(/^\uFEFF/, '').trim());
              break;
            }
          }
        }

        if (headerIndex === -1) return []; // No valid data found

        // 3. Map data using the found headers
        return rows.slice(headerIndex + 1).map(cols => {
          const obj = {};
          for (let k = 0; k < headers.length; k++) {
            const key = headers[k];
            if (!key) continue;
            obj[key] = (cols[k] || '').trim();
          }
          return obj;
        });
      }

      const ADV_FREQUENCY = new Set(['always','usually','often','sometimes','seldom','rarely','never','again']);
      const ADV_DEGREE    = new Set(['very','quite','too','enough','almost','altogether']);
      const ADV_PLACE     = new Set(['here','there','above','below','abroad','anywhere','away','around','along','ahead']);
      const ADV_TIME      = new Set(['already','now','today','yesterday','tonight','soon']);
      const ADV_MANNER    = new Set(['aloud','alone']);

      const grammarDefaults = (word, pos, subcat='') => {
        const w = String(word);
        const lw = w.toLowerCase();
        const s = String(subcat||'');
        let func = '', patt = '';
        if (pos === 'pronoun') {
          if (s.includes('主格')) { func = '作主詞（Subject）'; patt = `${w} + V ...`; }
          else if (s.includes('受格')) { func = '作受詞（Object）'; patt = `S + V + ${w}`; }
          else if (s.includes('所有格形容')) { func = '修飾名詞（所有格形容詞）'; patt = `${w} + N`; }
          else if (s.includes('所有格')) { func = '代替名詞片語（所有格代名詞）'; patt = `S + be + ${w}`; }
          else if (s.includes('反身')) { func = '反身受詞／強調'; patt = `S + V + ${w}`; }
          else { func = '代替名詞（泛指）'; patt = `${w} + V ... / S + V + ${w}`; }
        }
        else if (pos === 'adverb') {
          if (ADV_FREQUENCY.has(lw)) { func = '頻率副詞：修飾動詞（be/助動詞之後、一般動詞之前）'; patt = 'S + (助動詞) + [頻率副詞] + V ... / be + [頻率副詞]'; }
          else if (ADV_DEGREE.has(lw)) { func = '程度副詞：修飾形容詞/副詞'; patt = '[程度副詞] + Adj/Adv'; }
          else if (ADV_PLACE.has(lw)) { func = '地點/方向副詞：常置句末或動詞後'; patt = 'S + V + (O) + [地點副詞]'; }
          else if (ADV_TIME.has(lw)) { func = '時間副詞：句末或句首'; patt = '[時間副詞], S + V ... / S + V + [時間副詞]'; }
          else if (ADV_MANNER.has(lw)) { func = '方式副詞：說明動作方式'; patt = 'S + V + [方式副詞]'; }
          else if (lw === 'also') { func = '添加副詞：也、還'; patt = 'S + also + V / be + also'; }
          else { func = '副詞：修飾動詞、形容詞或整句'; patt = 'S + V + (O) + Adv / Adv + 句子'; }
        }
        return { grammar_function: func, sentence_pattern: patt };
      };

      const useDataset = () => {
        const themeOrderRef = useRef({});

        const applyThemeOrder = (word, themes, counters = themeOrderRef.current) => {
          if (!word) return word;
          const list = Array.isArray(themes) ? themes : getWordThemes(word);
          if (!word.theme_order) word.theme_order = {};
          list.forEach((theme) => {
            const key = String(theme || '').trim();
            if (!key) return;
            if (word.theme_order[key] === undefined) {
              const idx = counters[key] ?? 0;
              word.theme_order[key] = idx;
              counters[key] = idx + 1;
            }
          });
          return word;
        };

        const hydrateDataset = (items, resetCounters = true) => {
          const counters = resetCounters ? {} : { ...themeOrderRef.current };
          const hydrated = (Array.isArray(items) ? items : []).map((item) => {
            const prepared = ensureWordFormsDetail(item);
            const clone = { ...prepared };
            if (clone.theme_order && typeof clone.theme_order === 'object') {
              Object.entries(clone.theme_order).forEach(([theme, order]) => {
                const num = Number(order);
                if (Number.isFinite(num) && num >= 0) {
                  counters[theme] = Math.max(counters[theme] || 0, num + 1);
                }
              });
            }
            applyThemeOrder(clone, getWordThemes(clone), counters);
            return clone;
          });
          themeOrderRef.current = counters;
          return hydrated;
        };

        const [data, setData] = useState(() => {
          try {
            const storedVersion = localStorage.getItem(LS.presetApplied);
            if (storedVersion === PRESET_VERSION) {
              const raw = localStorage.getItem(LS.dataset);
              if (raw) {
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed) && parsed.length) {
                  const hydrated = hydrateDataset(parsed);
                  // 測試：為 conservation 自動加入影片連結
                  const conservation = hydrated.find(w => w.english_word === 'conservation');
                  if (conservation && !conservation.videoUrl) {
                    conservation.videoUrl = 'https://www.youtube.com/watch?v=C8iYen-4V2A';
                  }
                  return hydrated;
                }
              }
            }
          } catch {}
          try {
            localStorage.removeItem(LS.dataset);
            localStorage.removeItem(LS.presetApplied);
          } catch {}
          const baseData = hydrateDataset(makeBaseDataset());
          // 測試：為 conservation 自動加入影片連結
          const conservation = baseData.find(w => w.english_word === 'conservation');
          if (conservation && !conservation.videoUrl) {
            conservation.videoUrl = 'https://www.youtube.com/watch?v=C8iYen-4V2A';
          }
          return baseData;
        });

        useEffect(() => {
          try { localStorage.setItem(LS.dataset, JSON.stringify(data)); } catch {}
        }, [data]);

        const addItems = (items, opts = {}) => {
          const overrideExamples = !!opts.overrideExamples;
          const replace = !!opts.replace;
          const stats = { added: 0, merged: 0, replaced: 0, tagsAdded: {}, totalBefore: 0, totalAfter: 0 };
          const incomingList = Array.isArray(items) ? items : [];

          setData((current) => {
            stats.totalBefore = current.length;
            const baseCounters = {};
            const preparedCurrent = current.map((item) => {
              const prepared = ensureWordFormsDetail(item);
              const clone = { ...prepared };
              applyThemeOrder(clone, getWordThemes(clone), baseCounters);
              return clone;
            });

            const counters = replace ? {} : baseCounters;
            if (replace) {
              stats.replaced = current.length;
            }
            themeOrderRef.current = counters;

            const next = replace ? [] : preparedCurrent;
            const byWord = new Map(next.map((w) => [String(w.english_word || '').toLowerCase(), w]));
            let maxId = next.reduce((m, w) => Math.max(m, Number(w.id) || 0), 0);

            const mergeAffixInfo = (target, source) => {
              if (!source) return;
              if (!target.affix_info) {
                target.affix_info = { prefix: '', root: '', suffix: '', meaning: '', example: '' };
              }
              ['prefix', 'root', 'suffix', 'meaning', 'example'].forEach((key) => {
                if (!target.affix_info[key] && source[key]) {
                  target.affix_info[key] = source[key];
                }
              });
            };

            const ensureTag = (wordObj, tag) => {
              if (!tag) return;
              if (!wordObj.posTags) wordObj.posTags = [];
              if (!wordObj.posTags.includes(tag)) {
                wordObj.posTags = [...wordObj.posTags, tag];
                wordObj.basic_pos = wordObj.posTags.join(', ');
                stats.tagsAdded[tag] = (stats.tagsAdded[tag] || 0) + 1;
              }
            };

            incomingList.forEach((raw) => {
              if (!raw) return;
              const english = String(raw.english_word || raw.word || raw.Word || raw['英文'] || raw['英文單字'] || '').trim();
              if (!english) return;

              const posSources = [raw.posTags, raw.basic_pos, raw.grammar_main_category, raw['詞性'], raw['詞性分類'], raw.pos];
              const tagTokens = [];
              posSources.forEach((src) => {
                if (!src) return;
                if (Array.isArray(src)) tagTokens.push(...src);
                else tagTokens.push(...multiSplit(src));
              });
              const tags = Array.from(new Set(tagTokens.map(normalizePOS).filter(Boolean)));
              if (!tags.length) tags.push('other');

              const formsRaw = raw.word_forms ?? raw['詞性變化'];
              // 保留原始字串用於顯示，同時為 normalizeWordFormsDetail 準備陣列
              const formsForDetail = Array.isArray(formsRaw) ? formsRaw : multiSplit(formsRaw || '');
              const levelValue = raw.level ?? raw.Level ?? raw.LEVEL ?? raw['Level'] ?? raw['LEVEL'] ?? '';
              const level = String(levelValue || '').trim();
              const normalizedDetail = normalizeWordFormsDetail(raw.word_forms_detail, formsForDetail, english);
              let themes = mergeThemes(raw.themes, raw.theme, raw['主題'], raw.default_theme, raw.defaultTheme);
              if (!themes.length && tags.length) themes = mergeThemes(tags[0]);
              if (!themes.length) themes = ['general'];

              const toList = (value, alt) => Array.isArray(value) ? value : multiSplit(value || alt || '');
              const derivatives = toList(raw.derivatives, raw['衍生詞']);
              const synonyms = toList(raw.synonyms, raw['同義字']);
              const antonyms = toList(raw.antonyms, raw['反義字']);
              const confusables = toList(raw.confusables, raw['易混淆字']);

              const affixSource = (raw.affix_info && typeof raw.affix_info === 'object') ? raw.affix_info : {};
              const incoming = ensureWordFormsDetail({
                id: null,
                english_word: english,
                kk_phonetic: raw.kk_phonetic || raw.KK || raw['KK音標'] || '',
                chinese_definition: raw.chinese_definition || raw['中譯'] || raw['中文'] || '',
                posTags: tags,
                basic_pos: tags.join(', '),
                grammar_main_category: normalizePOS(tags[0] || raw.grammar_main_category || raw['詞性'] || ''),
                grammar_sub_category: raw.grammar_sub_category || raw['詞性分類'] || '',
                grammar_function: raw.grammar_function || raw['語法功能'] || '',
                applicable_sentence_pattern: raw.applicable_sentence_pattern || raw['句型'] || '',
                example_sentence: raw.example_sentence || raw['例句'] || raw['ai例句'] || '',
                example_translation: raw.example_translation || raw['翻譯'] || raw['ai例句中譯'] || '',
                example_sentence_2: raw.example_sentence_2 || raw['例句2'] || raw['例句_2'] || raw.sentence2 || raw['GSAT_Example_Sentence_1'] || '',
                example_translation_2: raw.example_translation_2 || raw['翻譯2'] || raw['翻譯_2'] || raw.translation2 || raw['GSAT_Translation_1'] || '',
                example_sentence_3: raw.example_sentence_3 || raw['例句3'] || raw['例句_3'] || raw.sentence3 || '',
                example_translation_3: raw.example_translation_3 || raw['翻譯3'] || raw['翻譯_3'] || raw.translation3 || '',
                example_sentence_4: raw.example_sentence_4 || raw['例句4'] || raw['例句_4'] || raw.sentence4 || '',
                example_translation_4: raw.example_translation_4 || raw['翻譯4'] || raw['翻譯_4'] || raw.translation4 || '',
                example_sentence_5: raw.example_sentence_5 || raw['例句5'] || raw['例句_5'] || raw.sentence5 || '',
                example_translation_5: raw.example_translation_5 || raw['翻譯5'] || raw['翻譯_5'] || raw.translation5 || '',
                example_source_2: (() => {
                  // 優先使用已處理的 example_source_2
                  if (raw.example_source_2) return raw.example_source_2;
                  // 否則從 Year_1, Part_1, Source_1 組合
                  const year = raw['Year_1'] || '';
                  const part = raw['Part_1'] || '';
                  const source = raw['Source_1'] || '';
                  if (year && part && source) {
                    return `${year}\t${part}\t${source}`;
                  }
                  return '';
                })(),
                theme: themes[0] || '',
                themes,
                level,
                cefr: raw.cefr || raw.CEFR || raw['CEFR'] || '',
                word_forms: formsRaw || '', // 使用原始字串，保留換行
                word_forms_detail: normalizedDetail,
                derivatives,
                synonyms,
                antonyms,
                confusables,
                phrases: Array.isArray(raw.phrases) ? raw.phrases : (typeof raw.phrases === 'string' ? raw.phrases.split(';').map(p => p.trim()).filter(p => p) : (raw['片語'] || '').split(';').map(p => p.trim()).filter(p => p)),
                videoUrl: raw.videoUrl || raw.video_url || raw['影片連結'] || raw['影片'] || '',
                // 新增的三個欄位：stage, textbook_index, exam_tags
                stage: raw.stage || null,
                textbook_index: Array.isArray(raw.textbook_index) ? raw.textbook_index : (raw.textbook_index || []),
                exam_tags: Array.isArray(raw.exam_tags) ? raw.exam_tags : (raw.exam_tags || []),
                affix_info: {
                  prefix: affixSource.prefix || raw.affix_prefix || raw.prefix || raw['字首'] || '',
                  root: affixSource.root || raw.affix_root || raw.root || raw['字根'] || '',
                  suffix: affixSource.suffix || raw.affix_suffix || raw.suffix || raw['字尾'] || '',
                  meaning: affixSource.meaning || raw.affix_meaning || raw.meaning || raw['意思'] || '',
                  example: affixSource.example || raw.affix_example || raw.example || raw['例子'] || ''
                }
              });

              const key = english.toLowerCase();
              const existing = byWord.get(key);
              if (existing) {
                incoming.posTags.forEach((tag) => ensureTag(existing, tag));
                const combinedThemes = mergeThemes(existing.themes, existing.theme, themes);
                existing.themes = combinedThemes;
                if (!existing.theme && combinedThemes.length) existing.theme = combinedThemes[0];
                if (level) existing.level = level;
                applyThemeOrder(existing, combinedThemes, counters);

                if (!existing.kk_phonetic && incoming.kk_phonetic) existing.kk_phonetic = incoming.kk_phonetic;
                if (!existing.chinese_definition && incoming.chinese_definition) existing.chinese_definition = incoming.chinese_definition;
                if (!existing.grammar_main_category && incoming.grammar_main_category) existing.grammar_main_category = incoming.grammar_main_category;
                if (!existing.grammar_sub_category && incoming.grammar_sub_category) existing.grammar_sub_category = incoming.grammar_sub_category;
                if (!existing.grammar_function && incoming.grammar_function) existing.grammar_function = incoming.grammar_function;
                if (!existing.applicable_sentence_pattern && incoming.applicable_sentence_pattern) existing.applicable_sentence_pattern = incoming.applicable_sentence_pattern;
                if (!existing.theme && incoming.theme) existing.theme = incoming.theme;

                const primaryPos = existing.posTags?.[0] || incoming.posTags[0] || 'noun';
                const autoSentence = exampleFor(existing.english_word, primaryPos);
                const autoTranslation = translationFor(existing.english_word, primaryPos);

                if (incoming.example_sentence && (overrideExamples || !existing.example_sentence || existing.example_sentence === autoSentence)) {
                  existing.example_sentence = incoming.example_sentence;
                }
                if (incoming.example_translation && (overrideExamples || !existing.example_translation || existing.example_translation === autoTranslation)) {
                  existing.example_translation = incoming.example_translation;
                }
                if (incoming.example_sentence_2 && (overrideExamples || !existing.example_sentence_2)) {
                  existing.example_sentence_2 = incoming.example_sentence_2;
                }
                if (incoming.example_translation_2 && (overrideExamples || !existing.example_translation_2)) {
                  existing.example_translation_2 = incoming.example_translation_2;
                }

                existing.word_forms_detail = mergeWordFormsDetail(existing.word_forms_detail, incoming.word_forms_detail);
                // word_forms 是字串，不需要合併，只更新
                if (incoming.word_forms && !existing.word_forms) {
                  existing.word_forms = incoming.word_forms;
                }
                existing.derivatives = dedupeList([...(existing.derivatives || []), ...incoming.derivatives]);
                existing.synonyms = dedupeList([...(existing.synonyms || []), ...incoming.synonyms]);
                existing.antonyms = dedupeList([...(existing.antonyms || []), ...incoming.antonyms]);
                existing.confusables = dedupeList([...(existing.confusables || []), ...incoming.confusables]);
                // phrases 是陣列
                existing.phrases = dedupeList([...(existing.phrases || []), ...(incoming.phrases || [])]);
                mergeAffixInfo(existing, incoming.affix_info);
                
                // 更新影片連結（如果有新的）
                if (incoming.videoUrl && !existing.videoUrl) {
                  existing.videoUrl = incoming.videoUrl;
                }
                
                // 更新新增的三個欄位：stage, textbook_index, exam_tags
                // stage: 只有當新資料有值且舊資料為空時才更新
                if (incoming.stage && !existing.stage) {
                  existing.stage = incoming.stage;
                }
                
                // textbook_index 合併（陣列）
                // 確保 existing.textbook_index 是陣列
                if (!Array.isArray(existing.textbook_index)) {
                  existing.textbook_index = [];
                }
                // 如果新資料有 textbook_index 且不是空陣列，則合併
                if (incoming.textbook_index && Array.isArray(incoming.textbook_index) && incoming.textbook_index.length > 0) {
                  incoming.textbook_index.forEach(item => {
                    if (item && item.version && item.vol && item.lesson) {
                      const exists = existing.textbook_index.some(existingItem => 
                        existingItem && existingItem.version === item.version && 
                        existingItem.vol === item.vol && 
                        existingItem.lesson === item.lesson
                      );
                      if (!exists) {
                        existing.textbook_index.push(item);
                      }
                    }
                  });
                }
                // 如果新資料沒有 textbook_index 或為空，保持 existing 不變（不覆蓋）
                
                // exam_tags 合併（陣列）
                // 確保 existing.exam_tags 是陣列
                if (!Array.isArray(existing.exam_tags)) {
                  existing.exam_tags = [];
                }
                // 如果新資料有 exam_tags 且不是空陣列，則合併
                if (incoming.exam_tags && Array.isArray(incoming.exam_tags) && incoming.exam_tags.length > 0) {
                  incoming.exam_tags.forEach(tag => {
                    if (tag && !existing.exam_tags.includes(tag)) {
                      existing.exam_tags.push(tag);
                    }
                  });
                }
                // 如果新資料沒有 exam_tags 或為空，保持 existing 不變（不覆蓋）

                Object.assign(existing, ensureWordFormsDetail(existing));
                stats.merged += 1;
              } else {
                maxId += 1;
                const firstPos = incoming.posTags[0] || 'other';
                const primaryTheme = incoming.theme || themes[0] || 'general';
                const newWord = ensureWordFormsDetail({
                  ...incoming,
                  id: maxId,
                  theme: primaryTheme,
                  themes,
                  grammar_main_category: incoming.grammar_main_category || firstPos,
                  example_sentence: incoming.example_sentence || exampleFor(english, firstPos),
                  example_translation: incoming.example_translation || translationFor(english, firstPos)
                });
                newWord.posTags = incoming.posTags;
                newWord.basic_pos = incoming.posTags.join(', ');
                if (!newWord.theme) newWord.theme = primaryTheme;
                newWord.themes = mergeThemes(newWord.themes, newWord.theme);
                applyThemeOrder(newWord, newWord.themes, counters);
                if (incoming.affix_info) newWord.affix_info = incoming.affix_info;
                next.push(newWord);
                byWord.set(key, newWord);
                stats.added += 1;
              }
            });

            themeOrderRef.current = counters;
            stats.totalAfter = next.length;
            return next;
          });

          return stats;
        };

        const reset = () => {
          try {
            localStorage.removeItem(LS.dataset);
            localStorage.removeItem(LS.presetApplied);
          } catch {}
          setData(hydrateDataset(makeBaseDataset()));
        };

        useEffect(() => {
          let cancelled = false;
          const ensureCsvPreset = async () => {
            try { if (localStorage.getItem(LS.presetApplied) === PRESET_VERSION) return; } catch {}
            const aggregated = [];
            for (const source of CSV_SOURCES) {
              let text = '';
              const candidates = Array.isArray(source.urls) && source.urls.length ? source.urls : [source.url];
              for (const rawUrl of candidates) {
                const url = encodeURI(rawUrl);
                try {
                  const res = await fetch(url);
                  if (!res.ok) continue;
                  text = await res.text();
                  if (text) text = text.replace(/^﻿/, '');
                  if (text) break;
                } catch (err) {
                  // try next candidate
                }
              }
              if (!text && source.embeddedText) {
                text = source.embeddedText;
              }
              if (text) text = text.replace(/^﻿/, '');
              if (!text) continue;

              const rows = parseCSV(text);
              const defaultTheme = source.defaults?.theme || '';
              const effectiveRows = source.limit ? rows.slice(0, source.limit) : rows;
              effectiveRows.forEach((row) => {
                const english = (row.word || row['word'] || row['english_word'] || row['英文'] || row['英文單字'] || row.word_lower || '').trim();
                if (!english) return;
                
                // 解析 stage 欄位：將 "高中" 轉為 'senior'，"國中" 轉為 'junior'
                // 嘗試多種可能的欄位名稱（大小寫不敏感）
                const stageRaw = (row['stage'] || row['Stage'] || row['STAGE'] || row['學程'] || '').trim();
                let stage = null;
                if (stageRaw === '高中') {
                  stage = 'senior';
                } else if (stageRaw === '國中') {
                  stage = 'junior';
                }
                
                // 解析 theme_index 欄位
                // 國中模式：格式 "1200-family | 800-family"，需要解析成 theme_index 陣列
                // 高中模式：直接使用主題值，不需要解析 range-theme 格式
                const themeIndexRaw = (row['主題'] || row['theme'] || row['themes'] || row['Theme'] || row['THEME'] || row['THEMES'] || row['主題分類'] || row['主題標籤'] || row['主題標記'] || '').trim();
                const themeIndex = [];
                
                if (themeIndexRaw && stage === 'junior') {
                  // 國中模式：解析 "1200-family | 800-family" 格式
                  // 支援分號或管道符號分隔多個項目
                  const items = themeIndexRaw.split(/[;|]/).map(s => s.trim()).filter(Boolean);
                  items.forEach(item => {
                    // 格式：range-theme（例如：1200-family, 800-family）
                    const parts = item.split('-').map(s => s.trim());
                    if (parts.length >= 2) {
                      const range = parts[0].trim(); // 1200 或 800
                      const theme = parts.slice(1).join('-').trim(); // family 或其他主題（處理主題本身可能包含「-」的情況）
                      // 檢查 range 是否為數字（1200 或 800）
                      if (/^\d+$/.test(range) && theme) {
                        themeIndex.push({
                          range: range,  // 1200 或 800
                          theme: theme   // family 或其他主題
                        });
                      }
                    }
                  });
                }
                
                // 保留原有的 themes 欄位邏輯
                // 高中模式：直接使用主題值
                // 國中模式：如果沒有解析到 theme_index，也使用主題值作為備用
                let themes = [];
                if (stage === 'senior') {
                  // 高中模式：直接使用主題值
                  themes = mergeThemes(row.themes, themeIndexRaw, defaultTheme);
                } else {
                  // 國中模式：如果有 theme_index，從中提取主題；否則使用原始主題值
                  if (themeIndex.length > 0) {
                    const themeSet = new Set();
                    themeIndex.forEach(item => {
                      if (item.theme) themeSet.add(item.theme);
                    });
                    themes = Array.from(themeSet);
                    if (themes.length === 0) {
                      themes = mergeThemes(row.themes, defaultTheme);
                    }
                  } else {
                    themes = mergeThemes(row.themes, themeIndexRaw, defaultTheme);
                  }
                }
                const primaryTheme = themes.length ? themes[0] : defaultTheme;
                
                // 除錯：檢查主題欄位（前 10 筆資料，以及第 6070-6080 筆資料）
                const shouldDebug = aggregated.length < 10 || (aggregated.length >= 6070 && aggregated.length < 6080);
                if (shouldDebug) {
                  console.log(`單字 "${english}" (第 ${aggregated.length + 1} 筆) 的主題欄位值:`, {
                    'row[主題]': row['主題'],
                    'row[theme]': row['theme'],
                    'stage': stage,
                    'themeIndexRaw': themeIndexRaw,
                    'themeIndex': themeIndex,
                    'themes': themes,
                    'primaryTheme': primaryTheme,
                    'hasThemeIndex': themeIndex.length > 0
                  });
                }
                
                // 解析 textbook_index 欄位：格式 "龍騰-B1-L1; 翰林-B2-L3"
                // 嘗試多種可能的欄位名稱
                const textbookIndexRaw = (row['textbook_index'] || row['textbookIndex'] || row['課本索引'] || '').trim();
                const textbookIndex = [];
                
                // 調試：檢查前幾筆資料
                if (english && (english === 'atmosphere' || english === 'frost' || english === 'globe')) {
                  console.log('=== 解析 textbook_index 調試 ===');
                  console.log('單字:', english);
                  console.log('row[textbook_index]:', row['textbook_index']);
                  console.log('textbookIndexRaw:', textbookIndexRaw);
                }
                
                if (textbookIndexRaw) {
                  const items = textbookIndexRaw.split(';').map(s => s.trim()).filter(Boolean);
                  if (english && (english === 'atmosphere' || english === 'frost' || english === 'globe')) {
                    console.log('分割後的 items:', items);
                  }
                  items.forEach(item => {
                    const parts = item.split('-').map(s => s.trim());
                    if (english && (english === 'atmosphere' || english === 'frost' || english === 'globe')) {
                      console.log('處理 item:', item, 'parts:', parts);
                    }
                    if (parts.length >= 3) {
                      textbookIndex.push({
                        version: parts[0],  // 版本：龍騰、翰林等
                        vol: parts[1],      // 冊次：B1, B2 等
                        lesson: parts[2]    // 課次：L1, L2 等（可能還有更多部分，但先取前三個）
                      });
                    } else if (english && (english === 'atmosphere' || english === 'frost' || english === 'globe')) {
                      console.log('格式不符合預期，parts.length:', parts.length);
                    }
                  });
                  if (english && (english === 'atmosphere' || english === 'frost' || english === 'globe')) {
                    console.log('解析後的 textbookIndex:', textbookIndex);
                  }
                } else if (english && (english === 'atmosphere' || english === 'frost' || english === 'globe')) {
                  console.log('textbook_index 欄位值為空');
                }
                
                // 解析 exam_tags 欄位：格式 "108學測; 110指考"
                const examTagsRaw = (row['exam_tags'] || '').trim();
                const examTags = examTagsRaw 
                  ? examTagsRaw.split(';').map(s => s.trim()).filter(Boolean)
                  : [];
                
                aggregated.push({
                  english_word: english,
                  kk_phonetic: row['KK音標'] || row['KK'] || '',
                  chinese_definition: row['中譯'] || row['definition'] || row['鍾意'] || '',
                  example_sentence: row['例句'] || row['sentence'] || row['ai例句'] || row['example_sentence'] || '',
                  example_translation: row['翻譯'] || row['translation'] || row['ai例句中譯'] || row['example_translation'] || '',
                  example_sentence_2: row['例句2'] || row['例句_2'] || row['sentence2'] || row['GSAT_Example_Sentence_1'] || row['example_sentence_2'] || '',
                  example_translation_2: row['翻譯2'] || row['翻譯_2'] || row['translation2'] || row['GSAT_Translation_1'] || row['example_translation_2'] || '',
                  example_sentence_3: row['例句3'] || row['例句_3'] || row['sentence3'] || row['example_sentence_3'] || '',
                  example_translation_3: row['翻譯3'] || row['翻譯_3'] || row['translation3'] || row['example_translation_3'] || '',
                  example_sentence_4: row['例句4'] || row['例句_4'] || row['sentence4'] || row['example_sentence_4'] || '',
                  example_translation_4: row['翻譯4'] || row['翻譯_4'] || row['translation4'] || row['example_translation_4'] || '',
                  example_sentence_5: row['例句5'] || row['例句_5'] || row['sentence5'] || row['example_sentence_5'] || '',
                  example_translation_5: row['翻譯5'] || row['翻譯_5'] || row['translation5'] || row['example_translation_5'] || '',
                  example_source_2: (() => {
                    const year = row['Year_1'] || row['N'] || '';
                    const part = row['Part_1'] || row['O'] || '';
                    const source = row['Source_1'] || row['P'] || '';
                    if (year && part && source) {
                      return `${year}\t${part}\t${source}`;
                    }
                    return '';
                  })(),
                  grammar_main_category: row['詞性'] || row['副詞'] || row['pos'] || '',
                  grammar_sub_category: row['詞性分類'] || row['子分類'] || row['subcat'] || '',
                  theme: primaryTheme || '',
                  themes,
                  default_theme: defaultTheme,
                  level: row['level'] || row['Level'] || row['LEVEL'] || '',
                  cefr: row['CEFR'] || row['cefr'] || '',
                  word_forms: row['詞性變化'] || row['詞形變化'] || row['詞形說明'] || row['word_forms'] || '',
                  derivatives: row['衍生詞'] || row['derivatives'] || '',
                  synonyms: row['同義字'] || row['synonyms'] || '',
                  antonyms: row['反義字'] || row['antonyms'] || '',
                  confusables: row['易混淆字'] || row['confusables'] || '',
                  phrases: (row['片語'] || row['phrases'] || '').split(/[;；]/).map(p => p.trim()).filter(p => p),
                  word_forms_detail: row['word_forms_detail'],
                  affix_info: {
                    prefix: row['字首'] || row['prefix'] || '',
                    root: row['字根'] || row['root'] || '',
                    suffix: row['字尾'] || row['suffix'] || '',
                    meaning: row['意思'] || row['meaning'] || '',
                    example: row['例子'] || row['example'] || ''
                  },
                  // 新增的欄位
                  stage: stage,
                  textbook_index: textbookIndex,
                  exam_tags: examTags,
                  theme_index: themeIndex,  // 主題索引陣列，格式：[{range: '1200', theme: 'family'}, ...]
                  videoUrl: row['videoUrl'] || row['video_url'] || row['video'] || row['影片連結'] || row['影片'] || row['Video URL'] || row['Video'] || row['VIDEO_URL'] || row['VIDEO'] || ''
                });
              });
            }
            if (!cancelled && aggregated.length) {
              addItems(aggregated, { overrideExamples: false, replace: true });
              try { localStorage.setItem(LS.presetApplied, PRESET_VERSION); } catch {}
            }
          };
          ensureCsvPreset();
          return () => { cancelled = true; };
        }, []);

        return { data, addItems, reset };
      };

      const useFavorites = () => {
        const [favorites, setFavorites] = useState(() => {
          try {
            const raw = localStorage.getItem(LS.favorites);
            return raw ? JSON.parse(raw) : [];
          } catch {
            return [];
          }
        });
        useEffect(() => {
          try { localStorage.setItem(LS.favorites, JSON.stringify(favorites)); } catch {}
        }, [favorites]);
        return {
          favorites,
          toggle: (id) => setFavorites((cur) => cur.includes(id) ? cur.filter((x) => x !== id) : [...cur, id]),
          remove: (id) => setFavorites((cur) => cur.filter((x) => x !== id)),
          clear: () => setFavorites([])
        };
      };

      // 管理使用者自訂例句的 hook
      const useUserExamples = () => {
        const [userExamples, setUserExamples] = useState(() => {
          try {
            const raw = localStorage.getItem(LS.userExamples);
            return raw ? JSON.parse(raw) : {};
          } catch {
            return {};
          }
        });
        
        useEffect(() => {
          try { 
            localStorage.setItem(LS.userExamples, JSON.stringify(userExamples)); 
          } catch (e) {
            console.error('無法儲存使用者例句:', e);
          }
        }, [userExamples]);
        
        return {
          // 取得某個單字的使用者例句
          get: (wordId) => {
            return userExamples[wordId] || [];
          },
          // 新增例句
          add: (wordId, sentence, translation) => {
            setUserExamples((cur) => {
              const existing = cur[wordId] || [];
              return {
                ...cur,
                [wordId]: [...existing, { 
                  sentence: sentence.trim(), 
                  translation: translation.trim(),
                  source: 'user',
                  createdAt: new Date().toISOString()
                }]
              };
            });
          },
          // 刪除例句
          remove: (wordId, exampleIndex) => {
            setUserExamples((cur) => {
              const existing = cur[wordId] || [];
              const updated = existing.filter((_, idx) => idx !== exampleIndex);
              if (updated.length === 0) {
                const newState = { ...cur };
                delete newState[wordId];
                return newState;
              }
              return { ...cur, [wordId]: updated };
            });
          },
          // 清空某個單字的所有使用者例句
          clearWord: (wordId) => {
            setUserExamples((cur) => {
              const newState = { ...cur };
              delete newState[wordId];
              return newState;
            });
          },
          // 清空所有使用者例句
          clearAll: () => {
            setUserExamples({});
          }
        };
      };

      // 管理使用者身分設定的 hook
      const useUserSettings = () => {
        const [userSettings, setUserSettings] = useState(() => {
          try {
            const raw = localStorage.getItem(LS.userSettings);
            return raw ? JSON.parse(raw) : null;
          } catch {
            return null;
          }
        });
        useEffect(() => {
          if (userSettings) {
            try { localStorage.setItem(LS.userSettings, JSON.stringify(userSettings)); } catch {}
          } else {
            try { localStorage.removeItem(LS.userSettings); } catch {}
          }
        }, [userSettings]);
        return {
          userSettings,
          setUserSettings: (settings) => setUserSettings(settings),
          clear: () => setUserSettings(null)
        };
      };

      // 管理當前模式的 hook
      const useCurrentTab = () => {
        const [currentTab, setCurrentTab] = useState(() => {
          try {
            const saved = localStorage.getItem(LS.currentTab);
            return saved || 'textbook';
          } catch {
            return 'textbook';
          }
        });
        useEffect(() => {
          try { localStorage.setItem(LS.currentTab, currentTab); } catch {}
        }, [currentTab]);
        return { currentTab, setCurrentTab };
      };

      // 管理篩選條件的 hook
      const useFilters = () => {
        const [filters, setFilters] = useState(() => {
          try {
            const raw = localStorage.getItem(LS.filters);
            return raw ? JSON.parse(raw) : { textbook: {}, exam: {}, theme: {} };
          } catch {
            return { textbook: {}, exam: {}, theme: {} };
          }
        });
        useEffect(() => {
          try { localStorage.setItem(LS.filters, JSON.stringify(filters)); } catch {}
        }, [filters]);
        return {
          filters,
          setFilters: (newFilters) => setFilters(newFilters),
          updateFilter: (mode, filterData) => {
            setFilters(prev => ({
              ...prev,
              [mode]: filterData
            }));
          },
          clear: () => setFilters({ textbook: {}, exam: {}, theme: {} })
        };
      };

      // 管理詞性快篩的 hook
      const useQuickFilterPos = () => {
        const [quickFilterPos, setQuickFilterPos] = useState(() => {
          try {
            const saved = localStorage.getItem(LS.quickFilterPos);
            return saved || 'all';
          } catch {
            return 'all';
          }
        });
        useEffect(() => {
          try { localStorage.setItem(LS.quickFilterPos, quickFilterPos); } catch {}
        }, [quickFilterPos]);
        return { quickFilterPos, setQuickFilterPos };
      };

      // 管理測驗歷史記錄的 hook
      const useQuizHistory = () => {
        const MAX_HISTORY = 50;
        
        const [history, setHistory] = useState(() => {
          try {
            const raw = localStorage.getItem(LS.quizHistory);
            return raw ? JSON.parse(raw) : [];
          } catch {
            return [];
          }
        });
        
        useEffect(() => {
          try {
            localStorage.setItem(LS.quizHistory, JSON.stringify(history));
          } catch (e) {
            console.error('無法儲存測驗歷史:', e);
          }
        }, [history]);
        
        return {
          // 取得所有記錄
          getAll: () => {
            return [...history].sort((a, b) => new Date(b.date) - new Date(a.date));
          },
          // 新增記錄
          add: (record) => {
            setHistory((cur) => {
              const newRecord = {
                ...record,
                id: record.id || new Date().toISOString(),
                date: record.date || new Date().toISOString()
              };
              const updated = [newRecord, ...cur].slice(0, MAX_HISTORY);
              return updated;
            });
          },
          // 刪除單筆記錄
          remove: (id) => {
            setHistory((cur) => cur.filter((r) => r.id !== id));
          },
          // 清除所有記錄
          clearAll: () => {
            setHistory([]);
          },
          // 取得單筆記錄
          get: (id) => {
            return history.find((r) => r.id === id);
          }
        };
      };

      const Importer = ({ onImport, className = "" }) => {
        const [msg, setMsg] = useState("");
        const [paste, setPaste] = useState("");
        const [dragOver, setDragOver] = useState(false);
        const [override, setOverride] = useState(true);
        const inputRef = useRef(null);

        const posSummary = (stats) => Object.entries(stats.tagsAdded || {}).map(([k, v]) => `${POS_LABEL[k] || k}:${v}`).join('、');

        const importText = async (rawText, hint) => {
          const text = String(rawText || "").replace(/^\uFEFF/, "").trim();
          if (!text) { setMsg("匯入失敗：內容為空"); return; }

          const tryJson = () => {
            try {
              const parsed = JSON.parse(text);
              if (Array.isArray(parsed)) {
                const stats = onImport(parsed, { overrideExamples: override, replace: false });
                const summary = posSummary(stats);
                setMsg(`已匯入 ${stats.added + stats.merged} 筆（${hint}JSON），新增單字 ${stats.added}，合併 ${stats.merged}${summary ? `，新增標籤 ${summary}` : ""}。`);
                return true;
              }
            } catch {}
            return false;
          };

          if (tryJson()) return;
          const rows = parseCSV(text);
          if (!rows.length) { setMsg("匯入失敗：內容不是有效的 JSON 或 CSV"); return; }
          const stats = onImport(rows, { overrideExamples: override, replace: false });
          const summary = posSummary(stats);
          setMsg(`已匯入 ${stats.added + stats.merged} 筆（${hint}CSV），新增單字 ${stats.added}，合併 ${stats.merged}${summary ? `，新增標籤 ${summary}` : ""}。`);
        };

        const onInputChange = (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => { importText(reader.result, `${file.name}/`); };
          reader.onerror = () => { setMsg(`匯入失敗：無法讀取檔案 ${file.name}`); };
          reader.readAsText(file);
          e.target.value = "";
        };

        const onDrop = (e) => {
          e.preventDefault();
          setDragOver(false);
          const file = e.dataTransfer?.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => { importText(reader.result, `${file.name}/`); };
          reader.onerror = () => { setMsg(`匯入失敗：無法讀取檔案 ${file.name}`); };
          reader.readAsText(file);
        };

        return (
          <div
            className={`rounded-2xl border p-4 bg-white/60 ${dragOver ? 'ring-2 ring-indigo-400' : ''} ${className}`}
            onDragOver={(e) => { e.preventDefault(); setDragOver(true); }}
            onDragLeave={() => setDragOver(false)}
            onDrop={onDrop}
          >
            <div className="font-semibold mb-2">資料匯入（JSON/CSV）</div>
            <p className="text-sm text-gray-600 mb-3">三種方式：① 選擇檔案 ② 拖曳到此區 ③ 直接貼上文字</p>

            <div className="flex flex-wrap items-center gap-3 mb-3">
              <input ref={inputRef} type="file" accept="application/json,.json,.csv,text/csv,text/plain" className="hidden" onChange={onInputChange} />
              <Button variant="ghost" onClick={() => inputRef.current?.click()}>選擇 JSON 或 CSV 檔</Button>
              <label className="flex items-center gap-1 text-xs text-gray-600">
                <input type="checkbox" className="mr-1" checked={override} onChange={(e) => setOverride(e.target.checked)} />
                匯入例句／翻譯時覆蓋現有內容
              </label>
              <span className="text-xs text-gray-500">或拖曳檔案至此</span>
            </div>

            <div className="mt-2">
              <textarea
                value={paste}
                onChange={(e) => setPaste(e.target.value)}
                placeholder="或直接貼上 JSON / CSV 文字..."
                className="w-full h-28 px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
              <div className="mt-2">
                <Button variant="ghost" onClick={() => importText(paste, '貼上/')}>匯入貼上的內容</Button>
              </div>
            </div>

          {msg && <div className="text-xs text-gray-500 mt-2">{msg}</div>}
        </div>
        );
      };

      const Shell = ({ children, onReset, route, userSettings, onUserSettingsChange }) => {
        const [showGuide, setShowGuide] = useState(false);
        const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
        
        // 取得當前路由
        const [currentHash, setCurrentHash] = useState(() => window.location.hash || "#/");
        
        useEffect(() => {
          const onHashChange = () => setCurrentHash(window.location.hash || "#/");
          window.addEventListener("hashchange", onHashChange);
          return () => window.removeEventListener("hashchange", onHashChange);
        }, []);
        
        // 判斷是否為當前頁面
        const isActive = (path) => {
          if (path === "#/") {
            return currentHash === "#/" || currentHash === "";
          }
          return currentHash.startsWith(path);
        };
        
        const handleReload = () => {
          if (confirm('確定要從雲端更新單字庫嗎？\n（會載入最新單字資料，但保留你的學習記錄）')) {
            localStorage.removeItem('mvp_vocab_dataset_v36');
            localStorage.removeItem('mvp_vocab_preset_applied_v36');
            // 先導向首頁，再重新載入
            window.location.hash = '#/';
            setTimeout(() => {
              window.location.reload();
            }, 100);
          }
        };
        const identityLabel = userSettings
          ? `${userSettings.stage === 'senior' ? '高中' : '國中'}・${userSettings.version}版`
          : '選擇教材版本';
        const handleIdentityClick = () => {
          // TODO: 開啟身分/教材版本選擇 Modal
          if (confirm('要切換或重新選擇教材版本嗎？')) {
            onUserSettingsChange(null);
          }
        };
        
        return (
          <div className="min-h-screen bg-gradient-to-b from-indigo-50 to-white">
            <header className="sticky top-0 z-10 bg-white/95 backdrop-blur-sm shadow-md">
              <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
                <div className="flex justify-between items-center h-16">
                  {/* Logo 和應用程式名稱 + 身分顯示 */}
                  <div className="flex items-center space-x-2 sm:space-x-3">
                    <svg className="h-7 w-7 sm:h-8 sm:w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                      <path strokeLinecap="round" strokeLinejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.253" />
                    </svg>
                    <a href="#/" className="text-lg sm:text-xl font-extrabold text-gray-900 tracking-tight">
                      WordGym 單字健身坊
                    </a>
                  </div>

                  {/* 桌面版身分切換與導航 */}
                  <div className="hidden md:flex items-center space-x-3">
                    <button
                      onClick={handleIdentityClick}
                      className="group inline-flex items-center gap-2 rounded-full border border-[#5A4FCF] bg-[#F3F0FF] px-3 py-2 text-sm font-semibold text-[#5A4FCF] shadow-sm transition duration-150 hover:bg-[#E7E0FF] focus:outline-none focus:ring-2 focus:ring-[#5A4FCF]/40"
                      title="切換教材版本"
                    >
                      <span className="flex items-center justify-center rounded-full bg-white/70 p-1 text-[#5A4FCF]">
                        <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v12m7-9H5m0 0 3-3m-3 3 3 3" />
                        </svg>
                      </span>
                      <span className="whitespace-nowrap">{identityLabel}</span>
                      <svg className="h-4 w-4 text-[#5A4FCF] transition-transform group-hover:translate-y-[1px]" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                        <path strokeLinecap="round" strokeLinejoin="round" d="m6 9 6 6 6-6" />
                      </svg>
                    </button>
                    <nav className="flex space-x-2 items-center">
                      <button 
                        onClick={() => setShowGuide(true)}
                        className="px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-600 hover:text-gray-800 text-sm font-medium transition duration-150 min-h-[44px] flex items-center"
                        title="查看系統使用指南"
                      >
                        [?] 訓練秘笈
                      </button>
                      <a 
                        href="#/favorites" 
                        className={`px-3 py-2 rounded-md text-sm font-medium transition duration-150 min-h-[44px] flex items-center ${
                          isActive("#/favorites") 
                            ? "text-indigo-600" 
                            : "text-gray-600 hover:text-indigo-600"
                        }`}
                      >
                        重點訓練
                      </a>
                      <a 
                        href="#/quiz" 
                        className={`px-3 py-2 rounded-md text-sm font-medium transition duration-150 min-h-[44px] flex items-center ${
                          isActive("#/quiz") 
                            ? "text-indigo-600" 
                            : "text-gray-600 hover:text-indigo-600"
                        }`}
                      >
                        實力驗收
                      </a>
                    </nav>
                  </div>

                  {/* 手機版漢堡選單按鈕 */}
                  <button
                    onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                    className="md:hidden p-2 rounded-lg hover:bg-gray-100 text-gray-600 hover:text-gray-800 transition min-h-[44px] min-w-[44px] flex items-center justify-center"
                    aria-label="選單"
                  >
                    {mobileMenuOpen ? (
                      <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    ) : (
                      <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                      </svg>
                    )}
                  </button>
                </div>

                {/* 手機版下拉選單 */}
                {mobileMenuOpen && (
                  <div className="md:hidden border-t border-gray-200 py-4">
                    <div className="flex flex-col space-y-2">
                      <button
                        onClick={handleIdentityClick}
                        className="inline-flex items-center gap-2 rounded-full border border-[#5A4FCF] bg-[#F3F0FF] px-3 py-2 text-sm font-semibold text-[#5A4FCF] shadow-sm transition duration-150 hover:bg-[#E7E0FF] focus:outline-none focus:ring-2 focus:ring-[#5A4FCF]/40"
                        title="切換教材版本"
                      >
                        <span className="flex items-center justify-center rounded-full bg-white/70 p-1 text-[#5A4FCF]">
                          <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v12m7-9H5m0 0 3-3m-3 3 3 3" />
                          </svg>
                        </span>
                        <span className="whitespace-nowrap">{identityLabel}</span>
                        <svg className="h-4 w-4 text-[#5A4FCF]" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                          <path strokeLinecap="round" strokeLinejoin="round" d="m6 9 6 6 6-6" />
                        </svg>
                      </button>
                      <button 
                        onClick={() => setShowGuide(true)}
                        className="px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-600 hover:text-gray-800 text-sm font-medium transition text-left"
                      >
                        [?] 訓練秘笈
                      </button>
                      <a 
                        href="#/favorites" 
                        className={`px-3 py-2 rounded-md text-sm font-medium transition text-left ${
                          isActive("#/favorites") 
                            ? "text-indigo-600" 
                            : "text-gray-600 hover:text-indigo-600"
                        }`}
                      >
                        重點訓練
                      </a>
                      <a 
                        href="#/quiz" 
                        className={`px-3 py-2 rounded-md text-sm font-medium transition text-left ${
                          isActive("#/quiz") 
                            ? "text-indigo-600" 
                            : "text-gray-600 hover:text-indigo-600"
                        }`}
                      >
                        實力驗收
                      </a>
                    </div>
                  </div>
                )}
              </div>
            </header>
            
            {/* 訓練秘笈 Modal */}
            {showGuide && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
                  {/* Modal Header */}
                  <div className="bg-indigo-600 text-white px-6 py-4 flex justify-between items-center">
                    <h2 className="text-2xl font-bold">WordGym 訓練秘笈</h2>
                    <button 
                      onClick={() => setShowGuide(false)}
                      className="text-white hover:text-indigo-200 text-2xl font-bold transition"
                      title="關閉"
                    >
                      ×
                    </button>
                  </div>
                  
                  {/* Modal Content */}
                  <div className="px-6 py-6 overflow-y-auto max-h-[calc(80vh-120px)]">
                    <div className="prose prose-indigo max-w-none">
                      <div className="space-y-6">
                        <section>
                          <h3 className="text-xl font-bold text-indigo-800 mb-3">歡迎來到 WordGym 單字健身坊！</h3>
                          <p className="text-gray-700 leading-relaxed">
                            讓我們一起陪您鍛鍊單字記憶肌肉，開啟高效學習之旅。
                          </p>
                          <p className="text-gray-700 leading-relaxed mt-2">
                            請先前往首頁，您可以依據「主題」、「詞性」或「Level」選擇想加強的項目，WordGym 會為您量身打造專屬訓練清單！
                          </p>
                        </section>
                        
                        <section>
                          <h4 className="text-lg font-semibold text-indigo-700 mb-3">探索單字庫</h4>
                          <div className="text-gray-700 leading-relaxed space-y-2">
                            <p>在單字清單中，點選任何一個單字，即可進入詳細學習頁面。這裡不僅包含單字、音標、英文例句和中文翻譯等基礎內容，若該單字曾於學測出現，我們也會提供相關例句。</p>
                            <p>更棒的是，您可以延伸學習同義字、反義字、易混淆字、相關片語、字根/字首/字尾等豐富知識，並能一鍵將這些寶貴資料複製，貼到您的個人筆記中！</p>
                          </div>
                        </section>
                        
                        <section>
                          <h4 className="text-lg font-semibold text-indigo-700 mb-3">重點訓練與複習</h4>
                          <div className="text-gray-700 leading-relaxed">
                            <ul className="list-disc pl-5 space-y-2">
                              <li><strong>單字收錄：</strong> 如果遇到容易遺忘的單字，請點擊「重點訓練」，將其收錄以加強練習。</li>
                              <li><strong>單字移除：</strong> 若您確認已完全掌握該單字，點擊「移除」即可將其從清單中隱藏。</li>
                            </ul>
                          </div>
                        </section>
                        
                        <section>
                          <h4 className="text-lg font-semibold text-indigo-700 mb-3">實力驗收</h4>
                          <div className="text-gray-700 leading-relaxed space-y-2">
                            <p>「實力驗收」提供兩種測驗方式：選擇題和閃卡（中翻英、英翻中），幫助您即時檢視學習成果。</p>
                            <ul className="list-disc pl-5 space-y-2">
                              <li><strong>測驗回饋：</strong> 您可以從測驗結果了解答題狀況，並能直接從錯題記錄點回單字頁面，進行強化複習！</li>
                              <li><strong>歷程記錄：</strong> 每一次的測驗結果都會被自動記錄，系統最多保留50筆測驗紀錄。</li>
                            </ul>
                          </div>
                        </section>
                        
                        <section className="bg-amber-50 border-l-4 border-amber-400 p-4 rounded">
                          <h4 className="text-lg font-semibold text-amber-800 mb-2">特別提醒</h4>
                          <p className="text-gray-700 leading-relaxed">
                            請留意，所有的測驗紀錄是儲存在您<strong>當前使用的載具（裝置）</strong>中，而非個人帳號內。因此，若您更換不同的手機、平板或電腦，每個載具都會留下各自獨立的紀錄喔！
                          </p>
                        </section>
                        
                        <section className="text-center pt-4">
                          <p className="text-indigo-600 font-semibold text-lg">立即啟動您的單字訓練計畫吧！</p>
                        </section>
                      </div>
                    </div>
                  </div>
                  
                  {/* Modal Footer */}
                  <div className="bg-gray-50 px-6 py-4 flex justify-end">
                    <button 
                      onClick={() => setShowGuide(false)}
                      className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium transition"
                    >
                      知道了
                    </button>
                  </div>
                </div>
              </div>
            )}
            
            <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
              {children}
              {route !== "quiz" && (
                <footer className="mt-12 bg-gradient-to-r from-gray-50 to-gray-100 rounded-2xl border border-gray-200 p-8">
                  <div className="max-w-3xl mx-auto">
                    <h3 className="text-xl font-bold text-gray-800 mb-2">WordGym 單字健身坊</h3>
                    <p className="text-base text-gray-700 font-medium mb-4">將學習變成一場互動式的學習旅程！</p>
                    <p className="text-sm text-gray-700 leading-relaxed mb-6">
                      我們提供個人化的單字庫與遊戲化的練習模式，讓您隨時隨地都能高效複習。透過清晰的學習路徑，讓您清楚掌握弱點、看見進步，輕鬆累積單字實力，自信迎接大考。
                    </p>
                    <div className="text-sm text-gray-600 border-t border-gray-300 pt-4">
                      <p>© <a href="https://www.junyiacademy.org/" target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:underline">均一教育平台</a></p>
                    </div>
                  </div>
                </footer>
              )}
            </div>
          </div>
        );
      };

      // 歡迎登入頁 Modal
      const WelcomeModal = ({ data, userSettings, setUserSettings, onClose }) => {
        const [selectedStage, setSelectedStage] = useState('senior');
        const [selectedVersion, setSelectedVersion] = useState('');
        
        // 根據選定的學程顯示對應的版本選項
        const availableVersions = useMemo(() => {
          // 定義各學程的可用版本
          const seniorVersions = ['龍騰', '三民']; // 高中
          const juniorVersions = ['康軒', '翰林', '南一']; // 國中
          
          // 如果已選擇學程，直接返回對應的版本列表
          if (selectedStage === 'senior') {
            return seniorVersions;
          } else if (selectedStage === 'junior') {
            return juniorVersions;
          }
          
          // 如果尚未選擇學程，返回空陣列
          return [];
        }, [selectedStage]);
        
        // 當選擇學程改變時，清空已選擇的版本
        useEffect(() => {
          setSelectedVersion('');
        }, [selectedStage]);
        
        const handleConfirm = () => {
          if (selectedStage && selectedVersion) {
            setUserSettings({
              stage: selectedStage,
              version: selectedVersion
            });
            if (onClose) onClose();
          }
        };
        
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
            <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
              <h2 className="text-2xl font-bold text-gray-900 mb-4">歡迎來到 WordGym！</h2>
              <p className="text-gray-600 mb-6">請選擇您的學程和使用的課本版本</p>
              
              <div className="space-y-6">
                {/* 學程選擇 */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">學程</label>
                  <div className="flex gap-3">
                    <button
                      onClick={() => setSelectedStage('senior')}
                      className={`flex-1 px-4 py-3 rounded-xl font-medium transition ${
                        selectedStage === 'senior'
                          ? 'bg-indigo-600 text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      高中
                    </button>
                    <button
                      onClick={() => setSelectedStage('junior')}
                      className={`flex-1 px-4 py-3 rounded-xl font-medium transition ${
                        selectedStage === 'junior'
                          ? 'bg-indigo-600 text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      國中
                    </button>
                  </div>
                </div>
                
                {/* 版本選擇 */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">課本版本</label>
                  {!selectedStage ? (
                    <div className="px-4 py-3 rounded-xl border border-gray-300 bg-gray-50 text-gray-500">
                      請先選擇學程
                    </div>
                  ) : availableVersions.length > 0 ? (
                    <select
                      value={selectedVersion}
                      onChange={(e) => setSelectedVersion(e.target.value)}
                      className="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    >
                      <option value="">請選擇版本</option>
                      {availableVersions.map(version => (
                        <option key={version} value={version}>{version}</option>
                      ))}
                    </select>
                  ) : (
                    <div className="px-4 py-3 rounded-xl border border-red-300 bg-red-50 text-red-600">
                      無法載入版本列表
                    </div>
                  )}
                </div>
              </div>
              
              <div className="mt-6 flex gap-3">
                <Button
                  variant="primary"
                  onClick={handleConfirm}
                  disabled={!selectedStage || !selectedVersion}
                  className="flex-1"
                >
                  確認
                </Button>
              </div>
            </div>
          </div>
        );
      };

      const Home = ({ push, data, onImport, userSettings, currentTab, setCurrentTab, filters, updateFilter, quickFilterPos, setQuickFilterPos }) => {
        const [isLoading, setIsLoading] = useState(false);
        const [loadError, setLoadError] = useState(null);
        const [q, setQ] = useState("");
        
        // 自動載入 Google Sheets
        useEffect(() => {
          const autoLoad = async () => {
            console.log('=== 自動載入檢查 ===');
            console.log('目前資料數量:', data.length);
            console.log('Google Sheets 啟用:', GOOGLE_SHEET_CONFIG.enabled);
            
            if (data.length > 0) {
              console.log('已有資料，跳過載入');
              return;
            }
            if (!GOOGLE_SHEET_CONFIG.enabled) {
              console.log('Google Sheets 未啟用');
              return;
            }
            
            console.log('開始載入 Google Sheets...');
            setIsLoading(true);
            setLoadError(null);
            
            try {
              const results = await loadAllGoogleSheets();
              console.log('載入結果:', results);
              for (const { rows, theme } of results) {
                console.log(`匯入 ${rows.length} 筆資料，主題:`, theme);
                
                // 調試：檢查第一筆資料的欄位名稱和實際值
                if (rows.length > 0) {
                  console.log('=== 資料欄位檢查 (TSV 解析後) ===');
                  console.log('第一筆資料的所有欄位:', Object.keys(rows[0]));
                  console.log('第一筆資料的完整內容:', rows[0]);
                  console.log('第一筆資料的 stage 相關欄位:', {
                    'stage': rows[0]['stage'],
                    'Stage': rows[0]['Stage'],
                    'STAGE': rows[0]['STAGE'],
                    '學程': rows[0]['學程']
                  });
                  // 檢查第一欄的值（根據表格結構，stage 應該是第一欄）
                  const firstKey = Object.keys(rows[0])[0];
                  const firstValue = rows[0][firstKey];
                  console.log(`第一欄的鍵名: "${firstKey}", 值: "${firstValue}"`);
                  console.log('第一筆資料的 english_word 相關欄位:', {
                    'word': rows[0]['word'],
                    'english_word': rows[0]['english_word'],
                    '英文': rows[0]['英文'],
                    '英文單字': rows[0]['英文單字']
                  });
                  
                  // 找出所有包含 "stage" 或 "英文" 的欄位名稱
                  const stageLikeKeys = Object.keys(rows[0]).filter(k => 
                    k.toLowerCase().includes('stage') || k.includes('學程') || k.includes('stage')
                  );
                  const englishLikeKeys = Object.keys(rows[0]).filter(k => 
                    k.toLowerCase().includes('english') || k.toLowerCase().includes('word') || k.includes('英文')
                  );
                  console.log('所有包含 "stage" 的欄位:', stageLikeKeys);
                  console.log('所有包含 "english/word" 的欄位:', englishLikeKeys);
                  // 檢查前幾筆資料的 stage 值（詳細調試）
                  const sampleStages = rows.slice(0, 10).map(r => {
                    const rawStage = r['stage'] || r['Stage'] || r['STAGE'] || r['學程'] || '';
                    return {
                      english: (r.word || r['word'] || r['english_word'] || r['英文'] || r['英文單字'] || '').trim(),
                      stage_raw: rawStage,
                      stage_trimmed: rawStage.trim(),
                      stage_length: rawStage.length,
                      stage_charCodes: Array.from(rawStage).map(c => c.charCodeAt(0)),
                      has_stage_key: 'stage' in r,
                      has_Stage_key: 'Stage' in r,
                      has_STAGE_key: 'STAGE' in r,
                      has_學程_key: '學程' in r
                    };
                  });
                  console.log('前 10 筆資料的 stage 詳細資訊:', sampleStages);
                  
                  // 統計所有資料的 stage 值分布（包括沒有 english 的行）
                  const stageDistribution = {};
                  const stageWithEnglish = {};
                  const stageWithoutEnglish = {};
                  const emptyStageSamples = []; // 收集 stage 為空但有英文單字的樣本
                  
                  // 找出 stage 欄位的實際名稱（從第一行標題中查找）
                  let stageKeyNameForStats = null;
                  if (rows.length > 0) {
                    const firstRowKeys = Object.keys(rows[0]);
                    // 優先查找精確匹配
                    for (const key of ['stage', 'Stage', 'STAGE', '學程']) {
                      if (firstRowKeys.includes(key)) {
                        stageKeyNameForStats = key;
                        break;
                      }
                    }
                    // 如果找不到，嘗試大小寫不敏感匹配
                    if (!stageKeyNameForStats) {
                      for (const key of firstRowKeys) {
                        const keyLower = key.toLowerCase().trim();
                        if (keyLower === 'stage' || key === '學程') {
                          stageKeyNameForStats = key;
                          break;
                        }
                      }
                    }
                    // 如果還是找不到，假設第一欄就是 stage
                    if (!stageKeyNameForStats && firstRowKeys.length > 0) {
                      stageKeyNameForStats = firstRowKeys[0];
                    }
                  }
                  
                  rows.forEach((r, rIndex) => {
                    // 嘗試所有可能的 stage 欄位名稱（使用與解析邏輯相同的方法）
                    let rawStage = '';
                    
                    // 方法1：使用找到的欄位名稱
                    if (stageKeyNameForStats && r[stageKeyNameForStats] !== undefined && r[stageKeyNameForStats] !== null) {
                      rawStage = String(r[stageKeyNameForStats]).trim();
                    }
                    
                    // 方法2：如果方法1失敗，嘗試所有可能的欄位名稱
                    if (!rawStage) {
                      const possibleStageKeys = ['stage', 'Stage', 'STAGE', '學程'];
                      for (const key of possibleStageKeys) {
                        if (r[key] !== undefined && r[key] !== null && String(r[key]).trim() !== '') {
                          rawStage = String(r[key]).trim();
                          break;
                        }
                      }
                    }
                    
                    // 方法3：如果還是找不到，嘗試大小寫不敏感匹配
                    if (!rawStage) {
                      for (const key in r) {
                        const keyLower = key.toLowerCase().trim();
                        if ((keyLower === 'stage' || key === '學程') && r[key] !== undefined && r[key] !== null && String(r[key]).trim() !== '') {
                          rawStage = String(r[key]).trim();
                          break;
                        }
                      }
                    }
                    
                    // 方法4：最後的備用方案 - 直接使用第一欄
                    if (!rawStage && Object.keys(r).length > 0) {
                      const firstKey = Object.keys(r)[0];
                      const firstValue = r[firstKey];
                      if (firstValue && String(firstValue).trim() !== '') {
                        const firstValueStr = String(firstValue).trim();
                        if (firstValueStr.includes('國中') || firstValueStr.includes('高中') || firstValueStr === '國中' || firstValueStr === '高中') {
                          rawStage = firstValueStr;
                        }
                      }
                    }
                    
                    const english = (r.word || r['word'] || r['english_word'] || r['英文'] || r['英文單字'] || r.word_lower || '').trim();
                    stageDistribution[rawStage || ''] = (stageDistribution[rawStage || ''] || 0) + 1;
                    if (english) {
                      stageWithEnglish[rawStage || ''] = (stageWithEnglish[rawStage || ''] || 0) + 1;
                      // 如果 stage 為空但有英文單字，收集樣本
                      if (!rawStage && emptyStageSamples.length < 5) {
                        emptyStageSamples.push({
                          english: english,
                          allKeys: Object.keys(r),
                          stage_values: {
                            'stage': r['stage'],
                            'Stage': r['Stage'],
                            'STAGE': r['STAGE'],
                            '學程': r['學程']
                          }
                        });
                      }
                    } else {
                      stageWithoutEnglish[rawStage || ''] = (stageWithoutEnglish[rawStage || ''] || 0) + 1;
                    }
                  });
                  console.log('所有資料的 stage 值分布:', stageDistribution);
                  console.log('有英文單字的 stage 分布:', stageWithEnglish);
                  console.log('沒有英文單字的 stage 分布:', stageWithoutEnglish);
                  console.log('總行數:', rows.length, '有英文單字的行數:', Object.values(stageWithEnglish).reduce((a, b) => a + b, 0));
                  if (emptyStageSamples.length > 0) {
                    console.log('=== stage 為空但有英文單字的樣本 ===');
                    console.log('這些資料的 stage 欄位讀不到，可能是欄位名稱不匹配:', emptyStageSamples);
                  }
                }
                
                // 解析資料，將原始 CSV rows 轉換為正確格式
                const aggregated = [];
                const defaultTheme = theme || '';
                let juniorCount = 0;
                let seniorCount = 0;
                let nullStageCount = 0;
                
                // 如果 Google Sheet 配置中指定了 theme，直接使用該 theme 對應的 stage
                // junior_high -> junior, highschool_climate -> senior
                const defaultStage = theme === 'junior_high' ? 'junior' : (theme === 'highschool_climate' ? 'senior' : null);
                
                // 調試：統計原始資料中 stage 欄位的分布
                const rawStageStats = {
                  has_stage_key: 0,
                  stage_empty: 0,
                  stage_國中: 0,
                  stage_高中: 0,
                  stage_other: 0
                };
                rows.slice(0, 100).forEach((r, idx) => {
                  if ('stage' in r) {
                    rawStageStats.has_stage_key++;
                    const stageVal = String(r['stage'] || '').trim();
                    if (!stageVal) {
                      rawStageStats.stage_empty++;
                    } else if (stageVal === '國中' || stageVal.includes('國中')) {
                      rawStageStats.stage_國中++;
                    } else if (stageVal === '高中' || stageVal.includes('高中')) {
                      rawStageStats.stage_高中++;
                    } else {
                      rawStageStats.stage_other++;
                      if (rawStageStats.stage_other <= 5) {
                        console.log(`前100筆中，第${idx + 1}筆的 stage 值不是預期格式:`, stageVal);
                      }
                    }
                  }
                });
                console.log('=== 前100筆資料的原始 stage 欄位統計 ===', rawStageStats);
                if (defaultStage) {
                  console.log(`Google Sheet 配置的 theme 為 "${theme}"，預設 stage 為 "${defaultStage}"`);
                }
                
                // 找出 stage 欄位的實際名稱（從第一行標題中查找）
                let stageKeyName = null;
                if (rows.length > 0) {
                  const firstRowKeys = Object.keys(rows[0]);
                  // 優先查找精確匹配
                  for (const key of ['stage', 'Stage', 'STAGE', '學程']) {
                    if (firstRowKeys.includes(key)) {
                      stageKeyName = key;
                      break;
                    }
                  }
                  // 如果找不到，嘗試大小寫不敏感匹配
                  if (!stageKeyName) {
                    for (const key of firstRowKeys) {
                      const keyLower = key.toLowerCase().trim();
                      if (keyLower === 'stage' || key === '學程') {
                        stageKeyName = key;
                        break;
                      }
                    }
                  }
                  // 如果還是找不到，假設第一欄就是 stage（根據表格結構）
                  if (!stageKeyName && firstRowKeys.length > 0) {
                    stageKeyName = firstRowKeys[0];
                    console.log('警告：找不到 stage 欄位，使用第一欄作為 stage:', stageKeyName);
                  }
                }
                
                rows.forEach((row, rowIndex) => {
                  // 如果 Google Sheet 配置中指定了 theme，直接使用對應的 stage
                  let stage = defaultStage;
                  let stageRaw = ''; // 用於調試和警告訊息
                  
                  // 只有在沒有預設 stage 的情況下，才嘗試從 stage 欄位解析
                  if (!stage) {
                    // 先解析 stage 欄位（在檢查 english 之前，這樣即使沒有 english 也能記錄 stage）
                    // 直接使用 'stage' 欄位（從截圖確認欄位名稱是 "stage"）
                    
                    // 優先使用 'stage' 欄位（最直接的方式）
                    if (row['stage'] !== undefined && row['stage'] !== null) {
                      stageRaw = String(row['stage']);
                    }
                    // 如果 'stage' 欄位不存在或為空，嘗試其他可能的欄位名稱
                    else if (row['Stage'] !== undefined && row['Stage'] !== null) {
                      stageRaw = String(row['Stage']);
                    }
                    else if (row['STAGE'] !== undefined && row['STAGE'] !== null) {
                      stageRaw = String(row['STAGE']);
                    }
                    else if (row['學程'] !== undefined && row['學程'] !== null) {
                      stageRaw = String(row['學程']);
                    }
                    // 最後的備用方案：使用第一欄（如果值看起來像 stage）
                    else if (Object.keys(row).length > 0) {
                      const firstKey = Object.keys(row)[0];
                      const firstValue = row[firstKey];
                      if (firstValue && String(firstValue).trim() !== '') {
                        const firstValueStr = String(firstValue).trim();
                        if (firstValueStr.includes('國中') || firstValueStr.includes('高中')) {
                          stageRaw = firstValueStr;
                        }
                      }
                    }
                    
                    // 清理：去除前後空格、換行符、不可見字符
                    if (stageRaw) {
                      stageRaw = String(stageRaw).replace(/^[\s\uFEFF\u200B-\u200D\u2060]+|[\s\uFEFF\u200B-\u200D\u2060]+$/g, '').trim();
                    } else {
                      stageRaw = '';
                    }
                    
                    // 使用更寬鬆的匹配，處理可能的變體
                    if (stageRaw) {
                      const stageNormalized = stageRaw.replace(/\s+/g, ''); // 移除所有空格
                      
                      // 更寬鬆的匹配：包含「高中」或「國中」即可
                      if (stageNormalized.includes('高中') || stageRaw.includes('高中')) {
                        stage = 'senior';
                      } else if (stageNormalized.includes('國中') || stageRaw.includes('國中')) {
                        stage = 'junior';
                      }
                    }
                  }
                  
                  // 調試：記錄前 10 筆資料的 stage 解析過程（只有在沒有預設 stage 時才顯示）
                  if (!defaultStage && rowIndex < 10) {
                    console.log(`第${rowIndex + 1}筆資料 stage 解析:`, {
                      'row[stage]': row['stage'],
                      'stageKeyName': stageKeyName,
                      'stageRaw_after_methods': stageRaw,
                      'stage_final': stage,
                      'english': (row.word || row['word'] || row['english_word'] || row['英文'] || row['英文單字'] || '').trim().substring(0, 20)
                    });
                  }
                  
                  // 解析英文單字欄位：嘗試多種可能的欄位名稱
                  const english = (row.word || row['word'] || row['english_word'] || row['英文'] || row['英文單字'] || row.word_lower || '').trim();
                  
                  // 如果沒有英文單字，跳過（但已經記錄了 stage）
                  if (!english) {
                    // 如果沒有英文單字但有 stage，記錄下來（用於調試）
                    if (stage) {
                      // 這些資料會被跳過，但 stage 已經被統計了
                    }
                    return;
                  }
                  
                  // 統計 stage（只有在有英文單字的情況下才統計到最終結果）
                  if (stage === 'senior') {
                    seniorCount++;
                  } else if (stage === 'junior') {
                    juniorCount++;
                  } else if (!defaultStage && stageRaw) {
                    // 只有在沒有預設 stage 且 stage 欄位有值但不是預期的格式時，才記錄警告
                    if (nullStageCount < 20) {
                      console.warn(`未知的 stage 值: "${stageRaw}" (長度: ${stageRaw.length}, 字符碼: ${Array.from(stageRaw).map(c => c.charCodeAt(0)).join(',')}, 單字: ${english})`);
                    }
                    nullStageCount++;
                  } else if (!defaultStage) {
                    nullStageCount++;
                  }
                  
                  // 解析 theme_index 欄位
                  // 國中模式：格式 "1200-family | 800-family"，需要解析成 theme_index 陣列
                  // 高中模式：直接使用主題值，不需要解析 range-theme 格式
                  const themeIndexRaw = (row['主題'] || row['theme'] || row['themes'] || row['Theme'] || row['THEME'] || row['THEMES'] || row['主題分類'] || row['主題標籤'] || row['主題標記'] || '').trim();
                  const themeIndex = [];
                  
                  if (themeIndexRaw && stage === 'junior') {
                    // 國中模式：解析 "1200-family | 800-family" 格式
                    // 支援分號或管道符號分隔多個項目
                    const items = themeIndexRaw.split(/[;|]/).map(s => s.trim()).filter(Boolean);
                    items.forEach(item => {
                      // 格式：range-theme（例如：1200-family, 800-family）
                      const parts = item.split('-').map(s => s.trim());
                      if (parts.length >= 2) {
                        const range = parts[0].trim(); // 1200 或 800
                        const theme = parts.slice(1).join('-').trim(); // family 或其他主題（處理主題本身可能包含「-」的情況）
                        // 檢查 range 是否為數字（1200 或 800）
                        if (/^\d+$/.test(range) && theme) {
                          themeIndex.push({
                            range: range,  // 1200 或 800
                            theme: theme   // family 或其他主題
                          });
                        }
                      }
                    });
                  }
                  
                  // 保留原有的 themes 欄位邏輯
                  // 高中模式：直接使用主題值
                  // 國中模式：如果沒有解析到 theme_index，也使用主題值作為備用
                  let themes = [];
                  if (stage === 'senior') {
                    // 高中模式：直接使用主題值
                    themes = mergeThemes(row.themes, themeIndexRaw, defaultTheme);
                  } else {
                    // 國中模式：如果有 theme_index，從中提取主題；否則使用原始主題值
                    if (themeIndex.length > 0) {
                      const themeSet = new Set();
                      themeIndex.forEach(item => {
                        if (item.theme) themeSet.add(item.theme);
                      });
                      themes = Array.from(themeSet);
                      if (themes.length === 0) {
                        themes = mergeThemes(row.themes, defaultTheme);
                      }
                    } else {
                      themes = mergeThemes(row.themes, themeIndexRaw, defaultTheme);
                    }
                  }
                  const primaryTheme = themes.length ? themes[0] : defaultTheme;
                  
                  // 除錯：檢查主題欄位（前 10 筆資料，以及第 6070-6080 筆資料）
                  const shouldDebug = aggregated.length < 10 || (aggregated.length >= 6070 && aggregated.length < 6080);
                  if (shouldDebug) {
                    console.log(`單字 "${english}" (第 ${aggregated.length + 1} 筆) 的主題欄位值:`, {
                      'row[主題]': row['主題'],
                      'row[theme]': row['theme'],
                      'stage': stage,
                      'themeIndexRaw': themeIndexRaw,
                      'themeIndex': themeIndex,
                      'themes': themes,
                      'primaryTheme': primaryTheme,
                      'hasThemeIndex': themeIndex.length > 0
                    });
                  }
                  
                  // 解析 textbook_index 欄位
                  const textbookIndexRaw = (row['textbook_index'] || row['textbookIndex'] || row['課本索引'] || '').trim();
                  const textbookIndex = [];
                  if (textbookIndexRaw) {
                    const items = textbookIndexRaw.split(';').map(s => s.trim()).filter(Boolean);
                    items.forEach(item => {
                      const parts = item.split('-').map(s => s.trim());
                      // 國中和高中都使用相同的格式：版本-冊次-課次（例如：康軒-B1-U1 或 龍騰-B1-U1）
                      if (parts.length >= 3) {
                        textbookIndex.push({
                          version: parts[0], // 版本：康軒、龍騰等
                          vol: parts[1],     // 冊次：B1, B2 等
                          lesson: parts[2]   // 課次：U1, U2, L1, L2 等
                        });
                      } else if (parts.length === 2) {
                        // 備用格式：可能是 range-主題（例如：1200-家庭），但這種格式不應該用於課本進度模式
                        // 這種格式應該用於主題探索模式
                        // 這裡先不解析，避免混淆
                      }
                    });
                  }
                  
                  // 解析 exam_tags 欄位
                  const examTagsRaw = (row['exam_tags'] || '').trim();
                  const examTags = examTagsRaw 
                    ? examTagsRaw.split(';').map(s => s.trim()).filter(Boolean)
                    : [];
                  
                  aggregated.push({
                    english_word: english,
                    kk_phonetic: row['KK音標'] || row['KK'] || '',
                    chinese_definition: row['中譯'] || row['definition'] || row['鍾意'] || '',
                    example_sentence: row['例句'] || row['sentence'] || row['ai例句'] || row['example_sentence'] || '',
                    example_translation: row['翻譯'] || row['translation'] || row['ai例句中譯'] || row['example_translation'] || '',
                    example_sentence_2: row['例句2'] || row['例句_2'] || row['sentence2'] || row['GSAT_Example_Sentence_1'] || row['example_sentence_2'] || '',
                    example_translation_2: row['翻譯2'] || row['翻譯_2'] || row['translation2'] || row['GSAT_Translation_1'] || row['example_translation_2'] || '',
                    example_sentence_3: row['例句3'] || row['例句_3'] || row['sentence3'] || row['example_sentence_3'] || '',
                    example_translation_3: row['翻譯3'] || row['翻譯_3'] || row['translation3'] || row['example_translation_3'] || '',
                    example_sentence_4: row['例句4'] || row['例句_4'] || row['sentence4'] || row['example_sentence_4'] || '',
                    example_translation_4: row['翻譯4'] || row['翻譯_4'] || row['translation4'] || row['example_translation_4'] || '',
                    example_sentence_5: row['例句5'] || row['例句_5'] || row['sentence5'] || row['example_sentence_5'] || '',
                    example_translation_5: row['翻譯5'] || row['翻譯_5'] || row['translation5'] || row['example_translation_5'] || '',
                    example_source_2: (() => {
                      const year = row['Year_1'] || row['N'] || '';
                      const part = row['Part_1'] || row['O'] || '';
                      const source = row['Source_1'] || row['P'] || '';
                      if (year && part && source) {
                        return `${year}\t${part}\t${source}`;
                      }
                      return '';
                    })(),
                    grammar_main_category: row['詞性'] || row['副詞'] || row['pos'] || '',
                    grammar_sub_category: row['詞性分類'] || row['子分類'] || row['subcat'] || '',
                    theme: primaryTheme || '',
                    themes,
                    default_theme: defaultTheme,
                    level: row['level'] || row['Level'] || row['LEVEL'] || '',
                    cefr: row['CEFR'] || row['cefr'] || '',
                    word_forms: row['詞性變化'] || row['詞形變化'] || row['詞形說明'] || row['word_forms'] || '',
                    derivatives: row['衍生詞'] || row['derivatives'] || '',
                    synonyms: row['同義字'] || row['synonyms'] || '',
                    antonyms: row['反義字'] || row['antonyms'] || '',
                    confusables: row['易混淆字'] || row['confusables'] || '',
                    phrases: (row['片語'] || row['phrases'] || '').split(/[;；]/).map(p => p.trim()).filter(p => p),
                    word_forms_detail: row['word_forms_detail'],
                    affix_info: {
                      prefix: row['字首'] || row['prefix'] || '',
                      root: row['字根'] || row['root'] || '',
                      suffix: row['字尾'] || row['suffix'] || '',
                      meaning: row['意思'] || row['meaning'] || '',
                      example: row['例子'] || row['example'] || ''
                    },
                    // 新增的欄位
                    stage: stage,
                    textbook_index: textbookIndex,
                    exam_tags: examTags,
                    theme_index: themeIndex,  // 主題索引陣列，格式：[{range: '1200', theme: 'family'}, ...]
                    videoUrl: row['videoUrl'] || row['video_url'] || row['video'] || row['影片連結'] || row['影片'] || row['Video URL'] || row['Video'] || row['VIDEO_URL'] || row['VIDEO'] || ''
                  });
                });
                
                // 顯示統計資訊
                console.log('=== 資料載入統計 ===');
                console.log(`總共解析 ${aggregated.length} 筆資料`);
                console.log(`國中 (junior): ${juniorCount} 筆`);
                console.log(`高中 (senior): ${seniorCount} 筆`);
                console.log(`未指定 stage: ${nullStageCount} 筆`);
                
                // 檢查前幾筆資料的 stage 設定
                if (aggregated.length > 0) {
                  console.log('=== 前 5 筆資料的 stage 檢查 ===');
                  aggregated.slice(0, 5).forEach((w, idx) => {
                    console.log(`第 ${idx + 1} 筆 (${w.english_word}):`, {
                      stage: w.stage,
                      theme_index: w.theme_index,
                      hasStage: !!w.stage
                    });
                  });
                } else {
                  console.warn('⚠️ 警告：資料載入後數量為 0！');
                }
                
                // 使用解析後的資料
                onImport(aggregated, { overrideExamples: false, replace: false });
              }
              console.log('載入完成！');
            } catch (error) {
              console.error('載入失敗:', error);
              setLoadError(error.message);
            } finally {
              setIsLoading(false);
            }
          };
          
          autoLoad();
        }, []);
        
        // 取得主題列表（用於主題模式的下拉選單）
        const themes = useMemo(() => {
          const themeSet = new Set();
          
          if (!data || !Array.isArray(data) || data.length === 0) {
            return [];
          }
          
          // 取得當前選擇的 range（1200 或 800）
          const currentRange = filters.theme?.range || '';
          
          if (userSettings?.stage === 'junior') {
            // 國中：從 theme_index 陣列提取主題
            let themeIndexCount = 0;
            let themeIndexWithDataCount = 0;
            data.forEach((w, idx) => {
              const themeIndex = Array.isArray(w.theme_index) ? w.theme_index : [];
              themeIndexCount++;
              if (themeIndex.length > 0) {
                themeIndexWithDataCount++;
                // 除錯：檢查前幾個有 theme_index 的資料
                if (themeIndexWithDataCount <= 5) {
                  console.log(`國中模式 - 第 ${idx + 1} 筆資料 (${w.english_word}) 有 theme_index:`, themeIndex);
                }
                themeIndex.forEach(item => {
                  if (!item || !item.range || !item.theme) return;
                  
                  // 如果選擇了 range，只提取符合該 range 的主題
                  if (currentRange) {
                    if (item.range === currentRange) {
                      themeSet.add(item.theme);
                    }
                  } else {
                    // 如果沒有選擇 range，提取所有主題
                    themeSet.add(item.theme);
                  }
                });
              }
            });
            console.log(`國中模式主題提取統計: 總資料 ${data.length} 筆, 有 theme_index 的資料 ${themeIndexWithDataCount} 筆, 提取到的主題 ${themeSet.size} 個`);
          } else if (userSettings?.stage === 'senior') {
            // 高中：從 theme_index 陣列或 theme/themes 欄位提取主題
            let themeIndexCount = 0;
            let themeIndexWithDataCount = 0;
            let themesFieldCount = 0;
            data.forEach((w, idx) => {
              const themeIndex = Array.isArray(w.theme_index) ? w.theme_index : [];
              themeIndexCount++;
              if (themeIndex.length > 0) {
                themeIndexWithDataCount++;
                // 除錯：檢查前幾個有 theme_index 的資料
                if (themeIndexWithDataCount <= 5) {
                  console.log(`高中模式 - 第 ${idx + 1} 筆資料 (${w.english_word}) 有 theme_index:`, themeIndex);
                }
                // 優先使用 theme_index
                themeIndex.forEach(item => {
                  if (item && item.theme && item.theme !== 'general') {
                    themeSet.add(item.theme);
                  }
                });
              } else {
                // 向後相容：從 theme/themes 欄位提取
                const wordThemes = getWordThemes(w);
                if (wordThemes.length > 0) {
                  themesFieldCount++;
                  // 除錯：檢查前幾個有 themes 欄位的資料
                  if (themesFieldCount <= 5) {
                    console.log(`高中模式 - 第 ${idx + 1} 筆資料 (${w.english_word}) 有 themes 欄位:`, wordThemes);
                  }
                }
                wordThemes.forEach(t => {
                  if (t && t !== 'general') {
                    themeSet.add(t);
                  }
                });
              }
            });
            console.log(`高中模式主題提取統計: 總資料 ${data.length} 筆, 有 theme_index 的資料 ${themeIndexWithDataCount} 筆, 有 themes 欄位的資料 ${themesFieldCount} 筆, 提取到的主題 ${themeSet.size} 個`);
          } else {
            // 如果還沒有設定 stage，同時提取兩種格式的主題
            data.forEach(w => {
              // 優先從 theme_index 提取
              const themeIndex = Array.isArray(w.theme_index) ? w.theme_index : [];
              if (themeIndex.length > 0) {
                themeIndex.forEach(item => {
                  if (item && item.theme) {
                    themeSet.add(item.theme);
                  }
                });
              } else {
                // 向後相容：從 theme/themes 欄位提取
                const wordThemes = getWordThemes(w);
                wordThemes.forEach(t => {
                  if (t && t !== 'general') {
                    themeSet.add(t);
                  }
                });
              }
            });
          }
          
          const themeList = Array.from(themeSet).sort();
          
          // 調試：顯示提取到的主題
          if (userSettings?.stage === 'junior' && themeList.length === 0 && data.length > 0) {
            console.log('=== 主題提取調試 ===');
            console.log('選擇的 range:', currentRange);
            console.log('資料總數:', data.length);
            // 檢查前幾筆資料的 theme_index
            data.slice(0, 10).forEach((w, idx) => {
              console.log(`第 ${idx + 1} 筆資料 (${w.english_word}):`, {
                theme_index: w.theme_index,
                themes: w.themes,
                theme: w.theme
              });
            });
          }
          
          return themeList;
        }, [data, userSettings?.stage, filters.theme?.range]);

        // 使用新的篩選邏輯
        const filtered = useMemo(() => {
          let filteredData = getFilteredWords(data, userSettings, currentTab, filters, quickFilterPos);
          
          // 調試：顯示篩選結果
          if (filteredData.length === 0 && data.length > 0) {
            console.log('=== 篩選調試 ===');
            console.log('資料總數:', data.length);
            console.log('userSettings:', userSettings);
            console.log('currentTab:', currentTab);
            console.log('filters:', JSON.stringify(filters, null, 2));
            console.log('quickFilterPos:', quickFilterPos);
            
            // 檢查前幾筆資料的詳細資訊
            const sample = data.slice(0, 5);
            sample.forEach((w, idx) => {
              console.log(`第 ${idx + 1} 筆資料 (${w.english_word}):`, {
                stage: w.stage,
                level: w.level,
                theme: w.theme,
                themes: w.themes,
                theme_index: w.theme_index,
                textbook_index: w.textbook_index,
                exam_tags: w.exam_tags,
                posTags: w.posTags
              });
            });
            
            // 檢查經過 Stage Filter 後的資料
            const afterStageFilter = data.filter(w => {
              if (userSettings && userSettings.stage) {
                return w.stage === userSettings.stage;
              }
              return true;
            });
            console.log('經過 Stage Filter 後的資料數量:', afterStageFilter.length);
            
            // 如果是主題模式，檢查符合 range 的資料
            if (currentTab === 'theme' && filters.theme?.range) {
              const afterRangeFilter = afterStageFilter.filter(w => {
                if (userSettings?.stage === 'junior') {
                  // 國中：使用 theme_index 陣列
                  const themeIndex = Array.isArray(w.theme_index) ? w.theme_index : [];
                  return themeIndex.some(item => item && item.range === filters.theme.range);
                } else {
                  // 高中：使用 level 欄位
                  return String(w.level || '').trim() === filters.theme.range;
                }
              });
              console.log('經過 Range Filter 後的資料數量:', afterRangeFilter.length);
              if (afterRangeFilter.length > 0) {
                console.log('符合 Range 的前 3 筆資料:', afterRangeFilter.slice(0, 3).map(w => ({
                  english_word: w.english_word,
                  level: w.level
                })));
              }
            }
          }
          
          // 搜尋功能
          const s = q.trim().toLowerCase();
          if (s) {
            filteredData = filteredData.filter(w => w.english_word.toLowerCase().includes(s));
          }
          
          return filteredData;
        }, [data, userSettings, currentTab, filters, quickFilterPos, q]);
        
        // LazyWordCard 組件：使用 Intersection Observer 實作 lazy loading
        const LazyWordCard = ({ word, accentColor, onClick, index }) => {
          const [isVisible, setIsVisible] = useState(false);
          const cardRef = useRef(null);
          
          useEffect(() => {
            // 前 20 個卡片立即顯示，不需要 lazy loading
            if (index < 20) {
              setIsVisible(true);
              return;
            }
            
            const observer = new IntersectionObserver(
              (entries) => {
                entries.forEach((entry) => {
                  if (entry.isIntersecting) {
                    setIsVisible(true);
                    observer.unobserve(entry.target);
                  }
                });
              },
              {
                rootMargin: '50px', // 提前 50px 開始載入
              }
            );
            
            if (cardRef.current) {
              observer.observe(cardRef.current);
            }
            
            return () => {
              if (cardRef.current) {
                observer.unobserve(cardRef.current);
              }
            };
          }, [index]);
          
          return (
            <div
              ref={cardRef}
              onClick={onClick}
              className="bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition cursor-pointer overflow-hidden flex flex-col"
            >
              <div className="flex">
                {/* 左側跳色飾條 */}
                <div className={`w-1 ${accentColor}`}></div>
                
                {/* 卡片內容 */}
                <div className="flex-1 p-2.5">
                  {isVisible ? (
                    <>
                      {/* 英文單字 */}
                      <h3 className="text-base font-bold text-gray-900 mb-1.5 truncate">
                        {word.english_word}
                      </h3>
                      
                      {/* 中文解釋（已包含英文詞性） */}
                      {word.chinese_definition && (
                        <p className="text-sm text-gray-600 overflow-hidden" style={{
                          display: '-webkit-box',
                          WebkitLineClamp: 2,
                          WebkitBoxOrient: 'vertical',
                          lineHeight: '1.4'
                        }}>
                          {word.chinese_definition}
                        </p>
                      )}
                    </>
                  ) : (
                    <div className="flex items-center justify-center py-8">
                      <div className="animate-pulse text-gray-400 text-sm">載入中...</div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        };
        
        const controlInputClass = "w-full rounded-lg border border-[#E2E8F0] bg-white py-2.5 px-4 text-base text-gray-800 shadow-sm transition focus:outline-none focus:border-[#5A4FCF] focus:ring-4 focus:ring-purple-100 focus:ring-offset-0";
        return (
          <div>
            {/* 載入中 */}
            {isLoading && (
              <div className="mb-6 rounded-2xl border-2 border-indigo-200 bg-indigo-50 p-4 text-center">
                <div className="animate-pulse">
                  <div className="text-lg font-semibold text-indigo-700 mb-2">載入單字中...</div>
                  <div className="text-sm text-indigo-600">請稍候</div>
                </div>
              </div>
            )}
            
            {/* 載入錯誤 */}
            {loadError && (
              <div className="mb-6 rounded-2xl border-2 border-red-200 bg-red-50 p-4">
                <div className="text-lg font-semibold text-red-700 mb-2">載入失敗</div>
                <div className="text-sm text-red-600 mb-3">{loadError}</div>
                <div className="text-xs text-gray-600">
                  請確認 Google Sheet 已設為「可檢視」或「發布至網路」
                </div>
              </div>
            )}
            
            <div className="text-gray-600 mb-6 leading-relaxed space-y-1">
              <p className="text-lg font-medium text-gray-500">歡迎來到 WordGym 單字健身坊！</p>
              <p className="text-base text-gray-500">請從課本進度、大考衝刺或主題探索，選擇想要學習的內容！</p>
            </div>

            {/* Tab 切換 */}
            <div className="mb-8 flex flex-wrap gap-4">
              <button
                onClick={() => setCurrentTab('textbook')}
                className={`flex-1 sm:flex-none text-lg font-bold px-6 py-3 rounded-full border transition-all duration-200 min-h-[52px] ${
                  currentTab === 'textbook'
                    ? 'bg-[#5A4FCF] text-white border-transparent shadow-[0_4px_6px_rgba(90,79,207,0.3)]'
                    : 'bg-white text-gray-700 border-[#E2E8F0] hover:bg-[#EDF2F7]'
                }`}
              >
                課本進度
              </button>
              <button
                onClick={() => setCurrentTab('exam')}
                className={`flex-1 sm:flex-none text-lg font-bold px-6 py-3 rounded-full border transition-all duration-200 min-h-[52px] ${
                  currentTab === 'exam'
                    ? 'bg-[#5A4FCF] text-white border-transparent shadow-[0_4px_6px_rgba(90,79,207,0.3)]'
                    : 'bg-white text-gray-700 border-[#E2E8F0] hover:bg-[#EDF2F7]'
                }`}
              >
                大考衝刺
              </button>
              <button
                onClick={() => setCurrentTab('theme')}
                className={`flex-1 sm:flex-none text-lg font-bold px-6 py-3 rounded-full border transition-all duration-200 min-h-[52px] ${
                  currentTab === 'theme'
                    ? 'bg-[#5A4FCF] text-white border-transparent shadow-[0_4px_6px_rgba(90,79,207,0.3)]'
                    : 'bg-white text-gray-700 border-[#E2E8F0] hover:bg-[#EDF2F7]'
                }`}
              >
                主題探索
              </button>
            </div>
            {/* 控制面板 - 根據 Tab 顯示 */}
            {currentTab === 'textbook' && (() => {
              // 動態從資料中提取冊次和課次選項
              const volSet = new Set();
              const lessonSet = new Set();
              if (userSettings?.version) {
                data.forEach(word => {
                  const textbookIndex = Array.isArray(word.textbook_index) ? word.textbook_index : [];
                  textbookIndex.forEach(item => {
                    if (item && item.version === userSettings.version) {
                      if (item.vol) volSet.add(item.vol);
                      if (item.lesson) lessonSet.add(item.lesson);
                    }
                  });
                });
              }
              const availableVols = Array.from(volSet).sort();
              const availableLessons = Array.from(lessonSet).sort();
              
              return (
                <div className="mb-6 grid gap-4 md:grid-cols-2">
                  <div>
                    <label className="block text-sm font-medium text-gray-500 mb-2">冊次</label>
                    <select
                      value={filters.textbook?.vol || ''}
                      onChange={(e) => updateFilter('textbook', { ...filters.textbook, vol: e.target.value })}
                      className={controlInputClass}
                    >
                      <option value="">全部冊次</option>
                      {availableVols.length > 0 ? (
                        availableVols.map(vol => (
                          <option key={vol} value={vol}>{vol}</option>
                        ))
                      ) : (
                        ['B1', 'B2', 'B3', 'B4', 'B5', 'B6'].map(vol => (
                          <option key={vol} value={vol}>{vol}</option>
                        ))
                      )}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-500 mb-2">課次</label>
                    <select
                      value={filters.textbook?.lesson || ''}
                      onChange={(e) => updateFilter('textbook', { ...filters.textbook, lesson: e.target.value })}
                      className={controlInputClass}
                    >
                      <option value="">全部課次</option>
                      {availableLessons.length > 0 ? (
                        availableLessons.map(lesson => (
                          <option key={lesson} value={lesson}>{lesson}</option>
                        ))
                      ) : (
                        ['L1', 'L2', 'L3', 'L4', 'L5', 'L6', 'L7', 'L8', 'L9', 'U1', 'U2', 'U3', 'U4', 'U5', 'U6', 'U7', 'U8', 'U9'].map(lesson => (
                          <option key={lesson} value={lesson}>{lesson}</option>
                        ))
                      )}
                    </select>
                  </div>
                </div>
              );
            })()}

            {currentTab === 'exam' && (
              <div className="mb-6">
                <label className="block text-sm font-medium text-gray-500 mb-2">年份</label>
                <select
                  value={filters.exam?.year || ''}
                  onChange={(e) => updateFilter('exam', { ...filters.exam, year: e.target.value })}
                  className={controlInputClass}
                >
                  <option value="">請選擇年份</option>
                  {userSettings?.stage === 'junior' ? (
                    // 國中：顯示會考年份
                    ['108會考', '109會考', '110會考', '111會考', '112會考', '113會考', '114會考'].map(year => (
                      <option key={year} value={year}>{year}</option>
                    ))
                  ) : (
                    // 高中：顯示學測年份
                    ['108學測', '109學測', '110學測', '111學測', '112學測', '113學測', '114學測'].map(year => (
                      <option key={year} value={year}>{year}</option>
                    ))
                  )}
                </select>
              </div>
            )}

            {currentTab === 'theme' && (() => {
              // 根據 stage 動態提取選項
              let rangeOptions = [];
              let rangeLabel = '';
              
              if (userSettings?.stage === 'junior') {
                // 國中：顯示「1200」和「800」選項
                rangeLabel = '2000單';
                // 從 theme_index 陣列中提取實際存在的選項（1200 或 800）
                const wordRangeSet = new Set();
                data.forEach(word => {
                  const themeIndex = Array.isArray(word.theme_index) ? word.theme_index : [];
                  themeIndex.forEach(item => {
                    if (item && item.range) {
                      wordRangeSet.add(item.range);
                    }
                  });
                });
                rangeOptions = Array.from(wordRangeSet).sort((a, b) => parseInt(b) - parseInt(a)); // 降序：1200, 800
                // 如果沒有找到，提供預設選項
                if (rangeOptions.length === 0) {
                  rangeOptions = ['1200', '800'];
                }
              } else {
                // 高中：只顯示 Level 4、5、6
                rangeLabel = '程度範圍';
                rangeOptions = ['Level 4', 'Level 5', 'Level 6'];
              }
              
              return (
                <div className="mb-6 grid gap-4 md:grid-cols-2">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">{rangeLabel}</label>
                    <select
                      value={filters.theme?.range || ''}
                      onChange={(e) => updateFilter('theme', { ...filters.theme, range: e.target.value })}
                      className={controlInputClass}
                    >
                      <option value="">全部{rangeLabel}</option>
                      {rangeOptions.map(range => (
                        <option key={range} value={range}>{range}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-500 mb-2">主題分類</label>
                    <select
                      value={filters.theme?.theme || ''}
                      onChange={(e) => updateFilter('theme', { ...filters.theme, theme: e.target.value })}
                      className={controlInputClass}
                    >
                      <option value="">全部主題</option>
                      {themes.map(t => (
                        <option key={t} value={t}>{THEME_LABEL[t] || t}</option>
                      ))}
                    </select>
                  </div>
                </div>
              );
            })()}

            {/* 詞性快篩 */}
            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-500 mb-2">詞性快篩</label>
              <div className="flex flex-wrap gap-2">
                {['all', ...ALL_POS].map(pos => {
                  const active = quickFilterPos === pos;
                  return (
                    <button
                      key={pos}
                      onClick={() => setQuickFilterPos(pos)}
                      className={`px-4 py-2 text-sm font-medium rounded-full border transition focus:outline-none focus:ring-2 focus:ring-offset-0 ${
                        active
                          ? 'bg-[#5A4FCF] text-white border-[#5A4FCF] shadow-sm'
                          : 'bg-white text-gray-700 border-[#E2E8F0] hover:bg-indigo-50 hover:text-[#5A4FCF]'
                      } hover:opacity-95 focus:ring-[#5A4FCF]/30`}
                      type="button"
                    >
                      {pos === 'all' ? '全部' : POS_LABEL[pos]}
                    </button>
                  );
                })}
              </div>
            </div>

            {/* 搜尋框 */}
            <div className="mb-6 flex flex-col sm:flex-row items-start sm:items-center gap-3">
              <input 
                value={q} 
                onChange={(e)=>setQ(e.target.value)} 
                placeholder="搜尋單字..." 
                className={`${controlInputClass} sm:flex-1`} 
              />
              {q && (
                <Button 
                  variant="ghost" 
                  onClick={()=>setQ("")}
                  className="whitespace-nowrap"
                >
                  清除搜尋
                </Button>
              )}
            </div>
            
            <div className="mt-10 space-y-4">
              <div className="flex flex-wrap items-baseline justify-between gap-3">
                <div>
                  <h2 className="text-xl font-semibold">
                    {currentTab === 'textbook' && '課本進度'}
                    {currentTab === 'exam' && '大考衝刺'}
                    {currentTab === 'theme' && '主題探索'}
                  </h2>
                  <p className="text-sm text-gray-500">符合條件的單字：{filtered.length} 筆{q ? `（含搜尋「${q}」）` : ''}</p>
                </div>
                {filtered.length > 0 && (
                  <Button
                    variant="primary"
                    onClick={() => {
                      // 將篩選後的單字 ID 帶入測驗頁面
                      const wordIds = filtered.map(w => w.id).join(',');
                      push(`#/quiz?words=${wordIds}`);
                    }}
                    className="ml-auto"
                  >
                    測驗此範圍
                  </Button>
                )}
              </div>
              
              {/* 卡片式列表 */}
              {filtered.length === 0 ? (
                <div className="rounded-2xl border border-gray-200 bg-white/80 shadow-sm p-8 text-center">
                  <p className="text-sm text-gray-500">找不到符合條件的單字，請調整篩選條件。</p>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                  {filtered.map((w, index) => {
                    const accentColors = ['bg-indigo-500', 'bg-blue-500', 'bg-purple-500', 'bg-pink-500', 'bg-green-500'];
                    const accentColor = accentColors[w.id % accentColors.length] || 'bg-indigo-500';
                    
                    return (
                      <LazyWordCard
                        key={w.id}
                        word={w}
                        accentColor={accentColor}
                        onClick={() => push(`#/word/${w.id}`)}
                        index={index}
                      />
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        );
      };

      const CategoryList = ({ cat, data }) => {
        const list = data.filter(w => (w.posTags||[]).includes(cat));
        return (
          <div>
            <h1 className="text-2xl font-bold mb-4">{POS_LABEL[cat] || cat || '—'}（{list.length}）</h1>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
              {list.map(w => (
                <a key={w.id} href={`#/word/${w.id}`} className="block rounded-xl border p-3 hover:shadow">
                  <div className="font-semibold">{w.english_word}</div>
                  <div className="text-xs text-gray-500">{(w.posTags||[]).join(', ')}</div>
                </a>
              ))}
            </div>
          </div>
        );
      };

      const WordDetail = ({ id, data, favoritesApi, userExamplesApi, push, prevRoute, userSettings }) => {
        const word = data.find((w) => String(w.id) === String(id));
        const [selPos, setSelPos] = useState(word?.posTags?.[0] || "other");
        const [mdPreview, setMdPreview] = useState('');
        const [mdStatus, setMdStatus] = useState('');
        const [showMdPreview, setShowMdPreview] = useState(false);
        const [exportSections, setExportSections] = useState({ pos: true, relations: true, affix: true });
        const [showAddExample, setShowAddExample] = useState(false);
        const [newExampleEn, setNewExampleEn] = useState('');
        const [newExampleZh, setNewExampleZh] = useState('');

        // 提取 YouTube 影片 ID
        const getYouTubeId = (url) => {
          if (!url || typeof url !== 'string') return null;
          const trimmedUrl = url.trim();
          if (!trimmedUrl) return null;
          
          // 支援多種 YouTube URL 格式
          const patterns = [
            /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\?\/\s]+)/,
            /youtube\.com\/watch\?.*[?&]v=([^&\s]+)/,
            /youtube\.com\/.*[?&]v=([^&\s]+)/,
            /^([a-zA-Z0-9_-]{11})$/  // 直接是影片 ID
          ];
          
          for (const pattern of patterns) {
            const match = trimmedUrl.match(pattern);
            if (match && match[1]) {
              return match[1];
            }
          }
          
          return null;
        };
        
        const videoId = word ? getYouTubeId(word.videoUrl) : null;

        // 除錯：顯示 videoUrl 資訊
        React.useEffect(() => {
          if (word) {
            const wordLower = word.english_word?.toLowerCase();
            if (wordLower === 'conservation' || wordLower === 'brutal') {
              console.log(`=== ${word.english_word} 單字資料除錯 ===`);
              console.log('單字:', word.english_word);
              console.log('videoUrl 欄位值:', word.videoUrl);
              console.log('提取的 videoId:', videoId);
              console.log('完整單字物件:', word);
            }
          }
        }, [word, videoId]);

        // 合併 CSV 和使用者例句的函數
        const getAllExamples = (word) => {
          const examples = [];
          
          // 除錯：檢查 word 物件是否有例句3-5
          if (word.english_word === 'air' || word.english_word === 'fall' || word.english_word === 'blow') {
            console.log(`=== ${word.english_word} 例句檢查 ===`);
            console.log('example_sentence:', word.example_sentence);
            console.log('example_sentence_2:', word.example_sentence_2);
            console.log('example_sentence_3:', word.example_sentence_3);
            console.log('example_sentence_4:', word.example_sentence_4);
            console.log('example_sentence_5:', word.example_sentence_5);
          }
          
          // 從 CSV 讀取例句（1-5）
          for (let i = 1; i <= 5; i++) {
            const sentenceKey = i === 1 ? 'example_sentence' : `example_sentence_${i}`;
            const translationKey = i === 1 ? 'example_translation' : `example_translation_${i}`;
            
            const sentence = (word[sentenceKey] || '').trim();
            const translation = (word[translationKey] || '').trim();
            
            // 只要有任何一個欄位有內容就保留
            if (sentence || translation) {
              // 只有例句2有出處資訊
              const sourceInfo = (i === 2 && word.example_source_2) ? word.example_source_2.trim() : '';
              
              examples.push({
                sentence,
                translation,
                source: 'csv',
                sourceInfo,
                index: i
              });
            }
          }
          
          if (word.english_word === 'air' || word.english_word === 'fall' || word.english_word === 'blow') {
            console.log('收集到的例句數量:', examples.length);
            console.log('例句列表:', examples);
          }
          
          // 從 localStorage 讀取使用者例句
          const userExamples = userExamplesApi.get(word.id);
          userExamples.forEach((ex, idx) => {
            examples.push({
              sentence: ex.sentence,
              translation: ex.translation,
              source: 'user',
              sourceInfo: '',
              userIndex: idx
            });
          });
          
          // 限制最多 5 個
          return examples.slice(0, 5);
        };

        const allExamples = word ? getAllExamples(word) : [];
        const canAddMore = allExamples.length < 5;

        // 新增例句的處理函數
        const handleAddExample = () => {
          if (!newExampleEn.trim() && !newExampleZh.trim()) {
            alert('請至少輸入英文或中文例句');
            return;
          }
          userExamplesApi.add(word.id, newExampleEn, newExampleZh);
          setNewExampleEn('');
          setNewExampleZh('');
          setShowAddExample(false);
        };

        // 刪除例句的處理函數
        const handleDeleteExample = (example) => {
          if (example.source === 'user' && example.userIndex !== undefined) {
            if (confirm('確定要刪除這個例句嗎？')) {
              userExamplesApi.remove(word.id, example.userIndex);
            }
          }
        };

        useEffect(() => {
          setMdStatus('');
          setShowMdPreview(false);
          setMdPreview('');
          setShowAddExample(false);
          setNewExampleEn('');
          setNewExampleZh('');
        }, [selPos, word?.id]);

        useEffect(() => {
          setExportSections({ pos: true, relations: true, affix: true });
        }, [word?.id]);

        useEffect(() => {
          if (!word) return;
          const nextPos = Array.isArray(word.posTags) && word.posTags.length ? word.posTags[0] : 'other';
          setSelPos(nextPos);
        }, [word?.id]);

        if (!word) return <div>找不到單字。</div>;

        const posTags = Array.isArray(word.posTags) && word.posTags.length ? word.posTags : ['other'];
        const posTextFull = posTags.map((tag) => POS_LABEL[tag] || tag);
        const themeKeys = getWordThemes(word);
        const themeLabels = getThemeDisplayLabels(word);
        const primaryThemeLabel = themeLabels[0] || '—';
        const levelText = String(word.level ?? '').trim();
        const isFav = favoritesApi.favorites.includes(word.id);

        const auto = grammarDefaults(word.english_word, selPos, word.grammar_sub_category);
        const gFunc = (word.grammar_function || '').trim() || auto.grammar_function;
        const gPattern = (word.applicable_sentence_pattern || '').trim() || auto.sentence_pattern;

        const wfDetailRaw = word.word_forms_detail || emptyWordFormsDetail();
        const wfDetail = {
          base: Array.isArray(wfDetailRaw.base) ? wfDetailRaw.base : [],
          idiom: Array.isArray(wfDetailRaw.idiom) ? wfDetailRaw.idiom : [],
          compound: Array.isArray(wfDetailRaw.compound) ? wfDetailRaw.compound : [],
          derivation: Array.isArray(wfDetailRaw.derivation) ? wfDetailRaw.derivation : []
        };
        
        // 詞性變化資料會在渲染時直接顯示

        const clean = (value) => String(value || '').trim();
        const primaryExampleEn = clean(word.example_sentence);
        const primaryExampleZh = clean(word.example_translation);
        const secondaryExampleEn = clean(word.example_sentence_2);
        const secondaryExampleZh = clean(word.example_translation_2);
        const secondaryExampleSource = clean(word.example_source_2);
        
        // 除錯：檢查資料載入狀況
        if (word.english_word === 'air') {
          console.log('Air 單字資料檢查:', {
            english_word: word.english_word,
            example_sentence: word.example_sentence,
            example_sentence_2: word.example_sentence_2,
            example_source_2: word.example_source_2,
            secondaryExampleSource: secondaryExampleSource,
            rawData: word
          });
        }
        const fallbackExample = exampleFor(word.english_word, selPos);
        const fallbackTranslation = translationFor(word.english_word, selPos);

        const exampleCards = [
          { en: primaryExampleEn, zh: primaryExampleZh, allowFallback: true, source: '' },
          { en: secondaryExampleEn, zh: secondaryExampleZh, allowFallback: false, source: secondaryExampleSource }
        ];

        const synonyms = Array.isArray(word.synonyms) ? word.synonyms : multiSplit(word.synonyms || '');
        const antonyms = Array.isArray(word.antonyms) ? word.antonyms : multiSplit(word.antonyms || '');
        const confusables = Array.isArray(word.confusables) ? word.confusables : multiSplit(word.confusables || '');
        const hasSynonymBlock = synonyms.length || antonyms.length || confusables.length;

        const affix = word.affix_info || {};
        const affixInfo = {
          prefix: clean(affix.prefix),
          root: clean(affix.root),
          suffix: clean(affix.suffix),
          meaning: clean(affix.meaning),
          example: clean(affix.example)
        };
        const hasAffixInfo = affixInfo.prefix || affixInfo.suffix || affixInfo.root;

        const exportExample1 = primaryExampleEn || fallbackExample;
        const exportTranslation1 = primaryExampleZh || fallbackTranslation;
        const exportExample2 = secondaryExampleEn;
        const exportTranslation2 = secondaryExampleZh;

        const handleOutput = async () => {
          const md = wordToMarkdown(word, selPos, {
            example_sentence: exportExample1,
            example_translation: exportTranslation1,
            example_sentence_2: exportExample2,
            example_translation_2: exportTranslation2,
            grammar_function: gFunc,
            applicable_sentence_pattern: gPattern,
            grammar_sub_category: word.grammar_sub_category,
            word_forms: word.word_forms,
            derivatives: word.derivatives,
            synonyms: word.synonyms,
            antonyms: word.antonyms,
            confusables: word.confusables,
            affix_info: word.affix_info,
            sections: exportSections
          });
          setMdPreview(md);
          if (!md || !md.trim()) {
            setMdStatus('此單字目前沒有可輸出的內容。');
            setShowMdPreview(false);
            return;
          }
          try {
            if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(md);
              setMdStatus('已複製 Markdown，可貼到 Google 文件或投影片。');
              setShowMdPreview(false);
              return;
            }
            throw new Error('clipboard not available');
          } catch (err) {
            setMdStatus('無法自動複製，請手動複製下方內容。');
            setShowMdPreview(true);
          }
        };

        
        const goBack = () => {
          // 1. 優先檢查是否從測驗完成頁面來的
          try {
            const quizReturn = JSON.parse(sessionStorage.getItem('quiz_return_path') || 'null');
            if (quizReturn && quizReturn.timestamp && Date.now() - quizReturn.timestamp < 3600000) {
              // 1小時內有效
              sessionStorage.removeItem('quiz_return_path');
              push(quizReturn.path);
              return;
            }
          } catch {}
          
          // 2. 如果從 quiz 頁面進入，返回 quiz 頁面
          if (prevRoute && prevRoute.route === 'quiz') {
            push('#/quiz');
            return;
          }
          
          // 3. 其他情況使用原有邏輯
          if (prevRoute && prevRoute.route) {
            if (prevRoute.route === 'category' && prevRoute.param) { push(`#/category/${prevRoute.param}`); return; }
            if (prevRoute.route === 'favorites') { push('#/favorites'); return; }
            if (prevRoute.route === 'word' && prevRoute.param) { push(`#/word/${prevRoute.param}`); return; }
            if (prevRoute.route === 'home') { push('#/'); return; }
          }
          push('#/');
        };

        // 解析來源資訊
        const formatSource = (source) => {
          if (!source) return '';
          const parts = source.split('\t');
          if (parts.length === 3) {
            return `${parts[0]} ${parts[1]} ${parts[2]}`;
          }
          return source;
        };

        const renderExampleCard = (example, idx) => {
          const fallbackExample = exampleFor(word.english_word, selPos);
          const fallbackTranslation = translationFor(word.english_word, selPos);
          
          // 第一個例句如果為空可以使用 fallback
          const useFallback = idx === 0 && !example.sentence;
          const enText = example.sentence || (useFallback ? fallbackExample : '');
          const zhText = example.translation || (useFallback ? fallbackTranslation : '');
          const speakText = enText;
          
          // 如果沒有內容就不顯示
          if (!enText && !zhText && !useFallback) {
            return null;
          }
          
          return (
            <div key={`example-${idx}`} className="rounded-2xl bg-indigo-50 px-4 py-3 relative">
              <div className="flex items-start gap-2">
                <p className="flex-1 text-lg text-gray-500 italic whitespace-pre-wrap">{enText || ' '}</p>
                <div className="flex items-center gap-2">
                  {speakText ? (
                    <SpeakerButton
                      onClick={() => speak(speakText)}
                      label={`播放例句 ${idx + 1} 發音`}
                      className="mt-0.5"
                    />
                  ) : null}
                  {example.source === 'user' && (
                    <button
                      onClick={() => handleDeleteExample(example)}
                      className="h-8 w-8 rounded-full border border-rose-200 bg-white text-rose-600 hover:bg-rose-50 hover:text-rose-700 transition flex items-center justify-center"
                      title="刪除例句"
                    >
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className="h-4 w-4">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  )}
                </div>
              </div>
              <div className="mt-2 text-sm text-indigo-800 whitespace-pre-wrap">{zhText || ' '}</div>
              {useFallback && (
                <div className="mt-2 text-xs text-gray-500">（系統預設例句，尚未補入原始資料）</div>
              )}
              {example.source === 'user' && (
                <div className="mt-2 text-xs text-emerald-600 font-medium">我的例句</div>
              )}
              {/* 例句1：顯示「基礎例句」 */}
              {example.source === 'csv' && example.index === 1 && (
                <div className="mt-2 text-xs text-gray-500 text-right">基礎例句</div>
              )}
              {/* 例句2：顯示 CSV 出處 */}
              {example.source === 'csv' && example.index === 2 && example.sourceInfo && (
                <div className="mt-2 text-xs text-gray-500 text-right">{formatSource(example.sourceInfo)}</div>
              )}
            </div>
          );
        };

        const renderTagPill = (items, classes) => (
          <div className="flex flex-wrap gap-2">
            {items.map((item, idx) => (
              <span key={`${classes}-${idx}`} className={`px-3 py-1 rounded-full ${classes}`}>{item}</span>
            ))}
          </div>
        );

        const toggleExportSection = (key) => {
          setExportSections((prev) => ({ ...prev, [key]: !prev[key] }));
        };

        // 構建標籤資料（包括新擴充的欄位）
        const tagData = [];
        if (levelText) tagData.push({ label: `Level ${levelText}`, color: 'bg-amber-50 text-amber-700' });
        if (selPos) tagData.push({ label: POS_LABEL[selPos] || selPos, color: 'bg-indigo-50 text-indigo-700' });
        themeLabels.forEach(label => {
          tagData.push({ label, color: 'bg-gray-100 text-gray-700' });
        });
        if (word.cefr) tagData.push({ label: word.cefr, color: 'bg-purple-50 text-purple-700' });
        if (word.grammar_sub_category) tagData.push({ label: word.grammar_sub_category, color: 'bg-emerald-50 text-emerald-700' });
        // 新擴充的欄位
        // textbook_index 是陣列，不需要在這裡顯示（已在來源標籤中顯示）
        if (word.exam_tags && Array.isArray(word.exam_tags) && word.exam_tags.length > 0) {
          word.exam_tags.forEach(tag => {
            tagData.push({ label: tag, color: 'bg-rose-50 text-rose-700' });
          });
        }

        return (
          <div className="bg-gray-50 min-h-screen pb-8">
            <div className="max-w-5xl mx-auto px-4 pt-6">
              {/* 頂部操作欄 */}
              <div className="flex flex-wrap items-center justify-between gap-3 mb-6">
                <div className="flex items-center gap-2">
                  <Button variant="ghost" onClick={goBack}>← 返回</Button>
                </div>
                <div className="flex gap-2">
                  <Button variant={isFav ? 'danger' : 'primary'} onClick={() => favoritesApi.toggle(word.id)}>{isFav ? '移除重點訓練' : '加入重點訓練'}</Button>
                </div>
              </div>

              {/* 第一張卡片：核心資訊與來源標籤 */}
              <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-4">
                {/* 來源標籤 */}
                {(() => {
                  // 取得來源標籤
                  let sourceLabels = [];
                  
                  // 課本索引標籤
                  const textbookIndex = Array.isArray(word.textbook_index) ? word.textbook_index : [];
                  if (textbookIndex.length > 0) {
                    textbookIndex.forEach(item => {
                      if (item && item.version && item.vol && item.lesson) {
                        sourceLabels.push(`${item.version} ${item.vol}-${item.lesson}`);
                      }
                    });
                  }
                  
                  // 大考標籤
                  const examTags = Array.isArray(word.exam_tags) ? word.exam_tags : [];
                  if (examTags.length > 0) {
                    examTags.forEach(tag => {
                      if (tag) {
                        sourceLabels.push(tag);
                      }
                    });
                  }
                  
                  return sourceLabels.length > 0 ? (
                    <div className="mb-4 flex flex-wrap gap-2">
                      {sourceLabels.map((label, idx) => (
                        <span key={idx} className="inline-block px-3 py-1 text-sm font-medium bg-indigo-100 text-indigo-700 rounded-lg">
                          {label}
                        </span>
                      ))}
                    </div>
                  ) : null;
                })()}
                
                {/* 單字與發音 */}
                <div className="flex items-center gap-3 flex-wrap mb-4">
                  <h1 className="text-4xl font-bold text-gray-900">{word.english_word}</h1>
                  <SpeakerButton label="播放單字發音" onClick={() => speak(word.english_word)} />
                  {word.kk_phonetic && <div className="text-xl font-medium text-indigo-600">{word.kk_phonetic}</div>}
                </div>

                {/* 中文定義 */}
                <div className="mb-4">
                  <p className="text-lg text-gray-900 whitespace-pre-wrap">{word.chinese_definition || '—'}</p>
                </div>

                {/* 搜尋條件標籤區 */}
                <div className="flex flex-wrap items-center gap-2 mb-4">
                  {tagData.map((tag, idx) => (
                    <span key={idx} className={`px-3 py-1 rounded-full text-sm font-medium ${tag.color}`}>
                      {tag.label}
                    </span>
                  ))}
                </div>

                {/* 詞性切換（如果有多個詞性） */}
                {posTags.length > 1 && (
                  <div className="flex flex-wrap gap-2">
                    {posTags.map((tag) => (
                      <button
                        key={tag}
                        onClick={() => setSelPos(tag)}
                        className={`px-3 py-1 rounded-full border transition text-sm ${selPos === tag ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 border-gray-200 hover:border-indigo-400'}`}
                      >
                        {POS_LABEL[tag] || tag}
                      </button>
                    ))}
                  </div>
                )}

                {/* 影片區塊（如果有） */}
                {videoId && (
                  <div className="mt-6 rounded-xl overflow-hidden border border-gray-200 bg-gray-50 shadow-sm">
                    <div className="relative" style={{ paddingBottom: '56.25%' }}>
                      <iframe
                        className="absolute top-0 left-0 h-full w-full"
                        src={`https://www.youtube.com/embed/${videoId}`}
                        title={`${word.english_word} 教學影片`}
                        frameBorder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowFullScreen
                      />
                    </div>
                    <div className="px-3 py-2 text-xs text-center text-gray-600 bg-white border-t border-gray-200">
                      教學影片
                    </div>
                  </div>
                )}
              </div>

              {/* 第二張卡片：例句展示 */}
              <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-4">

                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-xl font-bold text-gray-900">例句</h2>
                  {canAddMore && !showAddExample && (
                    <button
                      onClick={() => setShowAddExample(true)}
                      className="px-3 py-1 text-sm rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition flex items-center gap-1"
                    >
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className="h-4 w-4">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                      </svg>
                      新增例句
                    </button>
                  )}
                </div>
                
                <div className="space-y-4">
                  {allExamples.map((example, idx) => {
                    const fallbackExample = exampleFor(word.english_word, selPos);
                    const fallbackTranslation = translationFor(word.english_word, selPos);
                    const useFallback = idx === 0 && !example.sentence;
                    const enText = example.sentence || (useFallback ? fallbackExample : '');
                    const zhText = example.translation || (useFallback ? fallbackTranslation : '');
                    
                    if (!enText && !zhText && !useFallback) return null;
                    
                    return (
                      <div key={`example-${idx}`} className="pl-4 border-l-4 border-indigo-400">
                        <div className="flex items-start gap-2">
                          <div className="flex flex-col flex-1">
                            <div className="text-xl font-bold text-gray-800 leading-snug">
                              {enText || ' '}
                            </div>
                            <div className="text-sm text-gray-400 mt-2">
                              {zhText || ' '}
                            </div>
                            {useFallback && (
                              <div className="mt-2 text-xs text-gray-500">（系統預設例句，尚未補入原始資料）</div>
                            )}
                            {example.source === 'user' && (
                              <div className="mt-2 text-xs text-emerald-600 font-medium">我的例句</div>
                            )}
                            {example.source === 'csv' && example.index === 1 && (
                              <div className="mt-2 text-xs text-gray-500 text-right">基礎例句</div>
                            )}
                            {example.source === 'csv' && example.index === 2 && example.sourceInfo && (
                              <div className="mt-2 text-xs text-gray-500 text-right">{formatSource(example.sourceInfo)}</div>
                            )}
                          </div>
                          <div className="flex items-center gap-2">
                            {enText && (
                              <SpeakerButton
                                onClick={() => speak(enText)}
                                label={`播放例句 ${idx + 1} 發音`}
                                className="mt-0.5"
                              />
                            )}
                            {example.source === 'user' && (
                              <button
                                onClick={() => handleDeleteExample(example)}
                                className="h-8 w-8 rounded-full border border-rose-200 bg-white text-rose-600 hover:bg-rose-50 hover:text-rose-700 transition flex items-center justify-center"
                                title="刪除例句"
                              >
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className="h-4 w-4">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                              </button>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                  
                  {showAddExample && (
                    <div className="rounded-2xl border-2 border-indigo-300 bg-indigo-50/50 px-4 py-4 space-y-3">
                      <div className="flex items-center justify-between mb-2">
                        <div className="text-sm font-semibold text-indigo-700">新增自訂例句</div>
                        <button
                          onClick={() => setShowAddExample(false)}
                          className="text-gray-500 hover:text-gray-700"
                        >
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className="h-5 w-5">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                      </div>
                      <div>
                        <label className="block text-sm text-gray-700 mb-1">英文例句</label>
                        <input
                          type="text"
                          value={newExampleEn}
                          onChange={(e) => setNewExampleEn(e.target.value)}
                          placeholder="輸入英文例句..."
                          className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-700 mb-1">中文翻譯</label>
                        <input
                          type="text"
                          value={newExampleZh}
                          onChange={(e) => setNewExampleZh(e.target.value)}
                          placeholder="輸入中文翻譯..."
                          className="w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        />
                      </div>
                      <div className="flex gap-2 justify-end">
                        <button
                          onClick={() => setShowAddExample(false)}
                          className="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition"
                        >
                          取消
                        </button>
                        <button
                          onClick={handleAddExample}
                          className="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition"
                        >
                          儲存
                        </button>
                      </div>
                    </div>
                  )}
                  
                  {allExamples.length === 0 && (
                    <div className="text-gray-500 text-sm py-4 text-center">
                      目前沒有例句，點擊「新增例句」來新增第一個例句
                    </div>
                  )}
                </div>
              </div>

              {/* 第三張卡片：詞性變化與關聯字 */}
              <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-4">
                <h2 className="text-xl font-bold text-gray-900 mb-4">詞性與關聯字</h2>
                
                <div className="space-y-6">
                  {/* 詞性變化 */}
                  {word.word_forms || word['詞性變化'] ? (
                    <div>
                      <div className="text-sm font-semibold text-gray-500 mb-2">詞性變化</div>
                      <div className="flex flex-wrap gap-2">
                        {String(word.word_forms || word['詞性變化'] || '').split('\n').filter(line => line.trim()).map((line, idx) => (
                          <span key={idx} className="px-3 py-1.5 rounded-lg bg-indigo-50 text-indigo-700 text-sm font-medium border border-indigo-200">
                            {line.trim()}
                          </span>
                        ))}
                      </div>
                    </div>
                  ) : null}

                  {/* 片語 */}
                  {Array.isArray(word.phrases) && word.phrases.length > 0 && (
                    <div>
                      <div className="text-sm font-semibold text-gray-500 mb-2">片語</div>
                      <div className="flex flex-wrap gap-2">
                        {word.phrases.map((phrase, idx) => (
                          <span key={`phrase-${idx}`} className="px-3 py-1.5 rounded-lg bg-purple-50 text-purple-700 text-sm font-medium border border-purple-200">
                            {phrase}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* 同義／反義／易混淆 */}
                  {hasSynonymBlock && (
                    <div>
                      <div className="text-sm font-semibold text-gray-500 mb-2">同義／反義／易混淆</div>
                      <div className="grid gap-4 md:grid-cols-3">
                        {synonyms.length > 0 && (
                          <div>
                            <div className="text-xs font-semibold text-gray-400 mb-2">同義字</div>
                            <div className="flex flex-wrap gap-2">
                              {synonyms.map((syn, idx) => (
                                <span key={idx} className="px-3 py-1.5 rounded-lg bg-blue-50 text-blue-700 text-sm font-medium border border-blue-200">
                                  {syn}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}
                        {antonyms.length > 0 && (
                          <div>
                            <div className="text-xs font-semibold text-gray-400 mb-2">反義字</div>
                            <div className="flex flex-wrap gap-2">
                              {antonyms.map((ant, idx) => (
                                <span key={idx} className="px-3 py-1.5 rounded-lg bg-rose-50 text-rose-700 text-sm font-medium border border-rose-200">
                                  {ant}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}
                        {confusables.length > 0 && (
                          <div>
                            <div className="text-xs font-semibold text-gray-400 mb-2">易混淆字</div>
                            <div className="flex flex-wrap gap-2">
                              {confusables.map((conf, idx) => (
                                <span key={idx} className="px-3 py-1.5 rounded-lg bg-amber-50 text-amber-700 text-sm font-medium border border-amber-200">
                                  {conf}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>
              </div>

              {/* 第四張卡片：字根字首 */}
              {hasAffixInfo && (
                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-4">
                  <h2 className="text-xl font-bold text-gray-900 mb-4">
                    {(() => {
                      const availableItems = [];
                      if (affixInfo.prefix) availableItems.push('字首');
                      if (affixInfo.suffix) availableItems.push('字尾');
                      if (affixInfo.root) availableItems.push('字根');
                      return availableItems.join('｜') || '字首｜字尾｜字根';
                    })()}
                  </h2>
                  <div className="grid gap-4 md:grid-cols-2">
                    {affixInfo.prefix && (
                      <div>
                        <div className="text-xs font-semibold text-gray-500 mb-1">字首</div>
                        <div className="text-base text-gray-900">{affixInfo.prefix}</div>
                      </div>
                    )}
                    {affixInfo.suffix && (
                      <div>
                        <div className="text-xs font-semibold text-gray-500 mb-1">字尾</div>
                        <div className="text-base text-gray-900">{affixInfo.suffix}</div>
                      </div>
                    )}
                    {affixInfo.root && (
                      <div className="md:col-span-2">
                        <div className="text-xs font-semibold text-gray-500 mb-1">字根</div>
                        <div className="text-base text-gray-900">{affixInfo.root}</div>
                      </div>
                    )}
                    {affixInfo.meaning && (
                      <div className="md:col-span-2">
                        <div className="text-xs font-semibold text-gray-500 mb-1">意思</div>
                        <div className="text-base text-gray-900 whitespace-pre-wrap">{affixInfo.meaning}</div>
                      </div>
                    )}
                    {affixInfo.example && (
                      <div className="md:col-span-2">
                        <div className="text-xs font-semibold text-gray-500 mb-1">例子</div>
                        <div className="text-base text-gray-900 whitespace-pre-wrap">{affixInfo.example}</div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* 匯出內容卡片（可選） */}
              <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-4">
                <details>
                  <summary className="cursor-pointer list-none text-lg font-semibold text-gray-800 flex items-center gap-2">
                    匯出內容
                    <span className="inline-flex h-5 w-5 items-center justify-center rounded-full border border-gray-300 text-gray-500 text-xs"></span>
                  </summary>
                  <div className="mt-4 flex flex-wrap gap-4 text-sm text-gray-700">
                    {[
                      { key: 'pos', label: '詞性區塊' },
                      { key: 'relations', label: '同義／反義／易混淆' },
                      { key: 'affix', label: '字根字首字尾' }
                    ].map((opt) => (
                      <label key={opt.key} className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={!!exportSections[opt.key]}
                          onChange={() => toggleExportSection(opt.key)}
                          className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                        />
                        <span>{opt.label}</span>
                      </label>
                    ))}
                    <div className="flex justify-end gap-2 pt-2 w-full">
                      <Button variant="ghost" onClick={handleOutput}>匯出 Markdown</Button>
                    </div>
                  </div>
                </details>
              </div>
              {mdStatus && <div className="text-sm text-gray-500 text-right mb-4">{mdStatus}</div>}
              {showMdPreview && (
                <div className="mt-3 mb-4">
                  <textarea value={mdPreview} readOnly className="w-full h-32 md:h-40 px-3 py-2 rounded-lg border border-gray-300 text-xs font-mono bg-white/80" />
                  <div className="mt-1 text-xs text-gray-400 text-right">選取並複製後即可貼到 Google 文件／投影片。</div>
                </div>
              )}
            </div>
          </div>
        );
      };

      const escapeForRegex = (s) => String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const makeCloze = (sentence, answer) => {
        const esc = escapeForRegex(answer);
        const rx = new RegExp(`(^|[^A-Za-z])(${esc})(?=[^A-Za-z]|$)`, 'i');
        return String(sentence).replace(rx, (m) => m.replace(new RegExp(esc, 'i'), '_____ '));
      };

      const FavoritesPage = ({ favoritesApi, data }) => {
        const items = data.filter((w) => favoritesApi.favorites.includes(w.id));
        return (
          <div>
            <div className="flex items-center justify-between">
              <h1 className="text-2xl font-bold">重點訓練（{items.length}）</h1>
              <div className="flex gap-2">
                <a href="#/quiz?source=favorites"><Button>開始測驗</Button></a>
                {items.length>0 && <Button variant="ghost" onClick={favoritesApi.clear}>全部清除</Button>}
              </div>
            </div>
            {items.length === 0 ? (
              <p className="text-gray-600 mt-3">尚未加入任何單字。前往單字頁按「加入最愛」。</p>
            ) : (
              <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mt-4">
                {items.map((w) => (
                  <div key={w.id} className="rounded-xl border p-3">
                    <a className="font-semibold hover:underline" href={`#/word/${w.id}`}>{w.english_word}</a>
                    <div className="text-xs text-gray-500 mb-2">{(w.posTags||[]).join(', ')}</div>
                    <Button variant="ghost" onClick={()=>favoritesApi.remove(w.id)}>移除</Button>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      };

      // 完成畫面組件
      const QuizCompletionScreen = ({ type, totalQuestions, correct, wrong, learning, wrongWords, learningWords, favoritesApi, onRestart, data }) => {
        const [showWrongList, setShowWrongList] = useState(true);
        const [showLearningList, setShowLearningList] = useState(true);
        const [addedWrong, setAddedWrong] = useState(false);
        const [addedLearning, setAddedLearning] = useState(false);
        
        const correctRate = totalQuestions > 0 ? Math.round((correct / totalQuestions) * 100 * 10) / 10 : 0;
        
        const handleAddWrongToFavorites = () => {
          if (wrongWords.length === 0) return;
          wrongWords.forEach(w => {
            if (w.wordId && !favoritesApi.favorites.includes(w.wordId)) {
              favoritesApi.toggle(w.wordId);
            }
          });
          setAddedWrong(true);
        };
        
        const handleAddLearningToFavorites = () => {
          if (learningWords.length === 0) return;
          learningWords.forEach(w => {
            if (w.wordId && !favoritesApi.favorites.includes(w.wordId)) {
              favoritesApi.toggle(w.wordId);
            }
          });
          setAddedLearning(true);
        };
        
        return (
          <div className="text-center py-5 bg-white rounded-2xl shadow-xl border-t-4 border-indigo-600">
            <h2 className="text-2xl font-bold text-gray-800">
              {type === 'flashcard' ? '閃卡複習完成！' : '測驗完成！'}
            </h2>
            
            {/* 成績統計 */}
            {type === 'flashcard' ? (
              <div className="flex items-center justify-center gap-6 mt-3 mb-6">
                <span className="text-gray-500">總題數：{totalQuestions} 題</span>
                <span className="text-gray-400">|</span>
                <span className="text-green-600 font-medium">你已學會：{correct} 個</span>
                {learning > 0 && (
                  <>
                    <span className="text-gray-400">|</span>
                    <span className="text-orange-600 font-medium">還不熟：{learning} 個</span>
                  </>
                )}
              </div>
            ) : (
              <div className="flex items-center justify-center gap-6 mt-3 mb-6">
                <span className="text-gray-500">總題數：{totalQuestions} 題</span>
                <span className="text-gray-400">|</span>
                <span className="text-green-600 font-medium">
                  正確：{correct}
                  {correctRate > 0 && <span className="text-gray-500 text-xs ml-1">({correctRate}%)</span>}
                </span>
                <span className="text-gray-400">|</span>
                <span className="text-rose-600 font-medium">
                  錯誤：{wrong}
                  {totalQuestions > 0 && (wrong / totalQuestions) * 100 > 0 && (
                    <span className="text-gray-500 text-xs ml-1">({Math.round((wrong / totalQuestions) * 100 * 10) / 10}%)</span>
                  )}
                </span>
              </div>
            )}
            
            {/* 錯誤題目列表 */}
            {wrongWords.length > 0 && (
              <div className="mb-6 text-left max-w-3xl mx-auto">
                <button
                  onClick={() => setShowWrongList(!showWrongList)}
                  className="w-full flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200 hover:bg-red-100 transition"
                >
                  <span className="font-semibold text-red-700">
                    {showWrongList ? '▼' : '▶'} 錯誤題目 ({wrongWords.length}題)
                  </span>
                </button>
                {showWrongList && (
                  <div className="mt-2 space-y-3">
                    {wrongWords.map((w, idx) => (
                      <div key={idx} className="p-4 bg-white rounded-lg border border-red-200">
                        <div className="font-semibold text-gray-800 mb-2">
                          {idx + 1}. {w.wordId && data ? (
                            <a 
                              href={`#/word/${w.wordId}`}
                              onClick={() => {
                                // 保存當前測驗路徑
                                const currentHash = window.location.hash || '#/quiz';
                                sessionStorage.setItem('quiz_return_path', JSON.stringify({
                                  path: currentHash,
                                  timestamp: Date.now()
                                }));
                              }}
                              className="text-indigo-600 hover:underline"
                            >
                              {w.word}
                            </a>
                          ) : w.word}
                          {(w.chinese_definition || w.wordDefinition) && (
                            <span className="text-gray-500 font-normal ml-2">
                              ({w.chinese_definition || w.wordDefinition})
                            </span>
                          )}
                        </div>
                        {w.question && (
                          <div className="flex items-start gap-2 mb-2">
                            <span className="shrink-0 font-medium text-gray-500">題目：</span>
                            <div className="flex-1">
                              <div className="text-gray-900 font-bold text-lg leading-relaxed">{w.question}</div>
                              {w.sentenceTranslation && (
                                <div className="text-sm text-gray-500 mt-0.5">
                                  {w.sentenceTranslation}
                                </div>
                              )}
                            </div>
                          </div>
                        )}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div className="flex items-start gap-2">
                            <span className="shrink-0 font-medium text-green-600">正確答案：</span>
                            <div className="flex flex-col flex-1">
                              <span className="text-gray-900 font-bold text-lg">{w.correctAnswer}</span>
                              {(w.chinese_definition || w.wordDefinition) && (
                                <span className="text-gray-500 text-sm">
                                  {w.chinese_definition || w.wordDefinition}
                                </span>
                              )}
                            </div>
                          </div>
                          {w.userAnswer && (
                            <div className="flex items-start gap-2">
                              <span className="shrink-0 font-medium text-rose-600">你的答案：</span>
                              <div className="flex flex-col flex-1">
                                <span className="text-gray-900 font-bold text-lg">{w.userAnswer}</span>
                                {w.userAnswerDefinition && (
                                  <span className="text-gray-500 text-sm">
                                    {w.userAnswerDefinition}
                                  </span>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
            
            {/* 學習中單字列表（僅閃卡） */}
            {learningWords.length > 0 && (
              <div className="mb-6 text-left max-w-3xl mx-auto">
                <button
                  onClick={() => setShowLearningList(!showLearningList)}
                  className="w-full flex items-center justify-between p-3 bg-orange-50 rounded-lg border border-orange-200 hover:bg-orange-100 transition"
                >
                  <span className="font-semibold text-orange-700">
                    {showLearningList ? '▼' : '▶'} 學習中單字 ({learningWords.length}題)
                  </span>
                </button>
                {showLearningList && (
                  <div className="mt-2 space-y-3">
                    {learningWords.map((w, idx) => (
                      <div key={idx} className="p-4 bg-white rounded-lg border border-orange-200">
                        <div className="font-semibold text-gray-800 mb-2">
                          {idx + 1}. {w.word}
                        </div>
                        {w.wordId && data && (
                          <div className="mt-2">
                            <a 
                              href={`#/word/${w.wordId}`}
                              onClick={() => {
                                // 保存當前測驗路徑
                                const currentHash = window.location.hash || '#/quiz';
                                sessionStorage.setItem('quiz_return_path', JSON.stringify({
                                  path: currentHash,
                                  timestamp: Date.now()
                                }));
                              }}
                              className="text-xs text-indigo-600 hover:underline"
                            >
                              查看單字詳情 →
                            </a>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
            
            {/* 操作按鈕 */}
            <div className="space-y-3">
              {wrongWords.length > 0 && (
                <div>
                  <Button
                    variant="primary"
                    onClick={handleAddWrongToFavorites}
                    disabled={addedWrong}
                    className="mb-2"
                  >
                    {addedWrong ? `已加入 ${wrongWords.length} 個單字到重點訓練 ✓` : `將錯題加入重點訓練 (${wrongWords.length}個)`}
                  </Button>
                </div>
              )}
              
              {learningWords.length > 0 && (
                <div>
                  <Button
                    variant="primary"
                    onClick={handleAddLearningToFavorites}
                    disabled={addedLearning}
                    className="mb-2"
                  >
                    {addedLearning ? `已加入 ${learningWords.length} 個單字到重點訓練 ✓` : `將學習中的單字加入重點訓練 (${learningWords.length}個)`}
                  </Button>
                </div>
              )}
              
              <div className="flex gap-3 justify-center">
                <Button variant="ghost" onClick={onRestart}>
                  重新開始測驗
                </Button>
              </div>
            </div>
          </div>
        );
      };

      // 選擇題測驗組件
      const MultipleChoiceQuiz = ({ pool, favoritesApi, quizHistoryApi, onRestart, data }) => {
        // 檢查是否應該直接顯示完成畫面
        const shouldShowCompletion = (() => {
          try {
            const completedState = JSON.parse(sessionStorage.getItem('quiz_completed_state') || 'null');
            if (completedState && completedState.type === 'multiple-choice' && completedState.timestamp && Date.now() - completedState.timestamp < 3600000) {
              return true;
            }
          } catch {}
          return false;
        })();
        
        const validPool = useMemo(() => 
          pool.filter(w => w.example_sentence && w.example_sentence.trim()), 
          [pool]
        );

        // 隨機打亂題目順序
        const shuffledPool = useMemo(() => {
          return [...validPool].sort(() => Math.random() - 0.5);
        }, [validPool]);

        // 為每道題目預先分配正確答案位置（0=A, 1=B, 2=C, 3=D），確保平均分布
        const correctAnswerPositions = useMemo(() => {
          const total = shuffledPool.length;
          if (total === 0) return [];
          
          // 計算每個位置應該有幾題
          const baseCount = Math.floor(total / 4);
          const remainder = total % 4;
          
          // 建立位置陣列：先每個位置分配 baseCount 題，剩餘的題目依序分配
          const positions = [];
          for (let i = 0; i < 4; i++) {
            const count = baseCount + (i < remainder ? 1 : 0);
            for (let j = 0; j < count; j++) {
              positions.push(i);
            }
          }
          
          // 打亂位置順序，避免固定模式
          return positions.sort(() => Math.random() - 0.5);
        }, [shuffledPool.length]);

        const [idx, setIdx] = useState(0);
        const [score, setScore] = useState(0);
        const [selectedAnswer, setSelectedAnswer] = useState(null);
        const [showResult, setShowResult] = useState(false);
        const [answers, setAnswers] = useState([]); // 記錄所有答案
        const [startTime] = useState(() => Date.now()); // 記錄開始時間
        const [isFinished, setIsFinished] = useState(shouldShowCompletion);

        const question = useMemo(() => {
          if (shuffledPool.length === 0 || idx >= shuffledPool.length) return null;
          
          const currentWord = shuffledPool[idx];
          const correctAnswer = currentWord.english_word;
          const correctPosition = correctAnswerPositions[idx];
          
          const sameTheme = shuffledPool.filter(w => 
            w.theme === currentWord.theme && 
            w.english_word !== correctAnswer
          );
          
          const distractors = [];
          const shuffled = [...sameTheme].sort(() => Math.random() - 0.5);
          for (let i = 0; i < Math.min(3, shuffled.length); i++) {
            distractors.push(shuffled[i].english_word);
          }
          
          while (distractors.length < 3 && distractors.length < shuffledPool.length - 1) {
            const random = shuffledPool[Math.floor(Math.random() * shuffledPool.length)];
            if (random.english_word !== correctAnswer && !distractors.includes(random.english_word)) {
              distractors.push(random.english_word);
            }
          }
          
          // 建立選項陣列，目標是永遠有 4 個選項
          const allDistractors = [...distractors];
          
          // 第一階段：從相同主題中補充干擾選項
          const sameThemeRemaining = sameTheme.filter(w => !allDistractors.includes(w.english_word));
          for (let i = 0; i < Math.min(3 - allDistractors.length, sameThemeRemaining.length); i++) {
            allDistractors.push(sameThemeRemaining[i].english_word);
          }
          
          // 第二階段：如果還不足 3 個，從相同詞性的全部資料中尋找
          if (allDistractors.length < 3) {
            const samePOS = data.filter(w => 
              w.part_of_speech === currentWord.part_of_speech &&
              w.english_word !== correctAnswer &&
              !allDistractors.includes(w.english_word) &&
              w.example_sentence && w.example_sentence.trim()
            );
            const shuffledSamePOS = [...samePOS].sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < Math.min(3 - allDistractors.length, shuffledSamePOS.length); i++) {
              allDistractors.push(shuffledSamePOS[i].english_word);
            }
          }
          
          // 第三階段：如果還是不足 3 個，從所有資料中尋找
          if (allDistractors.length < 3) {
            const allAvailable = data.filter(w => 
              w.english_word !== correctAnswer &&
              !allDistractors.includes(w.english_word) &&
              w.example_sentence && w.example_sentence.trim()
            );
            const shuffledAll = [...allAvailable].sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < Math.min(3 - allDistractors.length, shuffledAll.length); i++) {
              allDistractors.push(shuffledAll[i].english_word);
            }
          }
          
          // 建立最終選項陣列：永遠是 4 個選項
          // 取前 3 個干擾選項（如果不足 3 個就用現有的）
          const finalOptions = [];
          for (let i = 0; i < Math.min(3, allDistractors.length); i++) {
            finalOptions.push(allDistractors[i]);
          }
          
          // 將正確答案插入到預先分配的位置
          // 調整 correctPosition 以適應實際選項數量
          const adjustedPosition = Math.min(correctPosition, finalOptions.length);
          finalOptions.splice(adjustedPosition, 0, correctAnswer);
          
          // 使用 makeCloze 將答案從例句中挖空
          const clozedSentence = makeCloze(currentWord.example_sentence, correctAnswer);
          
          return {
            word: currentWord,
            sentence: clozedSentence,
            translation: currentWord.example_translation,
            correctAnswer,
            options: finalOptions
          };
        }, [shuffledPool, idx, correctAnswerPositions]);

        const handleSelect = (option) => {
          if (showResult) return;
          setSelectedAnswer(option);
        };

        const handleSubmit = () => {
          if (!selectedAnswer) return;
          setShowResult(true);
          const isCorrect = selectedAnswer === question.correctAnswer;
          if (isCorrect) {
            setScore(s => s + 1);
          }
          
          // 查找使用者選的錯誤答案對應的中文解釋
          let userAnswerDefinition = '';
          if (selectedAnswer && !isCorrect) {
            // 先在 data 中查找
            const foundWord = data.find(w => w.english_word && w.english_word.toLowerCase() === selectedAnswer.toLowerCase());
            if (foundWord && foundWord.chinese_definition) {
              userAnswerDefinition = foundWord.chinese_definition;
            } else {
              // 如果 data 中找不到，在 pool 中查找
              const foundInPool = pool.find(w => w.english_word && w.english_word.toLowerCase() === selectedAnswer.toLowerCase());
              if (foundInPool && foundInPool.chinese_definition) {
                userAnswerDefinition = foundInPool.chinese_definition;
              }
            }
          }
          
          // 記錄答案
          setAnswers(prev => [...prev, {
            wordId: question.word.id,
            word: question.word.english_word,
            correctAnswer: question.correctAnswer,
            userAnswer: selectedAnswer,
            isCorrect,
            question: question.sentence,
            translation: question.translation,
            wordDefinition: question.word.chinese_definition,
            sentenceTranslation: question.translation,
            userAnswerDefinition: userAnswerDefinition
          }]);
        };

        const handleNext = () => {
          if (idx < shuffledPool.length - 1) {
            setIdx(i => i + 1);
            setSelectedAnswer(null);
            setShowResult(false);
          } else {
            // 完成測驗
            const endTime = Date.now();
            const duration = Math.floor((endTime - startTime) / 1000);
            const wrongWords = answers.filter(a => !a.isCorrect);
            const correctWords = answers.filter(a => a.isCorrect);
            
            // 儲存記錄
            quizHistoryApi.add({
              type: 'multiple-choice',
              totalQuestions: shuffledPool.length,
              correct: score,
              wrong: wrongWords.length,
              learning: 0,
              wrongWords: wrongWords.map(a => ({
                wordId: a.wordId,
                word: a.word,
                correctAnswer: a.correctAnswer,
                userAnswer: a.userAnswer,
                question: a.question,
                chinese_definition: a.wordDefinition,
                sentenceTranslation: a.sentenceTranslation,
                userAnswerDefinition: a.userAnswerDefinition
              })),
              correctWords: correctWords.map(a => a.wordId),
              duration,
              mode: null
            });
            
            // 儲存完成狀態到 sessionStorage，以便從單字詳情返回時可以顯示完成畫面
            sessionStorage.setItem('quiz_completed_state', JSON.stringify({
              type: 'multiple-choice',
              timestamp: Date.now()
            }));
            
            setIsFinished(true);
          }
        };

        // 顯示完成畫面（優先檢查，避免 pool 為空時無法顯示完成畫面）
        if (isFinished) {
          // 從最新的歷史記錄中取得資料（參考閃卡的做法）
          const history = quizHistoryApi.getAll();
          const latest = history[0];
          
          if (latest && latest.type === 'multiple-choice') {
            return (
              <QuizCompletionScreen
                type="multiple-choice"
                totalQuestions={latest.totalQuestions}
                correct={latest.correct}
                wrong={latest.wrong}
                learning={0}
                wrongWords={latest.wrongWords || []}
                learningWords={[]}
                favoritesApi={favoritesApi}
                onRestart={onRestart}
                data={data}
              />
            );
          }
          
          // 如果沒有記錄，使用當前狀態（fallback）
          const wrongWords = answers.filter(a => !a.isCorrect);
          const correctCount = score;
          const wrongCount = wrongWords.length;
          const totalCount = shuffledPool.length;
          const correctRate = totalCount > 0 ? Math.round((correctCount / totalCount) * 100 * 10) / 10 : 0;
          const duration = Math.floor((Date.now() - startTime) / 1000);
          const minutes = Math.floor(duration / 60);
          const seconds = duration % 60;
          
          return (
            <QuizCompletionScreen
              type="multiple-choice"
              totalQuestions={totalCount}
              correct={correctCount}
              wrong={wrongCount}
              learning={0}
              wrongWords={wrongWords}
              learningWords={[]}
              favoritesApi={favoritesApi}
              onRestart={onRestart}
              data={data}
            />
          );
        }

        // 檢查是否有可用的題目（在完成畫面檢查之後）
        if (shuffledPool.length === 0) {
          return (
            <div className="text-center py-8 bg-gray-50 rounded-2xl">
              <p className="text-gray-600">沒有可用的題目（需要有例句的單字）</p>
            </div>
          );
        }

        if (!question) return null;

        return (
          <div>
            <div className="mb-4 flex items-center justify-between">
              <div className="text-sm text-gray-600">
                第 {idx + 1} 題 / {shuffledPool.length} 題
              </div>
              <div className="text-lg font-semibold text-indigo-600">
                得分：{score} / {idx + (showResult ? 1 : 0)}
              </div>
            </div>

            <div className="rounded-2xl border border-indigo-200 bg-white p-6 shadow-sm">
              {/* 刪除「人工審核例句」標示 */}
              
              {/* 提示文字移到例句上方 */}
              <p className="text-sm font-medium text-gray-700 mb-3">
                請選出句中最適合的單字：
              </p>
              
              {/* 顯示挖空的句子 */}
              <p className="text-lg mb-6 leading-relaxed">
                {question.sentence}
              </p>

              {/* 答題前不顯示中文翻譯 */}
              {showResult && question.translation && (
                <p className="text-sm text-gray-500 mb-6 italic">
                  {question.translation}
                </p>
              )}

              <div className="mb-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  {question.options.map((option, i) => {
                    const isSelected = selectedAnswer === option;
                    const isCorrect = option === question.correctAnswer;
                    const showCorrect = showResult && isCorrect;
                    const showWrong = showResult && isSelected && !isCorrect;
                    
                    let bgColor = 'bg-white border-gray-300';
                    if (showCorrect) bgColor = 'bg-green-100 border-green-500';
                    else if (showWrong) bgColor = 'bg-red-100 border-red-500';
                    else if (isSelected) bgColor = 'bg-indigo-50 border-indigo-500';

                    return (
                      <button
                        key={i}
                        onClick={() => handleSelect(option)}
                        disabled={showResult}
                        className={`${bgColor} border-2 rounded-xl p-4 text-left transition hover:shadow-md disabled:cursor-not-allowed`}
                      >
                        <span className="font-medium">{String.fromCharCode(65 + i)}.</span> {option}
                        {showCorrect && <span className="ml-2">✓</span>}
                        {showWrong && <span className="ml-2">✗</span>}
                      </button>
                    );
                  })}
                </div>
              </div>

              {showResult && (
                <div className={`p-4 rounded-xl mb-4 ${
                  selectedAnswer === question.correctAnswer 
                    ? 'bg-green-50 border border-green-200' 
                    : 'bg-red-50 border border-red-200'
                }`}>
                  <p className="font-medium mb-2">
                    {selectedAnswer === question.correctAnswer ? '✓ 答對了！' : '✗ 答錯了'}
                  </p>
                  <p className="text-sm">
                    正確答案：<span className="font-semibold">{question.correctAnswer}</span>
                  </p>
                  {question.word.chinese_definition && (
                    <p className="text-sm text-gray-600">
                      中文：{question.word.chinese_definition}
                    </p>
                  )}
                </div>
              )}

              <div className="flex gap-3">
                {!showResult ? (
                  <Button onClick={handleSubmit} disabled={!selectedAnswer}>
                    提交答案
                  </Button>
                ) : (
                  <>
                    <Button onClick={handleNext}>
                      下一題
                    </Button>
                    {/* 答題後才顯示發音按鈕 */}
                    <button
                      onClick={() => speak(question.correctAnswer)}
                      className="px-4 py-2 rounded-xl border border-gray-300 hover:bg-gray-50 transition"
                      title="發音"
                    >
                      聽發音
                    </button>
                  </>
                )}
              </div>
            </div>
          </div>
        );
      };

      // 閃卡組件
      const FlashcardQuiz = ({ pool, favoritesApi, quizHistoryApi, onRestart, data }) => {
        // 檢查是否應該直接顯示完成畫面
        const shouldShowCompletion = (() => {
          try {
            const completedState = JSON.parse(sessionStorage.getItem('quiz_completed_state') || 'null');
            if (completedState && completedState.type === 'flashcard' && completedState.timestamp && Date.now() - completedState.timestamp < 3600000) {
              return true;
            }
          } catch {}
          return false;
        })();
        
        // 使用 useMemo 確保 pool 改變時重新洗牌
        const shuffledPool = useMemo(() => {
          if (!pool || pool.length === 0) return [];
          const shuffled = [...pool];
          for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
          }
          console.log('閃卡初始化完成，共', shuffled.length, '張');
          return shuffled;
        }, [pool]);

        const [idx, setIdx] = useState(0);
        const [mode, setMode] = useState('en-to-zh');
        const [flipped, setFlipped] = useState(false);
        const [known, setKnown] = useState(0);
        const [learning, setLearning] = useState(0);
        const [answers, setAnswers] = useState([]);
        const [startTime] = useState(() => Date.now());
        const [isFinished, setIsFinished] = useState(shouldShowCompletion);

        // 檢查是否已完成所有閃卡
        const isFinishedCheck = idx >= shuffledPool.length || isFinished;

        const currentCard = isFinishedCheck ? null : shuffledPool[idx];

        const handleFlip = () => {
          if (!isFinishedCheck) {
            console.log('翻卡');
            setFlipped(f => !f);
          }
        };

        const handleNext = (isKnown) => {
          console.log('handleNext 被調用', { idx, shuffledPoolLength: shuffledPool.length, isKnown });
          const currentWord = shuffledPool[idx];
          if (!currentWord) {
            console.error('currentWord 為空', { idx, shuffledPoolLength: shuffledPool.length });
            return;
          }
          const status = isKnown ? 'correct' : 'learning'; // 「還不熟」視為「學習中」
          
          // 記錄答案
          const currentAnswer = {
            wordId: currentWord.id,
            word: currentWord.english_word,
            status,
            isCorrect: isKnown
          };
          
          setAnswers(prev => [...prev, currentAnswer]);
          
          // 先更新計數
          const newKnown = isKnown ? known + 1 : known;
          const newLearning = isKnown ? learning : learning + 1;
          
          if (idx < shuffledPool.length - 1) {
            const nextIdx = idx + 1;
            console.log('切換到下一張', { currentIdx: idx, nextIdx, shuffledPoolLength: shuffledPool.length });
            // 使用函數式更新確保使用最新的 idx
            setIdx(prevIdx => {
              const newIdx = prevIdx + 1;
              console.log('setIdx 被調用', { prevIdx, newIdx });
              return newIdx;
            });
            setFlipped(false);
            // 更新計數狀態
            setKnown(newKnown);
            setLearning(newLearning);
          } else {
            // 完成測驗 - 最後一張卡的答案已經記錄了
            const endTime = Date.now();
            const duration = Math.floor((endTime - startTime) / 1000);
            const allAnswers = [...answers, currentAnswer]; // 包含最後一張卡的答案
            const wrongWords = []; // 閃卡沒有「錯誤」，只有「學習中」
            const learningWords = allAnswers.filter(a => a.status === 'learning');
            const correctWords = allAnswers.filter(a => a.isCorrect);
            
            // 更新計數狀態
            setKnown(newKnown);
            setLearning(newLearning);
            
            // 儲存記錄
            quizHistoryApi.add({
              type: 'flashcard',
              totalQuestions: shuffledPool.length,
              correct: newKnown,
              wrong: 0,
              learning: newLearning,
              wrongWords: [],
              learningWords: learningWords.map(a => ({
                wordId: a.wordId,
                word: a.word
              })),
              correctWords: correctWords.map(a => a.wordId),
              duration,
              mode
            });
            
            // 儲存完成狀態到 sessionStorage，以便從單字詳情返回時可以顯示完成畫面
            sessionStorage.setItem('quiz_completed_state', JSON.stringify({
              type: 'flashcard',
              timestamp: Date.now()
            }));
            
            setIsFinished(true);
          }
        };

        const toggleMode = () => {
          if (!isFinished) {
            setMode(m => m === 'en-to-zh' ? 'zh-to-en' : 'en-to-zh');
            setFlipped(false);
          }
        };

        if (shuffledPool.length === 0) {
          return (
            <div className="text-center py-8 bg-gray-50 rounded-2xl">
              <p className="text-gray-600">沒有可用的閃卡</p>
            </div>
          );
        }

        // 顯示完成畫面
        if (isFinished) {
          // 從最新的歷史記錄中取得資料
          const history = quizHistoryApi.getAll();
          const latest = history[0];
          
          if (latest && latest.type === 'flashcard') {
            return (
              <QuizCompletionScreen
                type="flashcard"
                totalQuestions={latest.totalQuestions}
                correct={latest.correct}
                wrong={0}
                learning={latest.learning}
                wrongWords={[]}
                learningWords={latest.learningWords || []}
                favoritesApi={favoritesApi}
                onRestart={onRestart}
                data={data}
              />
            );
          }
          
          // 如果沒有記錄，使用當前狀態
          const allAnswers = answers;
          const learningWords = allAnswers.filter(a => a.status === 'learning');
          const correctCount = known;
          const learningCount = learning;
          const totalCount = shuffledPool.length;
          
          return (
            <QuizCompletionScreen
              type="flashcard"
              totalQuestions={totalCount}
              correct={correctCount}
              wrong={0}
              learning={learningCount}
              wrongWords={[]}
              learningWords={learningWords}
              favoritesApi={favoritesApi}
              onRestart={onRestart}
              data={data}
            />
          );
        }

        const frontText = mode === 'en-to-zh' 
          ? currentCard.english_word 
          : currentCard.chinese_definition || '(無中文翻譯)';
        
        const backText = mode === 'en-to-zh' 
          ? currentCard.chinese_definition || '(無中文翻譯)'
          : currentCard.english_word;

        return (
          <div>
            <div className="mb-4 flex items-center justify-between flex-wrap gap-2">
              <div className="text-sm text-gray-600">
                第 {idx + 1} 張 / {shuffledPool.length} 張
                <span className="text-xs text-gray-400 ml-2">
                  (idx: {idx}, pool: {pool.length}, shuffled: {shuffledPool.length}, flipped: {flipped ? 'true' : 'false'})
                </span>
              </div>
              <div className="flex gap-4 text-sm">
                <span className="text-green-600">✓ 熟悉：{known}</span>
                <span className="text-orange-600">學習中：{learning}</span>
              </div>
              <Button variant="ghost" onClick={toggleMode} className="text-sm">
                {mode === 'en-to-zh' ? '英→中' : '中→英'} (切換)
              </Button>
            </div>

            <div 
              className={`flashcard ${flipped ? 'flipped' : ''} cursor-pointer`}
              onClick={handleFlip}
            >
              <div className="flashcard-inner h-[300px] md:h-[320px]">
                <div className="flashcard-front">
                  <div className="rounded-2xl border-2 border-indigo-300 bg-gradient-to-br from-indigo-50 to-white p-8 shadow-lg h-full flex flex-col items-center justify-center">
                    <div className="text-xs text-gray-500 mb-4">點擊卡片翻面</div>
                    <div className="flex items-center justify-center gap-2 mb-4">
                      <div className="text-3xl md:text-4xl font-bold text-center">
                        {frontText}
                      </div>
                      {mode === 'en-to-zh' && (
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            speak(frontText);
                          }}
                          className="flex-shrink-0 h-6 w-6 rounded-full border border-indigo-300 bg-white text-indigo-600 hover:bg-indigo-50 transition flex items-center justify-center"
                          title="播放發音"
                        >
                          <svg viewBox="0 0 24 24" fill="currentColor" className="h-3 w-3">
                            <path d="M4 9.25v5.5c0 .69.56 1.25 1.25 1.25H7l3.29 2.63c.83.66 2.04.07 2.04-1V6.62c0-1.07-1.21-1.66-2.04-1L7 8.25H5.25C4.56 8.25 4 8.81 4 9.25Zm11.21-2.46a.75.75 0 0 0-.97 1.14 4.5 4.5 0 0 1 0 7.14.75.75 0 0 0 .97 1.14 6 6 0 0 0 0-9.42Zm2.79-1.95a.75.75 0 0 0-.97 1.13 7.5 7.5 0 0 1 0 11.56.75.75 0 0 0 .97 1.13 9 9 0 0 0 0-13.82Z" />
                          </svg>
                        </button>
                      )}
                    </div>
                  </div>
                </div>

                <div className="flashcard-back">
                  <div className="rounded-2xl border-4 border-indigo-600 bg-white p-6 pt-8 shadow-xl h-full w-full flex flex-col justify-start items-start text-left relative">
                    {/* 發音按鈕 - 絕對定位在右上角 */}
                    {(mode === 'en-to-zh' || mode === 'zh-to-en') && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          speak(currentCard.english_word);
                        }}
                        className="absolute top-5 right-5 w-10 h-10 rounded-full bg-gray-50 text-indigo-600 hover:bg-indigo-50 flex items-center justify-center transition"
                        title="播放發音"
                      >
                        <svg viewBox="0 0 24 24" fill="currentColor" className="h-5 w-5">
                          <path d="M4 9.25v5.5c0 .69.56 1.25 1.25 1.25H7l3.29 2.63c.83.66 2.04.07 2.04-1V6.62c0-1.07-1.21-1.66-2.04-1L7 8.25H5.25C4.56 8.25 4 8.81 4 9.25Zm11.21-2.46a.75.75 0 0 0-.97 1.14 4.5 4.5 0 0 1 0 7.14.75.75 0 0 0 .97 1.14 6 6 0 0 0 0-9.42Zm2.79-1.95a.75.75 0 0 0-.97 1.13 7.5 7.5 0 0 1 0 11.56.75.75 0 0 0 .97 1.13 9 9 0 0 0 0-13.82Z" />
                        </svg>
                      </button>
                    )}
                    
                    {/* 單字標題區 */}
                    <div className="w-full">
                      <div className="text-3xl font-extrabold text-gray-900 tracking-tight leading-none">
                        {currentCard.english_word}
                      </div>
                      <div className="text-base text-gray-500 font-medium mt-2">
                        {currentCard.chinese_definition || '(無中文翻譯)'}
                      </div>
                    </div>
                    
                    {/* 例句顯示區 - Magazine Style */}
                    {currentCard.example_sentence && (
                      <div className="w-full mt-6 pl-4 border-l-4 border-indigo-400">
                        <div className="text-xl font-bold text-gray-800 leading-snug">
                          {currentCard.example_sentence}
                        </div>
                        {currentCard.example_translation && (
                          <div className="text-sm text-gray-400 mt-2">
                            {currentCard.example_translation}
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {flipped && (
              <div className="-mt-16 flex justify-center gap-4 relative z-10">
                <Button 
                  variant="danger" 
                  onClick={(e) => {
                    e.stopPropagation();
                    console.log('按鈕被點擊：還不熟', { idx, isFinished, shuffledPoolLength: shuffledPool.length });
                    handleNext(false);
                  }} 
                  disabled={isFinished}
                >
                  還不熟
                </Button>
                <Button 
                  variant="success" 
                  onClick={(e) => {
                    e.stopPropagation();
                    console.log('按鈕被點擊：我記得了', { idx, isFinished, shuffledPoolLength: shuffledPool.length });
                    handleNext(true);
                  }} 
                  disabled={isFinished}
                >
                  我記得了 ✓
                </Button>
              </div>
            )}
          </div>
        );
      };

      const QuizPage = ({ favoritesApi, hash, data, push }) => {
        const quizHistoryApi = useQuizHistory();
        const params = useMemo(() => Object.fromEntries(new URLSearchParams((hash.split('?')[1]||''))), [hash]);
        const source = params.source || 'all';
        const quizType = params.type || 'multiple-choice';
        const restartKey = `${quizType}-${params._restart || '0'}`; // 用於強制重新渲染的 key，包含 type 確保切換時重新掛載
        const wordsParam = useMemo(() => {
          const raw = params.words || '';
          if (!raw) return null;
          const ids = raw.split(',').map(s => s.trim()).filter(Boolean);
          return ids.length ? new Set(ids) : null;
        }, [params.words]);
        
        // 讀取首頁的篩選條件
        const homeFilters = useMemo(() => {
          try {
            return JSON.parse(localStorage.getItem(LS.homeFilters) || '{}');
          } catch {
            return {};
          }
        }, []);

        const [currentSource, setCurrentSource] = useState(source);
        const [currentType, setCurrentType] = useState(quizType);

        // 當 URL 參數改變時，同步更新本地狀態
        useEffect(() => {
          setCurrentSource(source);
          setCurrentType(quizType);
        }, [source, quizType]);

        const pool = useMemo(() => {
          let filteredData = data;

          // 若從首頁傳入 words 參數，直接使用該範圍，不再套用其他條件（除非是 favorites）
          if (wordsParam && wordsParam.size > 0) {
            filteredData = data.filter((w) => wordsParam.has(String(w.id)));
          }

          // 如果選擇「重點訓練」，只使用收藏的單字（不應用其他篩選）
          if (currentSource === 'favorites') {
            const ids = new Set(favoritesApi.favorites);
            filteredData = data.filter((w) => ids.has(w.id));
            // 重點訓練不應用首頁的篩選條件，繼續執行後續的測驗類型過濾
          } else if (!wordsParam) {
            // 只有在非「重點訓練」時才應用首頁的篩選條件
            
            // 應用首頁的主題篩選
            if (homeFilters.theme && homeFilters.theme !== 'all') {
              filteredData = filteredData.filter((w) => {
                if (wordHasTheme(w, homeFilters.theme)) return true;
                if (homeFilters.theme === 'highschool_climate') {
                  const wordThemes = getWordThemes(w);
                  return wordThemes.includes('氣候') || wordThemes.includes('climate');
                }
                return false;
              });
            }

            // 應用首頁的詞性篩選
            if (homeFilters.pos && homeFilters.pos !== 'all') {
              filteredData = filteredData.filter(w => (w.posTags||[]).includes(homeFilters.pos));
            }

            // 應用首頁的 Level 篩選
            if (homeFilters.levels && homeFilters.levels.length > 0) {
              filteredData = filteredData.filter(w => 
                homeFilters.levels.includes(String(w.level||'').trim())
              );
            }

            // 應用首頁的搜尋條件
            if (homeFilters.q && homeFilters.q.trim()) {
              const searchTerm = homeFilters.q.trim().toLowerCase();
              filteredData = filteredData.filter(w => 
                w.english_word.toLowerCase().includes(searchTerm)
              );
            }
          }

          // 如果是閃卡模式，過濾掉沒有中文翻譯的單字
          if (currentType === 'flashcard') {
            const beforeFilter = filteredData.length;
            filteredData = filteredData.filter(w => {
              const hasChinese = w.chinese_definition && w.chinese_definition.trim();
              return hasChinese;
            });
            // 調試：如果過濾後數量大幅減少，記錄一下
            if (beforeFilter > 0 && filteredData.length === 0) {
              console.warn('閃卡模式：過濾後沒有可用單字', {
                beforeFilter,
                currentSource,
                sample: filteredData.slice(0, 3).map(w => ({
                  word: w.english_word,
                  hasChinese: !!(w.chinese_definition && w.chinese_definition.trim())
                }))
              });
            }
          }

          // 如果是選擇題模式，過濾掉沒有例句的單字
          if (currentType === 'multiple-choice') {
            filteredData = filteredData.filter(w => 
              w.example_sentence && w.example_sentence.trim()
            );
          }

          // 調試：記錄 pool 計算結果
          console.log('Pool 計算完成', {
            currentSource,
            currentType,
            poolLength: filteredData.length,
            hasHomeFilters: Object.keys(homeFilters).length > 0,
            homeFilters
          });
          
          return filteredData;
        }, [currentSource, currentType, favoritesApi.favorites, data, homeFilters]);

        // 顯示目前的篩選狀態
        const filterStatus = useMemo(() => {
          // 如果是重點訓練，直接顯示
          if (currentSource === 'favorites') {
            return '重點訓練';
          }
          
          // 其他情況顯示首頁的篩選條件
          const filters = [];
          if (homeFilters.theme && homeFilters.theme !== 'all') {
            filters.push(THEME_LABEL[homeFilters.theme] || homeFilters.theme);
          }
          if (homeFilters.pos && homeFilters.pos !== 'all') {
            filters.push(POS_LABEL[homeFilters.pos] || homeFilters.pos);
          }
          if (homeFilters.levels && homeFilters.levels.length > 0) {
            filters.push(`Level ${homeFilters.levels.join(', ')}`);
          }
          if (homeFilters.q && homeFilters.q.trim()) {
            filters.push(`搜尋: ${homeFilters.q}`);
          }
          return filters.length > 0 ? filters.join(' / ') : '全部單字';
        }, [currentSource, homeFilters]);

        return (
          <div className="max-w-4xl mx-auto">
            <div className="mb-6">
              <h1 className="text-2xl font-bold">
                實力驗收
              </h1>
              
              <p className="text-gray-600 mt-3 mb-4">
                {pool.length > 0
                  ? `你已選擇練習 ${pool.length} 題` 
                  : '在開始測驗前，請先到首頁選擇測驗範圍'}
              </p>
              
              <div className="mb-4">
                <div className="flex gap-2">
                  <a 
                    href={`#/quiz?source=${currentSource}&type=multiple-choice`} 
                    className="flex-1"
                  >
                    <Button 
                      variant={currentType === 'multiple-choice' ? 'primary' : 'ghost'}
                      className="w-full"
                      onClick={() => setCurrentType('multiple-choice')}
                    >
                      選擇題
                    </Button>
                  </a>
                  <a 
                    href={`#/quiz?source=${currentSource}&type=flashcard`} 
                    className="flex-1"
                  >
                    <Button 
                      variant={currentType === 'flashcard' ? 'primary' : 'ghost'}
                      className="w-full"
                      onClick={() => setCurrentType('flashcard')}
                    >
                      閃卡
                    </Button>
                  </a>
                  <a href="#/quiz-history">
                    <Button variant="ghost">
                      查看歷史記錄
                    </Button>
                  </a>
                </div>
              </div>
            </div>

            {(() => {
              const handleRestart = () => {
                // 清除完成狀態
                sessionStorage.removeItem('quiz_completed_state');
                sessionStorage.removeItem('quiz_return_path');
                
                // 保持當前的測驗範圍，添加時間戳參數以強制重新渲染
                const timestamp = Date.now();
                push(`#/quiz?source=${currentSource}&type=${currentType}&_restart=${timestamp}`);
              };
              
              return currentType === 'flashcard' ? (
                <FlashcardQuiz 
                  key={`flashcard-${restartKey}`}
                  pool={pool} 
                  favoritesApi={favoritesApi}
                  quizHistoryApi={quizHistoryApi}
                  onRestart={handleRestart}
                  data={data}
                />
              ) : (
                <MultipleChoiceQuiz 
                  key={`multiple-choice-${restartKey}`}
                  pool={pool}
                  favoritesApi={favoritesApi}
                  quizHistoryApi={quizHistoryApi}
                  onRestart={handleRestart}
                  data={data}
                />
              );
            })()}
          </div>
        );
      };

      // 歷史記錄頁面
      const QuizHistoryPage = ({ quizHistoryApi, push, data }) => {
        const [expandedId, setExpandedId] = useState(null);
        const history = quizHistoryApi.getAll();
        
        const formatDate = (dateString) => {
          try {
            const date = new Date(dateString);
            return date.toLocaleString('zh-TW', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            });
          } catch {
            return dateString;
          }
        };
        
        const formatDuration = (seconds) => {
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          if (mins > 0) {
            return `${mins}分${secs}秒`;
          }
          return `${secs}秒`;
        };
        
        const handleDelete = (id) => {
          if (confirm('確定要刪除這筆記錄嗎？')) {
            quizHistoryApi.remove(id);
          }
        };
        
        const handleClearAll = () => {
          if (confirm('確定要清除所有記錄嗎？此操作無法復原。')) {
            quizHistoryApi.clearAll();
          }
        };
        
        if (history.length === 0) {
          return (
            <div className="max-w-4xl mx-auto">
              <div className="mb-6">
                <Button variant="ghost" onClick={() => push('#/quiz')}>
                  ← 返回實力驗收
                </Button>
                <h1 className="text-2xl font-bold mt-4">測驗歷史記錄</h1>
              </div>
              <div className="text-center py-12 bg-gray-50 rounded-2xl">
                <p className="text-gray-600 mb-4">你目前沒有歷史紀錄</p>
                <Button variant="ghost" onClick={() => push('#/quiz')}>
                  返回實力驗收
                </Button>
              </div>
            </div>
          );
        }
        
        return (
          <div className="max-w-4xl mx-auto">
            <div className="mb-6">
              <Button variant="ghost" onClick={() => push('#/quiz')}>
                ← 返回實力驗收
              </Button>
              <div className="flex items-center justify-between mt-4">
                <h1 className="text-2xl font-bold">測驗歷史記錄</h1>
                <Button variant="danger" onClick={handleClearAll}>
                  清除所有記錄
                </Button>
              </div>
            </div>
            
            <div className="space-y-4">
              {history.map((record) => {
                const isExpanded = expandedId === record.id;
                const correctRate = record.totalQuestions > 0 
                  ? Math.round((record.correct / record.totalQuestions) * 100 * 10) / 10 
                  : 0;
                const typeLabel = record.type === 'flashcard' ? '閃卡測驗' : '選擇題測驗';
                
                return (
                  <div key={record.id} className="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex-1">
                        <div className="font-semibold text-gray-800 mb-1">
                          {formatDate(record.date)}
                        </div>
                        <div className="text-sm text-gray-600">
                          {typeLabel} | {record.correct}/{record.totalQuestions} 正確 ({correctRate}%)
                          {record.learning > 0 && ` | 學習中：${record.learning} 題`}
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <Button 
                          variant="ghost" 
                          onClick={() => setExpandedId(isExpanded ? null : record.id)}
                        >
                          {isExpanded ? '收起詳情' : '查看詳情'}
                        </Button>
                        <Button variant="danger" onClick={() => handleDelete(record.id)}>
                          刪除
                        </Button>
                      </div>
                    </div>
                    
                    {isExpanded && (
                      <div className="mt-4 pt-4 border-t border-gray-200 space-y-4">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                          <div>
                            <div className="text-gray-500">總題數</div>
                            <div className="font-semibold">{record.totalQuestions} 題</div>
                          </div>
                          <div>
                            <div className="text-gray-500">正確</div>
                            <div className="font-semibold text-green-600">{record.correct} 題</div>
                          </div>
                          <div>
                            <div className="text-gray-500">錯誤</div>
                            <div className="font-semibold text-red-600">{record.wrong} 題</div>
                          </div>
                          {record.learning > 0 && (
                            <div>
                              <div className="text-gray-500">學習中</div>
                              <div className="font-semibold text-orange-600">{record.learning} 題</div>
                            </div>
                          )}
                        </div>
                        
                        {record.duration && (
                          <div className="text-sm text-gray-600">
                            測驗時間：{formatDuration(record.duration)}
                          </div>
                        )}
                        
                        {record.wrongWords && record.wrongWords.length > 0 && (
                          <div>
                            <div className="font-semibold text-red-700 mb-2">錯誤題目：</div>
                            <div className="space-y-2">
                              {record.wrongWords.map((w, idx) => (
                                <div key={idx} className="p-3 bg-red-50 rounded-lg border border-red-200">
                                  <div className="flex items-start justify-between">
                                    <div className="flex-1">
                                      <div className="font-semibold text-gray-800">{w.word}</div>
                                      {w.question && (
                                        <div className="text-sm text-gray-600 mt-1">題目：{w.question}</div>
                                      )}
                                      {w.correctAnswer && (
                                        <div className="text-sm mt-1">
                                          <span className="text-gray-500">正確答案：</span>
                                          <span className="text-green-600 font-semibold ml-1">{w.correctAnswer}</span>
                                        </div>
                                      )}
                                      {w.userAnswer && (
                                        <div className="text-sm mt-1">
                                          <span className="text-gray-500">你的答案：</span>
                                          <span className="text-red-600 font-semibold ml-1">{w.userAnswer}</span>
                                        </div>
                                      )}
                                    </div>
                                    {w.wordId && (
                                      <a
                                        href={`#/word/${w.wordId}`}
                                        className="ml-3 px-3 py-1 bg-white text-indigo-600 border border-indigo-200 rounded-lg hover:bg-indigo-50 transition text-sm whitespace-nowrap"
                                      >
                                        查看
                                      </a>
                                    )}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                        
                        {record.learningWords && record.learningWords.length > 0 && (
                          <div>
                            <div className="font-semibold text-orange-700 mb-2">學習中單字：</div>
                            <div className="space-y-2">
                              {record.learningWords.map((w, idx) => (
                                <div key={idx} className="p-3 bg-orange-50 rounded-lg border border-orange-200">
                                  <div className="flex items-center justify-between">
                                    <div className="font-semibold text-gray-800">{w.word}</div>
                                    {w.wordId && (
                                      <a
                                        href={`#/word/${w.wordId}`}
                                        className="px-3 py-1 bg-white text-indigo-600 border border-indigo-200 rounded-lg hover:bg-indigo-50 transition text-sm"
                                      >
                                        查看
                                      </a>
                                    )}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        );
      };

      function App(){
        const { hash, push } = useHashRoute();
        const favoritesApi = useFavorites();
        const userExamplesApi = useUserExamples();
        const { data, addItems, reset } = useDataset();
        
        // 全域狀態管理
        const userSettingsApi = useUserSettings();
        const { currentTab, setCurrentTab } = useCurrentTab();
        const filtersApi = useFilters();
        const { quickFilterPos, setQuickFilterPos } = useQuickFilterPos();
        
        // 自動為 conservation 補上影片連結（測試用）
        useEffect(() => {
          const conservation = data.find(w => w.english_word === 'conservation');
          if (conservation && !conservation.videoUrl) {
            conservation.videoUrl = 'https://www.youtube.com/watch?v=C8iYen-4V2A';
            console.log('已自動為 conservation 補上影片連結');
          }
        }, [data]);
        
        const [route, param] = useMemo(() => {
          const h=hash.replace(/^#\//, "");
          if(!h) return ["home", null];
          const [p0,p1]=h.split("?")[0].split("/");
          if(p0==="") return ["home", null];
          if(p0==="category") return ["category", p1];
          if(p0==="word") return ["word", p1];
          if(p0==="favorites") return ["favorites", null];
          if(p0==="quiz-history") return ["quiz-history", null];
          if(p0==="quiz") return ["quiz", null];
          return ["home", null];
        }, [hash]);
        const [navHistory, setNavHistory] = useState(() => ({ current: { route, param }, previous: null }));
        useEffect(() => {
          setNavHistory(prev => {
            if (prev.current.route === route && prev.current.param === param) return prev;
            return { current: { route, param }, previous: prev.current };
          });
        }, [route, param]);
        const quizHistoryApi = useQuizHistory();
        
        // 顯示歡迎頁的條件
        const showWelcome = !userSettingsApi.userSettings;
        
        return (
          <Shell 
            onReset={reset} 
            route={route}
            userSettings={userSettingsApi.userSettings}
            onUserSettingsChange={userSettingsApi.setUserSettings}
          >
            {showWelcome && (
              <WelcomeModal 
                data={data}
                userSettings={userSettingsApi.userSettings}
                setUserSettings={userSettingsApi.setUserSettings}
              />
            )}
            {route === "home" && (
              <Home 
                push={push} 
                data={data} 
                onImport={addItems}
                userSettings={userSettingsApi.userSettings}
                currentTab={currentTab}
                setCurrentTab={setCurrentTab}
                filters={filtersApi.filters}
                updateFilter={filtersApi.updateFilter}
                quickFilterPos={quickFilterPos}
                setQuickFilterPos={setQuickFilterPos}
              />
            )}
            {route === "category" && <CategoryList cat={param} data={data} />}
            {route === "word" && <WordDetail id={param} data={data} favoritesApi={favoritesApi} userExamplesApi={userExamplesApi} push={push} prevRoute={navHistory.previous} userSettings={userSettingsApi.userSettings} />}
            {route === "favorites" && <FavoritesPage favoritesApi={favoritesApi} data={data} />}
            {route === "quiz-history" && <QuizHistoryPage quizHistoryApi={quizHistoryApi} push={push} data={data} />}
            {route === "quiz" && <QuizPage favoritesApi={favoritesApi} hash={hash} data={data} push={push} />}
          </Shell>
        );
      }

      const rootEl = document.getElementById('root');
      if (rootEl) {
        ReactDOM.createRoot(rootEl).render(<App />);
      }
    </script>
  </body>
</html>

